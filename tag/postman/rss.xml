<?xml version="1.0" encoding="UTF-8" ?>

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
   
      <title>marcin-chwedczuk.github.io/</title>
   
   <link>http://localhost:4000</link>
   <description>A place where I share my thoughts about programming.</description>
   <language>en-uk</language>
   <managingEditor> </managingEditor>
   <atom:link href="rss" rel="self" type="application/rss+xml" />
   
	<item>
	  <title>Automatically generate new OAuth 2.0 access tokens when using Postman</title>
	  <link>//automatically-generate-new-oauth2-tokens-when-using-postman</link>
	  <author></author>
	  <pubDate>2018-09-29T02:00:00+02:00</pubDate>
	  <guid>//automatically-generate-new-oauth2-tokens-when-using-postman</guid>
	  <description><![CDATA[
	     <p>Did you ever try to use <a href="https://www.getpostman.com/">Postman</a>
with OAuth 2.0 protected API? 
It is pretty annoying. 
First you must select the correct authorization type, 
then you must open a popup to request a new access token,
and only then you can send your HTTP request.
And of course when the token expires or when for some reason you need a
new one (e.g. because you want to switching from development to staging environment),
you need to go through the process again.
Fortunately for us this can be automated using Postman pre-request scripts.</p>

<p>To test that my pre-request script works I used publicly available 
<a href="http://identityserver.io/">IdentityServer</a>
<a href="https://demo.identityserver.io/">demo instance</a>.
We may use it to manually generate a new access token and
to preform a test API call:
<img src="assets/images/2018-09-29/Postman_1.png" alt="Manually generating token 1" />
<img src="assets/images/2018-09-29/Postman_2.png" alt="Manually generating token 2" />
<img src="assets/images/2018-09-29/Postman_3.png" alt="Performing test API call" /></p>

<p>OK, so how will we automate this stuff? Let’s start by creating a new
collection that will contain all requests for which we want to automatically
generate OAuth access tokens:
<img src="assets/images/2018-09-29/Postman_4.png" alt="Create a new collection" />
On Authorization tab use {{accessToken}}
 as a value of the Access Token
field, this way Postman will try to load the token value from a variable:
<img src="assets/images/2018-09-29/Postman_6.png" alt="Set Access Token field" />
We will populate this variable using the following pre-request script:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Adapted from: https://gist.github.com/harryi3t/dd5c61451206047db70710ff6174c3c1</span>

<span class="kd">let</span> <span class="nx">tokenUrl</span> <span class="o">=</span> <span class="s1">'https://demo.identityserver.io/connect/token'</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">clientId</span> <span class="o">=</span> <span class="s1">'client'</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">clientSecret</span> <span class="o">=</span> <span class="s1">'secret'</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">scope</span> <span class="o">=</span> <span class="s1">'api'</span>

<span class="kd">let</span> <span class="nx">getTokenRequest</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
    <span class="na">url</span><span class="p">:</span> <span class="nx">tokenUrl</span><span class="p">,</span>
    <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="s2">"basic"</span><span class="p">,</span>
        <span class="na">basic</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="na">key</span><span class="p">:</span> <span class="s2">"username"</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="nx">clientId</span> <span class="p">},</span>
            <span class="p">{</span> <span class="na">key</span><span class="p">:</span> <span class="s2">"password"</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="nx">clientSecret</span> <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">mode</span><span class="p">:</span> <span class="s1">'formdata'</span><span class="p">,</span>
        <span class="na">formdata</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="na">key</span><span class="p">:</span> <span class="s1">'grant_type'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'client_credentials'</span> <span class="p">},</span>
            <span class="p">{</span> <span class="na">key</span><span class="p">:</span> <span class="s1">'scope'</span><span class="p">,</span> <span class="na">value</span><span class="p">:</span> <span class="nx">scope</span> <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="nx">pm</span><span class="p">.</span><span class="nx">sendRequest</span><span class="p">(</span><span class="nx">getTokenRequest</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">jsonResponse</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">(),</span>
        <span class="nx">newAccessToken</span> <span class="o">=</span> <span class="nx">jsonResponse</span><span class="p">.</span><span class="nx">access_token</span><span class="p">;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">({</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">jsonResponse</span><span class="p">,</span> <span class="nx">newAccessToken</span> <span class="p">})</span>

    <span class="nx">pm</span><span class="p">.</span><span class="nx">environment</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s1">'accessToken'</span><span class="p">,</span> <span class="nx">newAccessToken</span><span class="p">);</span>
    <span class="nx">pm</span><span class="p">.</span><span class="nx">variables</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s1">'accessToken'</span><span class="p">,</span> <span class="nx">newAccessToken</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p>Which should be set on Pre-request Scripts tab:
<img src="assets/images/2018-09-29/Postman_5.png" alt="Set pre-request script" />
Let’s save all changes.</p>

<p>Now we must add a new request to our collection:
<img src="assets/images/2018-09-29/Postman_7.png" alt="Add a new request" />
<strong>This is very important.</strong> Without this step our
pre-request script will not be called:
<img src="assets/images/2018-09-29/Postman_8.png" alt="Save the new request" />
When creating the new request we should select “Inherit auth from parent”
as the authentication type.</p>

<p>Now if we send our test request we should get <code class="highlighter-rouge">200 OK</code> response:
<img src="assets/images/2018-09-29/Postman_9.png" alt="It works" /></p>

<h2 id="making-our-pre-request-script-work-with-multiple-environments">Making our pre-request script work with multiple environments</h2>

<p>Often we have to work with multiple environments like
development, staging (UAT) and production.
Each of these environments uses different URLs for services
and for OAuth authorization server. 
Not to mention that each environment will 
have its own set of client secrets (passwords).</p>

<p>Fortunately for us Postman has build in support for multiple environments.
Let’s start by creating a new environment with all necessary values
that are needed by our pre-request script:
<img src="assets/images/2018-09-29/Postman_10.png" alt="Create a new environment" /></p>

<p>Then we must modify our script to use values from the selected
environment:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">getvar</span><span class="p">(</span><span class="nx">variableName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">variables</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">variableName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">value</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span>
        <span class="s2">`Variable '</span><span class="p">${</span><span class="nx">variableName</span><span class="p">}</span><span class="s2">' is not defined. Do you forget to select an environment?`</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">let</span> <span class="nx">tokenUrl</span> <span class="o">=</span> <span class="nx">getvar</span><span class="p">(</span><span class="s1">'tokenUrl'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">getvar</span><span class="p">(</span><span class="s1">'clientId'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">clientSecret</span> <span class="o">=</span> <span class="nx">getvar</span><span class="p">(</span><span class="s1">'clientSecret'</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">scope</span> <span class="o">=</span> <span class="nx">getvar</span><span class="p">(</span><span class="s1">'scope'</span><span class="p">);</span> 

<span class="c1">// rest of the script is the same as before</span></code></pre></figure>

<p>And that is all. Now we must define all environments that
we need and we are ready to go:
<img src="assets/images/2018-09-29/Postman_11.png" alt="Sending request with environment set" /></p>

<h2 id="troubleshooting">Troubleshooting</h2>

<p>Select <code class="highlighter-rouge">View -&gt; Show Postman Console</code> to see all log statements
made by our pre-request script: 
<img src="assets/images/2018-09-29/Postman_12.png" alt="Postman Console" /></p>

<p>Also using traffic sniffer like <a href="https://www.telerik.com/fiddler">Fiddler</a>
or <a href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project">ZAP</a>
to compare requests made by auth popup and pre-request script may be helpful:
<img src="assets/images/2018-09-29/zap.png" alt="ZAP" /></p>

<p>If you are going to use ZAP do not forget to set ZAP as a proxy in Postman settings.</p>


	  ]]></description>
	</item>


</channel>
</rss>
