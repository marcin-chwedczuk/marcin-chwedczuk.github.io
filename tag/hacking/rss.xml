<?xml version="1.0" encoding="UTF-8" ?>

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
   
      <title>marcin-chwedczuk.github.io/</title>
   
   <link>http://localhost:4000</link>
   <description>A place where I share my thoughts about programming.</description>
   <language>en-uk</language>
   <managingEditor> </managingEditor>
   <atom:link href="rss" rel="self" type="application/rss+xml" />
   
	<item>
	  <title>Fun with AT commands and an old modem</title>
	  <link>//fun-with-at-commands-and-old-modem</link>
	  <author></author>
	  <pubDate>2019-09-21T02:00:01+02:00</pubDate>
	  <guid>//fun-with-at-commands-and-old-modem</guid>
	  <description><![CDATA[
	     <p>Recently, while cleaning my flat, I found an old Huawei E3131
USB modem. I planed to throw it away, but then I reminded myself
that this simple device, as virtually all modems, supports a
primitive text based interface known as “AT commands”.
And so I started thinking about
spending a few hours of my time
sending AT commands and figuring out what is actually
possible.
This post is the result of this few hours of hacking. Enjoy!</p>

<p>When I connected the modem to my PC it was immediately
recognized as both an USB Drive and an GSM modem.
Grepping through <code class="highlighter-rouge">dmesg</code> revealed that three serial port
terminals where created at <code class="highlighter-rouge">/dev/ttyUSB0</code>,
<code class="highlighter-rouge">/dev/ttyUSB1</code> and <code class="highlighter-rouge">/dev/ttyUSB2</code>:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ dmesg | grep tty
[29167.640728] usb 3-9: GSM modem (1-port) converter now attached to ttyUSB0
[29167.640808] usb 3-9: GSM modem (1-port) converter now attached to ttyUSB1
[29167.640861] usb 3-9: GSM modem (1-port) converter now attached to ttyUSB2</code></pre></figure>

<p>To be honest I expected only a single <code class="highlighter-rouge">tty</code> file…</p>

<p>Running <code class="highlighter-rouge">stty</code> command on <code class="highlighter-rouge">ttyUSB0</code> returned
some useful information, including
<a href="https://en.wikipedia.org/wiki/Symbol_rate">baud rate</a>:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ stty -F /dev/ttyUSB0
speed 9600 baud; line = 0;
eof = ^A; min = 1; time = 0;
-brkint -icrnl ixoff ixany -imaxbel
-opost -onlcr
-icanon -echo -echoe</code></pre></figure>

<p><code class="highlighter-rouge">-</code> before an option name means that this option is disabled.
Explanations for all options can be found in <code class="highlighter-rouge">man stty</code>.
For example <code class="highlighter-rouge">-echo</code> means that the characters that we
are writing, are not visible on the screen.
That is not very comfortable but can be changed easily
(you can try it yourself in bash by executing <code class="highlighter-rouge">stty -echo</code>
to disable
and <code class="highlighter-rouge">stty echo</code> to enable echo).</p>

<p>To connect to <code class="highlighter-rouge">ttyUSB0</code> I used <code class="highlighter-rouge">minicom</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>apt install minicom</code></pre></figure>

<p>We need to create a <code class="highlighter-rouge">minicom</code> configuration first.
For some reason <code class="highlighter-rouge">minicom</code> was not
able to save it’s config file in my home directory and
insisted on saving it into <code class="highlighter-rouge">/etc/minicom/</code> and so I
have to run it with <code class="highlighter-rouge">sudo</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">sudo </span>minicom <span class="nt">-s</span></code></pre></figure>

<p>Configuring <code class="highlighter-rouge">minicom</code> is like a journey to 80s,
entire UI is text based:
<img src="/assets/images/2019-09-23/mc-main-menu.png" alt="minicom main menu" />
First we need to go into “Serial port setup” section:
<img src="/assets/images/2019-09-23/mc-serial-port.png" alt="minicom serial port setting" />
and change “Serial Device” to <code class="highlighter-rouge">/dev/ttyUSB0</code> 
(to do this press A, change the field value and press either 
Enter to save or Escape to cancel).
Then we need to change baud rate (press E):
<img src="/assets/images/2019-09-23/mc-baud-rate.png" alt="minicom baud rate setting" />
On this screen press C and then Enter.
Next we need to go into “Screen and Keyboard” section and
enable echo (press Q) and then Enter:
<img src="/assets/images/2019-09-23/mc-scrn-kbd.png" alt="minicom screen and keyboard settings" />
We need to enable <em>local</em> echo (on the minicom side)
because, as <code class="highlighter-rouge">stty</code> indicated
the serial port itself does not support it.</p>

<p>Then we need to return to the main menu (press Enter)
and select “Save setup as…” option. I saved
my config under <code class="highlighter-rouge">huawei2</code> name. Then we should choose
“Exit from Minicom”. If you chose “Exit” use Ctrl+A
followed by X to exit.</p>

<p>Now we can start <code class="highlighter-rouge">minicom</code> without <code class="highlighter-rouge">sudo</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">minicom huawei2</code></pre></figure>

<p>and execute our first AT command which is just <code class="highlighter-rouge">AT</code>.
The modem should respons with <code class="highlighter-rouge">OK</code> if everything works:
<img src="/assets/images/2019-09-23/mc-w1.png" alt="minicom working" /></p>

<p>To find out what options are supported by my
modem, I googled for “huawei e3131 at command interface specification”
and found a PDF document describing supported AT commands.
By the way AT commands are 
<a href="https://en.wikipedia.org/wiki/De_facto_standard">de facto standard</a>
and could be used with any modem.</p>

<p>TIP: To exit <code class="highlighter-rouge">minicom</code> press Ctrl+A followed by X (must be upper case).</p>

<p>WARNING: In the following sections I assume that we
inserted a working SIM card into the modem.</p>

<h4 id="obtaining-information-from-the-modem">Obtaining information from the modem</h4>

<p>We can obtain a lot of information about our modem and
the SIM card just by running AT commands.
For example we may ask the modem for its phone number:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CNUM

+CNUM: "NUMER WLASNY","+48999123999",145

OK</code></pre></figure>

<p>(“NUMER WLASNY” is “MY OWN NUMBER” in Polish),
or for its IMEI number:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CGSN

865459999999999

OK</code></pre></figure>

<p>To read a modem flag or a setting we need to run a command
in <code class="highlighter-rouge">AT+CMD?</code> format.
For example to obtain the character set used by the modem
we send <code class="highlighter-rouge">AT+CSCS?</code> command:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CSCS?

+CSCS: "IRA"

OK</code></pre></figure>

<p>To check what values are acceptable for this flag
we run a command in <code class="highlighter-rouge">AT+CMD=?</code> format:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CSCS=?

+CSCS: ("IRA","UCS2","GSM")

OK</code></pre></figure>

<p>And to set flag/setting value we execute 
a command in <code class="highlighter-rouge">AT+CMD=value</code> format like <code class="highlighter-rouge">AT+CSCS="GSM"</code>:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CSCS="GSM"

OK
AT+CSCS?

+CSCS: "GSM"

OK</code></pre></figure>

<p>Network signal strength can be checked using <code class="highlighter-rouge">AT+CSQ</code> command:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CSQ

+CSQ: 23,99

OK</code></pre></figure>

<p>The response has format <code class="highlighter-rouge">+CSQ: signal-strength, error-rate</code>.
Signal strength varies from 31 (very good)
to 0 (very poor / lack of signal).
In my case bit error rate is not supported (99) by the modem.</p>

<p><code class="highlighter-rouge">AT+COPS</code> command allows us to check the
current network and to get a list of
the present networks:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+COPS?

+COPS: 0,0,"Plus",0

OK
AT+COPS=?

+COPS: (2,"Plus","PLUS","26001",0),
 (1,"Plus","PLUS","26001",2),
 (3,"T-Mobile PL","T-Mobile PL","26002",2),
 (3,"Orange PL","Orange","26003",2),
 //... OUTPUT TRUNCATED

OK</code></pre></figure>

<h4 id="sending-ussd-codes">Sending USSD codes</h4>

<p>USSD codes (short codes) like “*100#” are quite useful,
we can use them to check money amount on our account or
to change the current tariff.
Let’s see how to send them using AT commands.
First hurdle to overcome is 
the encoding used while sending an USSD code.
By default the codes must be encoded using
GSM7Bit encoding, which is not
related to 7-bit ASCII in any way.
I couldn’t find any online encoder/decoder for this
encoding, but fortunatelly
I found a pice of code that does exactly what we want:
<a href="https://github.com/bsimic0001/AegisWallet/blob/master/mobile/src/main/java/com/aegiswallet/utils/MessagingUtils.java">MessagingUtils.java</a>
And so I added a <code class="highlighter-rouge">main</code> method and pasted the code to 
<a href="https://www.compilejava.net/">www.compilejava.net</a>
to obtain an online converter. 
You can see the final, “paste ready” code
<a href="https://gist.github.com/marcin-chwedczuk/96f7f2a310ca416bed88a6dc10b7abc6">here</a>.</p>

<p>Encoding <code class="highlighter-rouge">*100#</code> in GSM7Bit gives us <code class="highlighter-rouge">AA180C3602</code>.
Now we may issue our USSD request using <code class="highlighter-rouge">AT+CUSD</code> command:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">OK
AT+CUSD=1,"AA180C3602",15

OK

+CUSD: 0,"C135BD1E66BBF3A0393DEC06ADDF6E7A1844668741EE7ABB2CAF8368B85C2E97CBE572B91C48078AB160301094E97481966F37FD0DBA87F5EE3288FC0691DDE93048866BC1722D192C9603C5623A1A4D378301",15</code></pre></figure>

<p><code class="highlighter-rouge">1</code> (first value in the request) means that we want to see the response,
<code class="highlighter-rouge">15</code> (the last value) is the encoding type that we are using.</p>

<p>Next we need to use our GSM7Bit decoder to obtain plain
text from the network response (in Polish):</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">Aktualny stan konta dla numeru 48999999999 : 1,00 PLN.
Konto wazne do dnia 28-09-2019 11:44:30</code></pre></figure>

<h4 id="sending-and-receiving-sms">Sending and receiving SMS</h4>

<p>Our next step will be to send and to receive an SMS:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CMGF=1

OK
AT+CMGS="+48333666999"

&gt; Hello, world!
+CMGS: 7

OK</code></pre></figure>

<p>Before we send a message we must switch to the text mode,
which can be done by issuing <code class="highlighter-rouge">AT+CMGF=1</code> command.
The default mode is the PDU mode, which requires
creating and parsing PDU binary frames.</p>

<p>To send an SMS <code class="highlighter-rouge">AT+CMGS="phone-number"</code> command is used.
After executing <code class="highlighter-rouge">AT+CMGS</code>, a command prompt (<code class="highlighter-rouge">&gt;</code>) will
appear allowing us to write our message.
When we are done we press Ctrl+Z,
few seconds later the message will be delivered.</p>

<p>To list received and sent messages we can use <code class="highlighter-rouge">AT+CMGL</code>
command:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CMGL=?

+CMGL: ("REC UNREAD","REC READ","STO UNSENT","STO SENT","ALL")

OK
AT+CMGL="ALL"

+CMGL: 0,"REC READ","+48111222333",,"19/09/23,16:01:42+08"
 Pszczolka Maja

OK</code></pre></figure>

<p>Remember to run this command in the text mode (<code class="highlighter-rouge">AT+CMGF=1</code>),
otherwise you will see hex encoded binary PDU frames.</p>

<p>First value in the row is the message index (<code class="highlighter-rouge">0</code>).
We may use this index to either read the message:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CMGR=0

+CMGR: "REC READ","+48111222333",,"19/09/23,16:13:03+08"
 Pszczolka Maja</code></pre></figure>

<p>or to remove it:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CMGD=0

OK
AT+CMGL="ALL"

OK</code></pre></figure>

<h4 id="playing-with-the-phone-book-entries">Playing with the phone book entries</h4>

<p><code class="highlighter-rouge">AT+CPBR</code> command can be used to read SIM card phone book entries:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CPBR=?

+CPBR: (1-250),40,20

OK
AT+CPBR=1,10

+CPBR: 1,"*110#",129,"Obsluga konta"
+CPBR: 2,"112",129,"Nr.alarmowy112"
+CPBR: 3,"999",129,"Pogotowie Rat."
+CPBR: 4,"997",129,"Policja"
+CPBR: 5,"998",129,"Straz pozarna"
+CPBR: 6,"+48601100100",145,"WOPR"
+CPBR: 7,"+48601100300",145,"GOPR/TOPR"
+CPBR: 8,"+48601102601",145,"Biuro obslugi"
+CPBR: 9,"5555",129,"Zasil konto"
+CPBR: 10,"*100#",129,"Stan konta"</code></pre></figure>

<p><code class="highlighter-rouge">AT+CPBR=?</code> returns supported range of indexes (<code class="highlighter-rouge">(1-250)</code>; some of them
may be empty), max. phone number length (<code class="highlighter-rouge">40</code>) and max.
entry name length (<code class="highlighter-rouge">20</code>).
Using this information we may read phone book entries using
<code class="highlighter-rouge">AT+CPBR=&lt;&lt;index-range&gt;&gt;</code> command.
When the phone number starts with <code class="highlighter-rouge">+</code> its type is <code class="highlighter-rouge">145</code>
otherwise its type is <code class="highlighter-rouge">129</code>.</p>

<p>Adding a phone book entry is very simple:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CPBW=25,"111222333",129,"foo"

OK
AT+CPBR=25

+CPBR: 25,"111222333",129,"foo"

OK</code></pre></figure>

<p>The same command can be used to remove a phone book entry:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">AT+CPBW=25

OK
AT+CPBR=25

+CME ERROR: 22</code></pre></figure>

<h4 id="ring-ring-ring">RING RING RING</h4>

<p>AT commands can also be used to make and receive phone calls.
Voice is send/received in WAVE format.
Unfortunately I cannot obtain even a simplest <code class="highlighter-rouge">RING</code> notification
from my modem.</p>


	  ]]></description>
	</item>


</channel>
</rss>
