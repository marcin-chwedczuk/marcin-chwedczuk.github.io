<?xml version="1.0" encoding="UTF-8" ?>

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
   
      <title>marcin-chwedczuk.github.io/</title>
   
   <link></link>
   <description>A place where I share my thoughts about programming.</description>
   <language>en-uk</language>
   <managingEditor> </managingEditor>
   <atom:link href="rss" rel="self" type="application/rss+xml" />
   
	<item>
	  <title>Matching regexes using backtracking</title>
	  <link>//matching-regexes-using-backtracking</link>
	  <author></author>
	  <pubDate>2020-06-28T02:00:01+02:00</pubDate>
	  <guid>//matching-regexes-using-backtracking</guid>
	  <description><![CDATA[
	     <p>In this post we will write a simple regex library.
The table below presents regex operators that we are going to support:</p>

<table>
    <colgroup>
        <col width="25%" />
        <col width="75%" />
    </colgroup>
    <thead>
        <tr class="header">
            <th>Operator</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>A single character e.g. <code class="highlighter-rouge">a</code>, <code class="highlighter-rouge">\n</code>, <code class="highlighter-rouge">\(</code></td>
            <td>
                A single character matches itself.<br />
                Special characters need to be escaped e.g. <code class="highlighter-rouge">\n</code>.
            </td>
        </tr>
        <tr>
            <td>Character groups e.g. <code class="highlighter-rouge">[a-z]</code>, <code class="highlighter-rouge">[^xyz]</code></td>
            <td>Character group matches any character
                that is part of the group.<br /><br />
                Negated character group (<code class="highlighter-rouge">[^xyz]</code>)
                matches any character that is <em>not</em> part of the group.<br /><br />
                Character ranges like <code class="highlighter-rouge">a-z</code> can be used inside groups.
                A character c belongs to <code class="highlighter-rouge">a-z</code> range when its
                numerical value falls between <code class="highlighter-rouge">(int)'a' &lt;= (int)c &lt;= (int)'z'</code>.
            </td>
        </tr>
        <tr>
            <td><code class="highlighter-rouge">.</code> wildcard</td>
            <td>
                <code class="highlighter-rouge">.</code> wildcard will match any single character. 
                <br /><br />
                For example
                <code class="highlighter-rouge">...</code> will match any string consisting of three characters.
            </td>
        </tr>
        <tr>
            <td>Concatenation e.g. <code class="highlighter-rouge">abc</code>,<br /><code class="highlighter-rouge">[0-9]-[0-9]</code></td>
            <td>Just as we can concatenate strings, 
                we may also concatenate regexes. 
                The resulting expression will match an input, only when the input can be split into two parts, so that
                the first part of the input matches the first concatenated regex and
                the second part of the input matches the second concatenated regex.
                <br /><br />
                For example input <code class="highlighter-rouge">9X</code> matches the regex <code class="highlighter-rouge">[0-9][XYZ]</code> because <code class="highlighter-rouge">9</code> matches <code class="highlighter-rouge">[0-9]</code> and <code class="highlighter-rouge">X</code> matches <code class="highlighter-rouge">[XYZ]</code>.
            </td>
        </tr>
        <tr>
            <td>Alternative e.g. <code class="highlighter-rouge">Z|X|[0-9]</code></td>
            <td>Input matches the alternative when it matches
                any branch of the alternative. <br /><br />
                For example inputs <code class="highlighter-rouge">Z</code>, <code class="highlighter-rouge">X</code>
                and <code class="highlighter-rouge">3</code> will all match <code class="highlighter-rouge">Z|X|[0-9]</code> alternative because they match
                respectively <code class="highlighter-rouge">Z</code>, <code class="highlighter-rouge">X</code> and <code class="highlighter-rouge">[0-9]</code> branches. 
                <br /><br />
                Alternative has lower priority than concatenation so
                <code class="highlighter-rouge">foo|bar</code> means <code class="highlighter-rouge">(foo)|(bar)</code>, not <code class="highlighter-rouge">fo(o|b)ar</code>.
            </td>
        </tr>
        <tr>
            <td>Repetition (quantification) 
                e.g. <code class="highlighter-rouge">a*</code>, <code class="highlighter-rouge">[0-9]?</code>, <code class="highlighter-rouge">X{1,5}</code></td>
            <td>
                Preceding regex must match input specified number of times.<br />
                Supported operators are: <br /><br />
                <ul>
                    <li><code>*</code> - matches zero or more times</li>
                    <li><code>+</code> - matches one or more times</li>
                    <li><code>?</code> - matches zero or one time</li>
                    <li><code>{n}</code> - matches exactly n times</li>
                    <li><code>{n,m}</code> - matches between n and m
                     times (inclusive) 
                    </li>
                </ul>
                <div>
                    For example <code class="highlighter-rouge">[0-9]*</code> will match any string consisting of digits, including empty string.<br />
                    On the other hand <code class="highlighter-rouge">[0-9]{2,3}</code> will match strings consisting of two or three decimal digits.<br /><br />
                    In our limited implementation we do not support spaces
                    (or any other whitespace characters) inside <code class="highlighter-rouge">{n,m}</code> expressions.<br /><br />
                    Repetition has higher priority than concatenation and 
                    alternative so <code class="highlighter-rouge">foo{5}</code> means <code class="highlighter-rouge">fo(o{5})</code>, not <code class="highlighter-rouge">(foo){5}</code>.<br /><br />
                    Repetition operators are greedy, this means they will try
                    to match as much input as possible.<br />
                    For example <code class="highlighter-rouge">(a*)(a*)</code> will match the <code class="highlighter-rouge">aaaaa</code> input in
                    the following way <code class="highlighter-rouge">(aaaaa)()</code> - the first <code class="highlighter-rouge">a*</code> will match
                    all the characters, leaving empty string for the second <code class="highlighter-rouge">a*</code> to match.
                </div>
            </td>
        </tr>
        <tr>
            <td><code class="highlighter-rouge">^</code> and <code class="highlighter-rouge">$</code> anchors</td>
            <td>
                <code class="highlighter-rouge">^</code> matches the beginning of the input.<br />
                <code class="highlighter-rouge">$</code> matches the end of the input.<br /><br />
                For example <code class="highlighter-rouge">^foo</code> will match strings that start with
                <code class="highlighter-rouge">foo</code> and <code class="highlighter-rouge">bar$</code> will match strings that end with <code class="highlighter-rouge">bar</code>.
            </td>
        </tr>
        <tr>
            <td>Grouping (parentheses)</td>
            <td>
                Parentheses are used to alter the precedence of the operators.<br /><br />
                For example compare <code class="highlighter-rouge">foo|bar</code> with <code class="highlighter-rouge">fo(o|b)ar</code>,
                the first one will match <code class="highlighter-rouge">foo</code>, the second one <code class="highlighter-rouge">fooar</code>.
            </td>
        </tr>
    </tbody>
</table>

<p>The library itself is quite small, it consists of two parts:
a parser and a matcher. 
The parser is a very simple <a href="https://en.wikipedia.org/wiki/Recursive_descent_parser">recursive descent parser</a>
and as most of manually written parsers
it probably contains some undiscovered bugs.
The parser itself is not the main focus of this article,
so we will tread it as a black box that consumes regular 
expressions in text form and produces equivalent ASTs or Abstract Syntax Trees.</p>

<p>ASTs are tree like data structures, 
that make order of operator evaluation and the internal structure of a regular
expression explicit.
Let’s see this on an example. The AST representation of 
 <code class="highlighter-rouge">^a(foo|bar|egg)*b$</code> regex is:
<img src="assets/images/2020-06-28/ast1.svg" alt="AST tree" /></p>

<p>The anchors <code class="highlighter-rouge">^</code> and <code class="highlighter-rouge">$</code> are represented by their own
AST nodes <code class="highlighter-rouge">AT_BEGINNING</code> and <code class="highlighter-rouge">AT_END</code>.
To represent both character groups and single characters, we use
<code class="highlighter-rouge">GROUP</code> nodes. <code class="highlighter-rouge">GROUP</code> nodes are very simple, they contain a list
of characters that they match. A <code class="highlighter-rouge">GROUP</code> node for <code class="highlighter-rouge">[0-9]</code> regex
contains characters <code class="highlighter-rouge">0123456789</code> in the list.
For negated groups like <code class="highlighter-rouge">[^0-9]</code> we use <code class="highlighter-rouge">NEGATED_GROUP</code> node,
the representation is the same as for <code class="highlighter-rouge">GROUP</code> (we keep <code class="highlighter-rouge">0123456789</code> characters
in the list).
Next is the tricky one, we use <code class="highlighter-rouge">NEGATED_GROUP</code> without any characters
to represent wildcard (<code class="highlighter-rouge">.</code>). This makes sense because an empty group <code class="highlighter-rouge">[]</code> 
does not match anything, so its negation will match all characters.</p>

<p>To represent quantification operators like <code class="highlighter-rouge">?</code>, <code class="highlighter-rouge">+</code>, <code class="highlighter-rouge">*</code> and <code class="highlighter-rouge">{n,m}</code>
we use <code class="highlighter-rouge">REPEAT</code> nodes. <code class="highlighter-rouge">REPEAT</code> nodes contain two additional attributes:
minimum and maximum number of allowed repetitions.
We use <code class="highlighter-rouge">Long.MAX_VALUE</code> to signify that maximum number of repetitions is unbound.
Finally we use <code class="highlighter-rouge">CONCAT</code> node to represent concatenation of two or more
regular expressions.</p>

<p>In the code all AST nodes are represented by a single class
called <code class="highlighter-rouge">RAst</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RAst</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">RAstType</span> <span class="n">type</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Character</span><span class="o">&gt;</span> <span class="n">chars</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">RAst</span><span class="o">&gt;</span> <span class="n">exprs</span><span class="o">;</span>

    <span class="c1">// Repeat from to, both inclusive</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">repeatMin</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">repeatMax</span><span class="o">;</span>

    <span class="c1">// ...</span></code></pre></figure>

<p><code class="highlighter-rouge">type</code> field describes what kind of AST node this instance
represents e.g. <code class="highlighter-rouge">CONCAT</code>.
<code class="highlighter-rouge">GROUP</code> and <code class="highlighter-rouge">NEGATED_GROUP</code> nodes keep the set of matched/not-matched
characters in <code class="highlighter-rouge">chars</code> field.
<code class="highlighter-rouge">CONCAT</code> and <code class="highlighter-rouge">ALTERNATIVE</code> nodes keep their children in <code class="highlighter-rouge">exprs</code> field 
(the order of children is important, hence a <code class="highlighter-rouge">List</code>).
<code class="highlighter-rouge">REPEAT</code> node keeps its only child as a single element list in <code class="highlighter-rouge">exprs</code> field.</p>

<p>The matcher is represented in the code by <code class="highlighter-rouge">BacktrackingMatcher</code> class.
The interface of the matcher is very simple:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BacktrackingMatcher</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Match</span> <span class="nf">match</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">RAst</span> <span class="n">regex</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Match</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">hasMatch</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">input</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">start</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">end</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">matched</span><span class="o">()</span>  <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">hasMatch</span><span class="o">)</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">input</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Our matcher will only find the first substring of the input that
matches the regex. Yet it would not be too difficult to extend 
the algorithm to find all matches (start matching again 
after the end of the previous match).</p>

<p>To implement our matcher we will use an algorithm design technique 
called backtracking. The general idea of backtracking is
very simple: we enumerate all the possible solution candidates
in a smart way and then we return the first candidate that is a valid solution.
The part “in a smart way” is very important, usually
enumerating all solution candidates will result in a very
slow algorithm (think <code class="highlighter-rouge">O(2^n)</code> or even <code class="highlighter-rouge">O(n!)</code>).
The key here is to quickly and early reject some subsets of
the solutions candidates.</p>

<p>Let’s see this on a very simple example,
say we want to solve a puzzle that is about placing various shapes in 3x3 grid. Some places in the grid are already taken. There is also a rule that describes a valid solution: in every row and column we cannot have two shapes of the same kind.
<img src="assets/images/2020-06-28/puzzle.svg" alt="Puzzle board" />
Simple enumeration of all possible assignments of the shapes to the free places
will generate <code class="highlighter-rouge">3^5</code> solution candidates, most of them wrong.
A smarter candidate generation strategy
would be to check immediately after we fill a free place,
if the solution conditions still holds for this place row and column.
This would save us a lot of work, because we could discard a lot of
solution candidates much more early in the process.
For example we could discard all the solution candidates that have
Cloud shape at 1B position in the first step of the algorithm.</p>

<p>The name of the technique itself comes from the specific way
in which the algorithm generates all the solution candidates.
The naive backtracking algorithm that solves our simple puzzle looks like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Board positions:</span>
<span class="c1">// [0 | 1 | 2]</span>
<span class="c1">// [3 | 4 | 5]</span>
<span class="c1">// [6 | 7 | 8]</span>
<span class="c1">// Notice that rowIndex = currentPosition / 3</span>
<span class="c1">// and         colIndex = currentPosition % 3</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">solve</span><span class="o">(</span><span class="kt">char</span><span class="o">[][]</span> <span class="n">board</span><span class="o">,</span> <span class="kt">int</span> <span class="n">currentPosition</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">currentPosition</span> <span class="o">==</span> <span class="mi">9</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// All places are filled, check if this</span>
        <span class="c1">// candidate is a valid solution.</span>
        <span class="k">return</span> <span class="nf">isValidSolution</span><span class="o">(</span><span class="n">board</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isPlaceTaken</span><span class="o">(</span><span class="n">board</span><span class="o">,</span> <span class="n">currentPosition</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// Move to checking the next place.</span>
        <span class="k">return</span> <span class="nf">solve</span><span class="o">(</span><span class="n">board</span><span class="o">,</span> <span class="n">currentPosition</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// Try putting all shapes in the free place</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">char</span> <span class="nl">shape:</span> <span class="k">new</span> <span class="kt">char</span><span class="o">[]</span> <span class="o">{</span> <span class="sc">'C'</span><span class="o">,</span> <span class="sc">'H'</span><span class="o">,</span> <span class="sc">'R'</span> <span class="o">})</span> <span class="o">{</span>
        <span class="n">putShape</span><span class="o">(</span><span class="n">board</span><span class="o">,</span> <span class="n">currentPosition</span><span class="o">,</span> <span class="n">shape</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">solve</span><span class="o">(</span><span class="n">board</span><span class="o">,</span> <span class="n">currentPosition</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// Clear position or BACKTRACK.</span>
        <span class="n">putShape</span><span class="o">(</span><span class="n">board</span><span class="o">,</span> <span class="n">currentPosition</span><span class="o">,</span> <span class="sc">'?'</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>The key part of the algorithm is the <code class="highlighter-rouge">for</code> loop,
where we put a shape on the free place and then remove it 
when don’t find a solution. This removal
or taking a move back is what gave the algorithm its name.
Alternatively we may say that when <code class="highlighter-rouge">solve</code> returns <code class="highlighter-rouge">false</code>,
then the <code class="highlighter-rouge">board</code> is exactly in the same state as it was
before we called <code class="highlighter-rouge">solve</code>.</p>

<p>Matching regular expression is somehow similar to solving our previous puzzle.
At each step we have several possibilities, like should we match <code class="highlighter-rouge">foo</code>
or <code class="highlighter-rouge">fo</code> from the alternative <code class="highlighter-rouge">(foo|fo)</code>. How much characters should
<code class="highlighter-rouge">f+</code> expression match? Should <code class="highlighter-rouge">(bar)?</code> match <code class="highlighter-rouge">bar</code> or nothing?
On the other hand the most complexity in matching regular expressions
comes from the fact that we are matching a recurrent structure (tree).
It’s like matching our puzzle, but where each empty place can contain
another smaller version of the same puzzle that also must be solved.</p>

<p>The main entry point to our regex matching algorithm is</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@FunctionalInterface</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Cont</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">run</span><span class="o">();</span>
<span class="o">}</span>

<span class="kt">boolean</span> <span class="nf">match</span><span class="o">(</span><span class="n">Input</span> <span class="n">input</span><span class="o">,</span> <span class="n">RAst</span> <span class="n">ast</span><span class="o">,</span> <span class="n">Cont</span> <span class="n">cont</span><span class="o">)</span></code></pre></figure>

<p>method. It takes three parameters, <code class="highlighter-rouge">input</code> which is just
the input <code class="highlighter-rouge">String</code> plus a pointer called <code class="highlighter-rouge">pos</code> that tracks next, not yet
matched character. <code class="highlighter-rouge">Input</code> also provides helpful methods that can
be used to save and restore <code class="highlighter-rouge">pos</code> value (we will need that
for backtracking). Next parameter, <code class="highlighter-rouge">ast</code>, is an AST subtree that the algorithm
should match. The last parameter <code class="highlighter-rouge">cont</code> is the most interesting one.
In my previous blog post I wrote about 
<a href="/continuations-in-java">continuations</a>, please read that post before
going further. <code class="highlighter-rouge">cont</code> is lambda expression (but we may thread it also as
a kind of continuation), that when called will
try to match remaining part of the regex AST (e.g. it will match parents
and the remaining siblings nodes of <code class="highlighter-rouge">ast</code> node).</p>

<p>The contract of <code class="highlighter-rouge">match</code> method is as follows.
If the method is not able to match <code class="highlighter-rouge">ast</code> subtree it will
return <code class="highlighter-rouge">false</code>, <code class="highlighter-rouge">cont</code> will not be called and the <code class="highlighter-rouge">input</code>
will not be modified (or it may be restored to the original state).
On the other hand if <code class="highlighter-rouge">ast</code> subtree could be matched then
<code class="highlighter-rouge">cont</code> will be called with the modified <code class="highlighter-rouge">input</code> and
<code class="highlighter-rouge">match</code> will return whatever <code class="highlighter-rouge">cont</code> returns.
Before returning value to the client <code class="highlighter-rouge">input</code> will be restored
to the original state (this is not strictly necessary if we
are looking for the first match but somehow makes algorithm more elegant).</p>

<p>At the top level we will call <code class="highlighter-rouge">match</code> somehow like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">startIndex</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">currentPos</span><span class="o">();</span>
<span class="n">AtomicInteger</span> <span class="n">endIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

<span class="kt">boolean</span> <span class="n">hasMatch</span> <span class="o">=</span> <span class="n">match</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">regex</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">endIndex</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">currentPos</span><span class="o">());</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">});</span></code></pre></figure>

<p>This call means that we are looking for the matches
starting at index <code class="highlighter-rouge">startIndex</code> and if we find one
we save the
end of the match in the <code class="highlighter-rouge">endIndex</code> variable and return <code class="highlighter-rouge">true</code>
to signify that matching process should stop.
This is the only place in the algorithm where we use
<code class="highlighter-rouge">return true</code>. Matched substring could be easily
retrieved as <code class="highlighter-rouge">input.substring(startIndex, endIndex)</code>.</p>

<p>The body of <code class="highlighter-rouge">match</code> method is a giant switch statement that
delegates matching of different AST types to different methods (not counting simple
operators):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">match</span><span class="o">(</span><span class="n">Input</span> <span class="n">input</span><span class="o">,</span> <span class="n">RAst</span> <span class="n">ast</span><span class="o">,</span> <span class="n">Cont</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">RAstType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="na">type</span><span class="o">;</span>
    <span class="n">InputPositionMarker</span> <span class="n">m</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/* some cases skipped */</span>

        <span class="k">case</span> <span class="nl">GROUP:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">atEnd</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ast</span><span class="o">.</span><span class="na">chars</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">input</span><span class="o">.</span><span class="na">current</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">markPosition</span><span class="o">();</span>
                <span class="n">input</span><span class="o">.</span><span class="na">advance</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">cont</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">input</span><span class="o">.</span><span class="na">restorePosition</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="k">case</span> <span class="nl">CONCAT:</span>
            <span class="k">return</span> <span class="nf">concatRec</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">ast</span><span class="o">.</span><span class="na">exprs</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">cont</span><span class="o">);</span>

        <span class="k">case</span> <span class="nl">ALTERNATIVE:</span>
            <span class="k">return</span> <span class="nf">alternativeRec</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">ast</span><span class="o">.</span><span class="na">exprs</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">cont</span><span class="o">);</span>

        <span class="k">case</span> <span class="nl">REPEAT:</span>
            <span class="k">return</span> <span class="nf">repeatRec</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">ast</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">cont</span><span class="o">);</span>

        <span class="k">default</span><span class="o">:</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">AssertionError</span><span class="o">(</span><span class="s">"Unknown AST type: "</span> <span class="o">+</span> <span class="n">type</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Let’s take a look how matching a <code class="highlighter-rouge">GROUP</code> is performed.
If the group matches next input character, we save the current
input pointer in <code class="highlighter-rouge">m</code> variable, then we advance the input pointer 
and finally we call <code class="highlighter-rouge">cont</code> to match the
rest of the regex. After <code class="highlighter-rouge">cont</code> returns we restore the input position
using <code class="highlighter-rouge">finally</code> block. This is a bit hacky but it works.</p>

<p>Matching <code class="highlighter-rouge">CONCAT</code> node is also simple. We use recursion to match
subsequent children expressions:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">concatRec</span><span class="o">(</span><span class="n">Input</span> <span class="n">input</span><span class="o">,</span>
                                 <span class="n">List</span><span class="o">&lt;</span><span class="n">RAst</span><span class="o">&gt;</span> <span class="n">exprs</span><span class="o">,</span>
                                 <span class="kt">int</span> <span class="n">currExpr</span><span class="o">,</span>
                                 <span class="n">Cont</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">currExpr</span> <span class="o">==</span> <span class="n">exprs</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// We matched all the children</span>
        <span class="k">return</span> <span class="n">cont</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// Match exprs.get(currExpr) child</span>
    <span class="k">return</span> <span class="nf">match</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">exprs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currExpr</span><span class="o">),</span> <span class="o">()</span> <span class="o">-&gt;</span>
        <span class="c1">// If it succeeded then match next child expression </span>
        <span class="n">concatRec</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">exprs</span><span class="o">,</span> <span class="n">currExpr</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">cont</span><span class="o">)</span>
    <span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Notice that because we are not consuming any input here we have
nothing to restore.</p>

<p>Similarly <code class="highlighter-rouge">ALTERNATIVE</code> is easy to match:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">alternativeRec</span><span class="o">(</span><span class="n">Input</span> <span class="n">input</span><span class="o">,</span>
                                      <span class="n">List</span><span class="o">&lt;</span><span class="n">RAst</span><span class="o">&gt;</span> <span class="n">expr</span><span class="o">,</span>
                                      <span class="kt">int</span> <span class="n">currExpr</span><span class="o">,</span>
                                      <span class="n">Cont</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">currExpr</span> <span class="o">==</span> <span class="n">expr</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// We tried all branches but found no match.</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// Try matching expr.get(currExpr) branch of the alternative</span>
    <span class="kt">boolean</span> <span class="n">matched</span> <span class="o">=</span> <span class="n">match</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">expr</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currExpr</span><span class="o">),</span> <span class="n">cont</span><span class="o">);</span>
    <span class="c1">// We found a match</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">matched</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>

    <span class="c1">// No match found - Let's try next alternative "branch"</span>
    <span class="k">return</span> <span class="nf">alternativeRec</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">expr</span><span class="o">,</span> <span class="n">currExpr</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">cont</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Here <code class="highlighter-rouge">currExpr</code> points to the current alternative branch that we are matching.
Instead of using recursion we may implement <code class="highlighter-rouge">alternativeRec</code> 
using a simple <code class="highlighter-rouge">for</code> loop, which I left as an exercise for the reader.</p>

<p>Matching <code class="highlighter-rouge">REPEAT</code> node causes the most troubles, because all
quantification operators are greedy by default. This means that
e.g. <code class="highlighter-rouge">a+</code> will try to match as much characters as possible.
To implement this behavior we first attempt to match <code class="highlighter-rouge">REPEAT</code>s child subtree 
as many times as possible, then we move “backwards” calling <code class="highlighter-rouge">cont</code>
each time to check if we have a match.
The diagram below illustrates this process:</p>

<figure class="highlight"><pre><code class="language-nohighlight" data-lang="nohighlight">We match a+ expression:
a
a a
a a a         // We matched a three times.
a a a noMatch // Forth time we have noMatch.
a a a cont()  // We move backwards, calling cont()
a a cont()    // each time until it returns true.
a cont() match // cont() returned true.
               // We stop moving backwards and return true from a+.</code></pre></figure>

<p>The code of <code class="highlighter-rouge">repeatRec</code> is:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">repeatRec</span><span class="o">(</span><span class="n">Input</span> <span class="n">input</span><span class="o">,</span>
                                 <span class="n">RAst</span> <span class="n">repeatAst</span><span class="o">,</span>
                                 <span class="kt">long</span> <span class="n">matchCount</span><span class="o">,</span>
                                 <span class="n">Cont</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// For expressions like R{n,m} do we have</span>
    <span class="c1">// more matches than necessary?</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">matchCount</span> <span class="o">&gt;</span> <span class="n">repeatAst</span><span class="o">.</span><span class="na">repeatMax</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

    <span class="c1">// Greedy matching as much as possible.</span>
    <span class="kt">boolean</span> <span class="n">matched</span> <span class="o">=</span> <span class="n">match</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">repeatAst</span><span class="o">.</span><span class="na">headExpr</span><span class="o">(),</span> <span class="o">()</span> <span class="o">-&gt;</span>
        <span class="n">repeatRec</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">repeatAst</span><span class="o">,</span> <span class="n">matchCount</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">cont</span><span class="o">)</span>
    <span class="o">);</span>

    <span class="c1">// We are moving backwards, calling `cont` each time.</span>
    <span class="c1">// We also make sure that we have min number of matches</span>
    <span class="c1">// for expressions like R{n,m}.</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">matched</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">matchCount</span> <span class="o">&gt;=</span> <span class="n">repeatAst</span><span class="o">.</span><span class="na">repeatMin</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">cont</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">matched</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>And generally that’s it. Our simple regex engine.
There are some details left (like handling <code class="highlighter-rouge">^</code> or <code class="highlighter-rouge">$</code> or
moving <code class="highlighter-rouge">startIndex</code>) but the idea behind the backtracking
matcher should now be familiar to us.</p>

<p>You can find source code for the engine (including tests)
on GitHub: <a href="https://github.com/marcin-chwedczuk/reng">https://github.com/marcin-chwedczuk/reng</a>. But before you jump to see the
code I really recommend you to write a similar engine (in your
favorite language) yourself. This will give you a much more
deeper understanding of the algorithm.</p>

<p>Last but not least, our algorithm has a decent performance,
given that we use reasonable regexes and inputs.
A regex like <code class="highlighter-rouge">(a+)*c</code> matched on the input <code class="highlighter-rouge">aaaaaaaaaaaaaaaaaaaaaaaaaaaab</code>
will have a very bad performance. This is a common problem
not only in our matcher but in most regex libraries
that use backtracking algorithms. You can 
read more about this problem on <a href="https://en.wikipedia.org/wiki/ReDoS">Wikipedia</a>.</p>

	  ]]></description>
	</item>

	<item>
	  <title>Continuations in Java</title>
	  <link>//continuations-in-java</link>
	  <author></author>
	  <pubDate>2020-06-27T02:00:01+02:00</pubDate>
	  <guid>//continuations-in-java</guid>
	  <description><![CDATA[
	     <p>CSP or Continuation-Passing Style is a style of programming in which
functions return results via callbacks.
For example <code class="highlighter-rouge">+</code> operator is a function that takes two numbers and
returns their sum. In CSP <code class="highlighter-rouge">+</code> operator becomes a function that takes
three arguments, two terms and a callback, usually called a continuation in
the context of CSP.
In Java we can express this as:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">cont</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@FunctionalInterface</span>
<span class="kd">private</span> <span class="kd">interface</span> <span class="nc">Cont</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kt">void</span> <span class="nf">apply</span><span class="o">(</span><span class="n">R</span> <span class="n">result</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Because functions’ results are always returned via callback calls,
CSP is forcing us to name the returned values by naming callback parameters.
In addition CSP makes the order of evaluation of an expression explicit.
For example, a simple Java program in imperative style:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">3</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span></code></pre></figure>

<p>Can be expressed in CSP as follows:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">add</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">partialSum</span> <span class="o">-&gt;</span>
  <span class="n">add</span><span class="o">(</span><span class="n">partialSum</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="n">sum</span> <span class="o">-&gt;</span>
    <span class="n">print</span><span class="o">(</span><span class="n">sum</span><span class="o">,</span> <span class="n">unit</span> <span class="o">-&gt;</span>
      <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">))));</span>

<span class="kd">static</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
  <span class="n">cont</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>While transforming imperative programs into CSP form we may encounter
problems with handling procedures (methods returning <code class="highlighter-rouge">void</code> in Java).
A lot of functional programming languages do not support procedures,
instead they define a special type called <code class="highlighter-rouge">Unit</code>, that has only
a single value and use that type to signify that function does
not return any meaningful data.
So defined <code class="highlighter-rouge">Unit</code> type is often identified with the empty tuple <code class="highlighter-rouge">()</code>.
In Java we do not have <code class="highlighter-rouge">Unit</code>, but we may use <code class="highlighter-rouge">Void</code> type with its only
allowed value <code class="highlighter-rouge">null</code> to simulate it.</p>

<p>While looking at our last example we may notice that in CSP form,
function arguments can be in one of three forms:
a constant, a variable or a lambda expression.
There is no rule preventing us from passing two or more
callbacks to a single function. 
Indeed this is necessary to translate <code class="highlighter-rouge">if</code> statement to CSP counterpart:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">iff</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">expr</span><span class="o">,</span>
         <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">trueBranch</span><span class="o">,</span>
         <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">falseBranch</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">expr</span><span class="o">)</span> <span class="n">trueBranch</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="k">else</span> <span class="n">falseBranch</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Instead of <code class="highlighter-rouge">Cont&lt;Boolean&gt;</code> we could use here <code class="highlighter-rouge">Cont&lt;Void&gt;</code> as well.</p>

<p>To get a better feel for CSP we will look at three more examples.
We will start with a simple (naive) program for computing sum
of all numbers between given two numbers:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kt">long</span> <span class="nf">sum</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">)</span> <span class="o">{</span>
  <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">to</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">i</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>The transformation to CSP will become easier
if we first replace <code class="highlighter-rouge">for</code> loop with recursion:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kt">long</span> <span class="nf">sum_rec</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="o">(</span><span class="n">from</span> <span class="o">&gt;</span> <span class="n">to</span><span class="o">)</span>
    <span class="o">?</span> <span class="mi">0</span>
    <span class="o">:</span> <span class="n">from</span> <span class="o">+</span> <span class="n">sum_rec</span><span class="o">(</span><span class="n">from</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">to</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>This version can be easily translated into CSP:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">sumCC</span><span class="o">(</span><span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">,</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">gt</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">to</span><span class="o">,</span> <span class="n">fromGreaterThanTo</span> <span class="o">-&gt;</span>
    <span class="n">iff</span><span class="o">(</span><span class="n">fromGreaterThanTo</span><span class="o">,</span>
      <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">cont</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="mi">0L</span><span class="o">),</span>
      <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">add</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">from1</span> <span class="o">-&gt;</span>
        <span class="n">sumCC</span><span class="o">(</span><span class="n">from1</span><span class="o">,</span> <span class="n">to</span><span class="o">,</span> <span class="n">sumCC1</span> <span class="o">-&gt;</span>
          <span class="n">addLong</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">sumCC1</span><span class="o">,</span> <span class="n">cont</span><span class="o">)))));</span>
<span class="o">}</span></code></pre></figure>

<p>Where <code class="highlighter-rouge">gt</code> is the CSP counterpart of <code class="highlighter-rouge">&gt;</code> operator.</p>

<p>Next we will transform factorial computing function.
This time we will start with a recursive definition that is 
easier to translate:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kt">int</span> <span class="nf">factorial</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
  <span class="k">return</span> <span class="nf">factorial</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)*</span><span class="n">n</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>CSP version of factorial looks like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">factorial</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">eq</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">isNZero</span> <span class="o">-&gt;</span>
    <span class="n">iff</span><span class="o">(</span><span class="n">isNZero</span><span class="o">,</span>
      <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">cont</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
      <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">add</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">nm1</span> <span class="o">-&gt;</span>
        <span class="n">factorial</span><span class="o">(</span><span class="n">nm1</span><span class="o">,</span> <span class="n">fnm1</span> <span class="o">-&gt;</span>
          <span class="n">multiply</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">fnm1</span><span class="o">,</span> <span class="n">cont</span><span class="o">)))));</span>
<span class="o">}</span></code></pre></figure>

<p>As the last example we will transform a function
that computes Fibonacci sequence:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kt">int</span> <span class="nf">fib1</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
    <span class="k">return</span> <span class="nf">fib1</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">fib1</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>In CSP it looks like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">fib</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">lt</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">nlt2</span> <span class="o">-&gt;</span>
    <span class="n">iff</span><span class="o">(</span><span class="n">nlt2</span><span class="o">,</span>
      <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">cont</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
      <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">add</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">nm1</span> <span class="o">-&gt;</span>
        <span class="n">fib</span><span class="o">(</span><span class="n">nm1</span><span class="o">,</span> <span class="n">fnm1</span> <span class="o">-&gt;</span>
          <span class="n">add</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="o">-</span><span class="mi">2</span><span class="o">,</span> <span class="n">nm2</span> <span class="o">-&gt;</span>
            <span class="n">fib</span><span class="o">(</span><span class="n">nm2</span><span class="o">,</span> <span class="n">fnm2</span> <span class="o">-&gt;</span>
              <span class="n">add</span><span class="o">(</span><span class="n">fnm1</span><span class="o">,</span> <span class="n">fnm2</span><span class="o">,</span> <span class="n">cont</span><span class="o">)))))));</span>
<span class="o">}</span></code></pre></figure>

<p>Now we should have, at least intuitive feel, how the
transformation to CSP works. In fact any program can be
transformed to CSP. The last point is quite interesting,
especially if we pass <code class="highlighter-rouge">() -&gt; exit(0)</code> or some other not-returning function
as the last continuation. Why? Because in that case we will
never return from any of the called functions.
Let’s see how this works on a simple example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">factorial</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="n">fac6</span> <span class="o">-&gt;</span>
      <span class="n">print</span><span class="o">(</span><span class="n">fac6</span><span class="o">,</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">)));</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Will never be printed"</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>The entire idea of having a call stack is about providing a way for
the called functions to return the control to the callers.
But if we are never returning, then we don’t need a call stack, right?
Not so fast, some of you may say - what about passing arguments to 
the called functions,
call stack is used for that too. Yes, the arguments are also stored on
the call stack but with CSP we capture 
the values of arguments using closures.
Of course JVM does not know that our programs are in CSP form or that they 
would do fine without having a call stack at all.
Instead we get a new call stack frame every time we call something,
this results in <code class="highlighter-rouge">StackOverflowError</code> quickly when we call
e.g. <code class="highlighter-rouge">factorial(3000, r -&gt; ...)</code>.</p>

<p>Too avoid <code class="highlighter-rouge">StackOverflowError</code>s we may use a technique called trampolining. 
Trampolining in connection with CSP
could reduce the required call stack space to a constant number
of slots.
The idea of trampolining is very simple, we split computation into
parts and then we compute only the first part and <em>return</em> a 
continuation (called thunk) that is responsible for computing the rest. 
The returned continuation captures the result of the first computation in
its closure so we don’t have to recompute it.
Let’s see how a trampolined <code class="highlighter-rouge">+</code> operator would looks like:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="n">Thunk</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">cont</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">sum</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="n">Thunk</span> <span class="nf">add3</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">,</span> <span class="kt">int</span> <span class="n">c</span><span class="o">,</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">add</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">sum</span> <span class="o">-&gt;</span>
            <span class="n">add</span><span class="o">(</span><span class="n">sum</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">cont</span><span class="o">));</span>
<span class="o">}</span>

<span class="nd">@FunctionalInterface</span>
<span class="kd">private</span> <span class="kd">interface</span> <span class="nc">Cont</span><span class="o">&lt;</span><span class="n">R</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="n">Thunk</span> <span class="nf">apply</span><span class="o">(</span><span class="n">R</span> <span class="n">result</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@FunctionalInterface</span>
<span class="kd">private</span> <span class="kd">interface</span> <span class="nc">Thunk</span> <span class="o">{</span>
    <span class="n">Thunk</span> <span class="nf">run</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>Notice that trampolined <code class="highlighter-rouge">+</code> operator splits its computation
into two parts: computing the sum and calling the continuation.
The called continuation will again split it’s work and so on and on.</p>

<p><code class="highlighter-rouge">add3</code> function illustrates two key points. 
One is that the logical flow of the program stays the same, we just
call the passed continuations like in a pure CSP program.
The other is, that to introduce trampolining we only need to modify
primitives provided by our programming language (operators and statements).
The program code stays the same.
Of course because Java is a statically-typed language we need to change 
functions return type from <code class="highlighter-rouge">void</code> into <code class="highlighter-rouge">Thunk</code>, but this is
a simple mechanical change that would not be necessary in 
a dynamically-typed language.</p>

<p>Next example illustrates how trampolined <code class="highlighter-rouge">if</code> statement and
<code class="highlighter-rouge">factorial</code> looks like. Notice that factorial code did not change,
not counting the return type:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="n">Thunk</span> <span class="nf">iff</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">expr</span><span class="o">,</span>
                 <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">trueBranch</span><span class="o">,</span>
                 <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">falseBranch</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="o">(</span><span class="n">expr</span><span class="o">)</span>
    <span class="o">?</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">trueBranch</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
    <span class="o">:</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">falseBranch</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="n">Thunk</span> <span class="nf">factorial</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">cont</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">eq</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">isNZero</span> <span class="o">-&gt;</span>
    <span class="n">iff</span><span class="o">(</span><span class="n">isNZero</span><span class="o">,</span>
      <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">cont</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
      <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">add</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="n">nm1</span> <span class="o">-&gt;</span>
        <span class="n">factorial</span><span class="o">(</span><span class="n">nm1</span><span class="o">,</span> <span class="n">fnm1</span> <span class="o">-&gt;</span>
          <span class="n">multiply</span><span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">fnm1</span><span class="o">,</span> <span class="n">cont</span><span class="o">)))));</span>
<span class="o">}</span></code></pre></figure>

<p>Because we are now performing computation “in parts”, we need 
a procedure that will be continually invoking returned thunks,
thus ensuring that out computation is making progress.
A procedure like this is called a trampoline:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">static</span> <span class="kt">void</span> <span class="nf">trampoline</span><span class="o">(</span><span class="n">Thunk</span> <span class="n">thunk</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">while</span> <span class="o">(</span><span class="n">thunk</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">thunk</span> <span class="o">=</span> <span class="n">thunk</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Cont</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">endCall</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">call</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="n">call</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">};</span>
<span class="o">}</span></code></pre></figure>

<p>We are also providing a new primitive operator <code class="highlighter-rouge">endCall</code> that
can be used to mark the last part of the computation.
Using <code class="highlighter-rouge">trampoline</code> we may now compute <code class="highlighter-rouge">factorial(3000)</code>
without any troubles:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">AtomicInteger</span> <span class="n">res</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
<span class="n">trampoline</span><span class="o">(</span><span class="n">factorial</span><span class="o">(</span><span class="mi">400000</span><span class="o">,</span> <span class="n">endCall</span><span class="o">(</span><span class="nl">res:</span><span class="o">:</span><span class="n">set</span><span class="o">)));</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">get</span><span class="o">())</span></code></pre></figure>

<p>As a side effect, we may now use trampoline to mix
CSP and imperative code in the same program.</p>

<p>CSP and trampolining are not mere theoretical concepts,
there where and are still used to implement e.g. LISP interpreters.
Continuations can also be used to simplify backtracking algorithms.
Source code for this blog post can be found
<a href="https://github.com/marcin-chwedczuk/reng/tree/master/test/pl/marcinchwedczuk/continuations">here</a>.</p>


	  ]]></description>
	</item>

	<item>
	  <title>Spy JVM network traffic with Owasp ZAP proxy</title>
	  <link>//spy-jvm-network-traffic-with-owasp-zap</link>
	  <author></author>
	  <pubDate>2019-01-24T01:00:00+01:00</pubDate>
	  <guid>//spy-jvm-network-traffic-with-owasp-zap</guid>
	  <description><![CDATA[
	     <p>We start by downloading <a href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project">Owasp ZAP proxy</a>:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="c"># Download and unpack...</span>
<span class="nv">$ </span>curl <span class="nt">-O</span> <span class="nt">-J</span> <span class="nt">-L</span> https://github.com/zaproxy/zaproxy/releases/download/2.7.0/ZAP_2.7.0_Linux.tar.gz
<span class="nv">$ </span><span class="nb">tar </span>xvzf ZAP_2.7.0_Linux.tar.gz

<span class="nv">$ </span><span class="c"># Run ZAP proxy...</span>
<span class="nv">$ </span>./ZAP_2.7.0/zap.sh  </code></pre></figure>

<p>By default ZAP listens on <code class="highlighter-rouge">localhost:8080</code>. You can change default address
and port by going into Tools -&gt; Options -&gt; Local Proxies tab:
<img src="assets/images/2019-01-25/zap_options.png" alt="ZAP Local Proxies tab" /></p>

<p>To test that network traffic interception works, 
we will use a simple Java app:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClientBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
            <span class="o">.</span><span class="na">useSystemProperties</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">status</span> <span class="o">=</span> <span class="n">client</span>
            <span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpGet</span><span class="o">(</span><span class="s">"http://httpstat.us/200"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">getStatusLine</span><span class="o">()</span>
            <span class="o">.</span><span class="na">toString</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">finally</span> <span class="o">{</span>
        <span class="n">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>There are few things to notice:</p>

<ul>
  <li>We use Apache HttpClient to perform http requests.</li>
  <li>By default Apache HttpClient do not use proxy servers,
 even if you set ZAP as a system wide proxy. We will deal
 with this problem later. For now we will use <code class="highlighter-rouge">useSystemProperties()</code> method
 on <code class="highlighter-rouge">HttpClientBuilder</code> class that will enable proxy support.</li>
  <li>Right now we will concentrate on intercepting HTTP traffic.
 I will show you how to deal with HTTPS connections later.</li>
</ul>

<p>If we, now, run our application, we will notice that ZAP did not
intercept any traffic:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>java <span class="nt">-jar</span> ./build/libs/zapproxydemo-1.0-SNAPSHOT.jar 
HTTP/1.1 200 OK</code></pre></figure>

<p>Indeed right now our application does not know that it should use
a proxy server. We may force it to use a proxy via JVM command line
parameters:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>java <span class="nt">-Dhttp</span>.proxyHost<span class="o">=</span>127.0.0.1 <span class="se">\</span>
 <span class="nt">-Dhttp</span>.proxyPort<span class="o">=</span>8080 <span class="se">\</span>
 <span class="nt">-Dhttps</span>.proxyHost<span class="o">=</span>127.0.0.1 <span class="se">\</span>
 <span class="nt">-Dhttps</span>.proxyPort<span class="o">=</span>8080 <span class="se">\</span>
 <span class="nt">-jar</span> ./build/libs/zapproxydemo-1.0-SNAPSHOT.jar </code></pre></figure>

<p>or by dynamicaly setting system properties in code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"http.proxyHost"</span><span class="o">,</span> <span class="s">"127.0.0.1"</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"http.proxyPort"</span><span class="o">,</span> <span class="s">"8080"</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"https.proxyHost"</span><span class="o">,</span> <span class="s">"127.0.0.1"</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"https.proxyPort"</span><span class="o">,</span> <span class="s">"8080"</span><span class="o">);</span></code></pre></figure>

<p>Whatever method you use, if you run the application again,
you should be able to see now a single intercepted request in ZAP:
<img src="assets/images/2019-01-25/intercepted_request.png" alt="Intercepted request in ZAP" />
You can remove previously recorded requests in ZAP by pressing <code class="highlighter-rouge">Ctrl+N</code>.</p>

<h4 id="intercepting-traffic-from-proxy-unfriendly-apps">Intercepting traffic from proxy unfriendly apps</h4>

<p>As I mentioned previously, Apache HttpClient ignores
proxy settings by default.
If we create our <code class="highlighter-rouge">HttpClient</code> using <code class="highlighter-rouge">create()</code> method:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClientBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">status</span> <span class="o">=</span> <span class="n">client</span>
            <span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpGet</span><span class="o">(</span><span class="s">"http://httpstat.us/200"</span><span class="o">))</span>
            <span class="o">.</span><span class="na">getStatusLine</span><span class="o">()</span>
            <span class="o">.</span><span class="na">toString</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">status</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">finally</span> <span class="o">{</span>
        <span class="n">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><code class="highlighter-rouge">HttpClient</code> will ignore proxy settings no matter how we set them.</p>

<p>For dealing with cases like this, we may use
<a href="https://github.com/rofl0r/proxychains-ng/tree/v4.13">proxychains-ng</a>.
This project is a new reincarnation of old
<a href="https://github.com/haad/proxychains">proxychains</a> util which is no
longer maintained.
Please be aware of this difference. On my system <code class="highlighter-rouge">apt-get install proxychains</code>
installs <code class="highlighter-rouge">proxychains</code> and not <code class="highlighter-rouge">proxychains-ng</code> that we need here.
To install <code class="highlighter-rouge">proxychains-ng</code> I needed to download sources from GitHub
and compile them myself:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="c"># Checkout tag v4.13</span>
<span class="nv">$ </span>git clone <span class="nt">--branch</span> v4.13 git@github.com:rofl0r/proxychains-ng.git

<span class="nv">$ </span><span class="nb">cd </span>proxychains-ng
<span class="nv">$ </span>./configure
<span class="nv">$ </span><span class="c"># If there are no errors from configure script</span>
<span class="nv">$ </span>make
<span class="nv">$ </span>./proxychains4 <span class="nt">--help</span>

Usage:  ./proxychains4 <span class="nt">-q</span> <span class="nt">-f</span> config_file program_name <span class="o">[</span>arguments]
    <span class="nt">-q</span> makes proxychains quiet - this overrides the config setting
    <span class="nt">-f</span> allows one to manually specify a configfile to use
    <span class="k">for </span>example : proxychains telnet somehost.com
More <span class="nb">help </span><span class="k">in </span>README file

<span class="nv">$ </span><span class="c"># Install system wide...</span>
<span class="nv">$ </span><span class="nb">sudo </span>make install</code></pre></figure>

<p>We also need to change default <code class="highlighter-rouge">proxychains-ng</code> configuration:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nb">sudo </span>vim /etc/proxychains.conf

<span class="c"># Comment out line:</span>
<span class="c"># proxy_dns</span>

<span class="c"># Change ProxyList to:</span>
<span class="o">[</span>ProxyList]
http 127.0.0.1 8080</code></pre></figure>

<p>Now if we run our application using <code class="highlighter-rouge">proxychains</code>:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>proxychains4 java <span class="nt">-jar</span> ./build/libs/zapproxydemo-1.0-SNAPSHOT.jar 
<span class="o">[</span>proxychains] config file found: /etc/proxychains.conf
<span class="o">[</span>proxychains] preloading /usr/local/lib/libproxychains4.so
<span class="o">[</span>proxychains] DLL init: proxychains-ng 4.13-git-10-g1198857
<span class="o">[</span>proxychains] Strict chain  ...  127.0.0.1:8080  ...  23.99.0.12:80  ...  OK
HTTP/1.1 200 OK</code></pre></figure>

<p>We will be able to intercept traffic using ZAP.</p>

<p>One of the limitations of proxychains is that it may not work for
subprocesses. If you app launches other applications they may
not be proxied at all.</p>

<h4 id="intercepting-https-traffic">Intercepting HTTPS traffic</h4>

<p>So far, so good, but what will happen if we try to intercept
HTTPS traffic from a new, more secure, example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"http.proxyHost"</span><span class="o">,</span> <span class="s">"127.0.0.1"</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"http.proxyPort"</span><span class="o">,</span> <span class="s">"8080"</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"https.proxyHost"</span><span class="o">,</span> <span class="s">"127.0.0.1"</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"https.proxyPort"</span><span class="o">,</span> <span class="s">"8080"</span><span class="o">);</span>

    <span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">HttpClientBuilder</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
            <span class="o">.</span><span class="na">useSystemProperties</span><span class="o">()</span>
            <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="n">String</span> <span class="n">url</span> <span class="o">=</span> <span class="s">"https://www.random.org/integers/?num=12&amp;min=1&amp;max=100&amp;col=3&amp;base=10&amp;format=plain&amp;rnd=new"</span><span class="o">;</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="n">HttpEntity</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">client</span>
            <span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpGet</span><span class="o">(</span><span class="n">url</span><span class="o">))</span>
            <span class="o">.</span><span class="na">getEntity</span><span class="o">();</span>

        <span class="n">String</span> <span class="n">responseBody</span> <span class="o">=</span> <span class="n">EntityUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">responseBody</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">finally</span> <span class="o">{</span>
        <span class="n">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>We will get an exception similar to:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">Exception in thread "main" javax.net.ssl.SSLHandshakeException:
sun.security.validator.ValidatorException: PKIX path building failed:
sun.security.provider.certpath.SunCertPathBuilderException: unable
to find valid certification path to requested target</code></pre></figure>

<p>We get this exception because certificate returned by ZAP
proxy is not trusted.
To fix this problem we must generate a new ZAP root cert and add it
(temporarily) to Java keystore.</p>

<p>Generate a new cert and save it somewhere
(Tools -&gt; Options -&gt; Dynamic SSL Certificates):
<img src="assets/images/2019-01-25/gen_cert.png" alt="ZAP generate a new root certificate" />
Don’t forget to click OK.</p>

<p>Then add ZAP root certificate to Java keystore:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$JAVA_HOME</span>/jre/lib/security
<span class="nv">$ </span><span class="nb">pwd</span>
/usr/lib/jvm/java-8-oracle/jre/lib/security
<span class="nv">$ </span><span class="c"># You should see cacerts file in this directory.</span>

<span class="nv">$ </span><span class="c"># Create a backup</span>
<span class="nv">$ </span><span class="nb">sudo </span>cp cacerts cacerts.bakup2019-01-26

<span class="nv">$ </span><span class="c"># Add certificate to the store</span>
<span class="nv">$ </span><span class="nb">sudo </span>keytool <span class="nt">-importcert</span> <span class="se">\</span>
 <span class="nt">-alias</span> zap-proxy.org <span class="se">\</span>
 <span class="nt">-file</span> ~/owasp_zap_root_ca.cer <span class="se">\</span>
 <span class="nt">-keystore</span> cacerts
<span class="nv">$ </span><span class="c"># When asked about keystore password </span>
<span class="nv">$ </span><span class="c"># write: changeit (the default password)</span></code></pre></figure>

<p>If we run our app again, we will be able to intercept an HTTPS request:
<img src="assets/images/2019-01-25/intercept_https.png" alt="Intercepted HTTPS call" /></p>

<p>This again should work with <code class="highlighter-rouge">proxychains-ng</code>.
Sometimes to make it work you will have to <strong>uncommend</strong> <code class="highlighter-rouge">proxy_dns</code>
option in <code class="highlighter-rouge">/etc/proxychains.conf</code> file, that I earlier said to
comment out. Why is this sometimes needed, to be honest, I don’t know but
it works this way…</p>

<p><strong>For security reasons</strong> after you finished your debugging session,
you should remove ZAP certificate from Java keystore:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$JAVA_HOME</span>/jre/lib/security

<span class="nv">$ </span><span class="c"># Make sure you see your cert</span>
<span class="nv">$ </span><span class="nb">sudo </span>keytool <span class="nt">-list</span> <span class="nt">-v</span> <span class="nt">-keystore</span> cacerts | <span class="nb">grep </span>zap-proxy.org
Enter keystore password:  changeit

<span class="nv">$ </span><span class="c"># Remove it</span>
<span class="nv">$ </span><span class="nb">sudo </span>keytool <span class="nt">-delete</span> <span class="nt">-alias</span> zap-proxy.org <span class="nt">-keystore</span> cacerts

<span class="nv">$ </span><span class="c"># Make sure it's gone</span>
<span class="nv">$ </span><span class="nb">sudo </span>keytool <span class="nt">-list</span> <span class="nt">-v</span> <span class="nt">-keystore</span> cacerts | <span class="nb">grep </span>zap-proxy.org
Enter keystore password:  changeit</code></pre></figure>

<p>Always generate a new ZAP proxy certificate
before adding it to Java keystore. If you must do this
often, I can advice you to create a script and/or bash alias to
make entire process more convenient.</p>


	  ]]></description>
	</item>

	<item>
	  <title>Java streams best practices</title>
	  <link>//java-streams-best-practices</link>
	  <author></author>
	  <pubDate>2017-11-08T01:00:00+01:00</pubDate>
	  <guid>//java-streams-best-practices</guid>
	  <description><![CDATA[
	     <p>In this short post I am going to present Java 8 streams 
best practices. Most of them either I figured out myself or
learned from my colleagues.</p>

<p>Let’s start with some “obvious” things about code formatting:</p>

<ul>
  <li>You should have at most one stream method call per line.
 This will make stream operations like <code class="highlighter-rouge">map</code>, <code class="highlighter-rouge">filter</code> and 
 <code class="highlighter-rouge">collect</code> easily recognizable.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// BAD CODE:</span>
<span class="n">strings</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">).</span><span class="na">sorted</span><span class="o">()</span>
	<span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">)).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

<span class="c1">// GOOD CODE:</span>
<span class="n">strings</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
	<span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">)</span>
	<span class="o">.</span><span class="na">sorted</span><span class="o">()</span>
	<span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span></code></pre></figure>

<ul>
  <li>You should <code class="highlighter-rouge">import static</code> all of the standard 
 stream related methods. This will make code shorter, 
 easier to read and easier to understand by removing all 
 unnecessary visual noise.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// BAD CODE:</span>
<span class="n">strings</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
	<span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">Comparator</span><span class="o">.</span><span class="na">reverseOrder</span><span class="o">())</span>
	<span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span><span class="n">Function</span><span class="o">.</span><span class="na">identity</span><span class="o">(),</span> <span class="nl">String:</span><span class="o">:</span><span class="n">length</span><span class="o">));</span>

<span class="c1">// GOOD CODE:</span>
<span class="n">strings</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
	<span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">reverseOrder</span><span class="o">())</span>
	<span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toMap</span><span class="o">(</span><span class="n">identity</span><span class="o">(),</span> <span class="nl">String:</span><span class="o">:</span><span class="n">length</span><span class="o">));</span></code></pre></figure>

<ul>
  <li>You should prefer method references to lambdas.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// AVOID:</span>
<span class="n">strings</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
	<span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">())</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>

<span class="c1">// PREFER:</span>
<span class="n">strings</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
	<span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">String:</span><span class="o">:</span><span class="n">length</span><span class="o">)</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span></code></pre></figure>

<p>Method references are easier to read since we
avoid all the visual noise generated by <code class="highlighter-rouge">-&gt;</code> and <code class="highlighter-rouge">()</code> operators.
They are also handled more efficiently by current version of Java.
Lambda expressions like <code class="highlighter-rouge">s -&gt; s.length()</code> are compiled
to a private static method and an <code class="highlighter-rouge">invokedynamic</code> instruction.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// s -&gt; s.lenght() is translated into:</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="n">Integer</span> <span class="n">lambda$main</span><span class="err">$</span><span class="mi">0</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>Method references are compiled to only <code class="highlighter-rouge">invokedynamic</code> instruction.</p>

<ul>
  <li>You should use methods from <code class="highlighter-rouge">Class&lt;T&gt;</code> to filter stream elements by a type
 and to cast stream elements to a type.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">objects</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
	<span class="s">"a string"</span><span class="o">,</span>
	<span class="mi">42</span><span class="o">,</span>
	<span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">"an array"</span> <span class="o">},</span>
	<span class="s">"another string"</span><span class="o">);</span>

<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">strings</span> <span class="o">=</span> <span class="n">objects</span>
	<span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">::</span><span class="n">isInstance</span><span class="o">)</span>
	<span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">::</span><span class="n">cast</span><span class="o">)</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span></code></pre></figure>

<p>Also rember that <code class="highlighter-rouge">Class&lt;T&gt;::isInstance</code> only checks if 
the value can be assigned to a variable of type <code class="highlighter-rouge">T</code>. For example
<code class="highlighter-rouge">Object.class.isInstance("foo")</code> returns <code class="highlighter-rouge">true</code> because string
<code class="highlighter-rouge">"foo"</code> can be assigned to a variable of type <code class="highlighter-rouge">Object</code>.
If you want to check that stream elements have exactly type <code class="highlighter-rouge">T</code>
you must use expression:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">x</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">T</span><span class="o">.</span><span class="na">class</span><span class="o">))</span></code></pre></figure>

<ul>
  <li>Give meaningful names to frequently used collector expressions.
 In most cases this means extracting collector expression into
 its own method.</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// USED FROM TIME TO TIME:</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Entity</span><span class="o">&gt;</span> <span class="n">entityById</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toMap</span><span class="o">(</span><span class="nl">Entity:</span><span class="o">:</span><span class="n">getId</span><span class="o">,</span> <span class="n">identity</span><span class="o">()));</span>

<span class="c1">// USED FREQUENTLY:</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Entity</span><span class="o">&gt;</span> <span class="n">entityById</span> <span class="o">=</span> <span class="n">entities</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">ExtraCollectors</span><span class="o">.</span><span class="na">toByIdMap</span><span class="o">());</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ExtraCollectors</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">Collector</span><span class="o">&lt;</span><span class="n">Entity</span><span class="o">,?,</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span><span class="n">Entity</span><span class="o">&gt;&gt;</span> <span class="nf">toByIdMap</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span><span class="nl">Entity:</span><span class="o">:</span><span class="n">getId</span><span class="o">,</span> <span class="n">identity</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>You may also consider using static import for your own frequently
used collectors.</p>

<ul>
  <li>Use the following pattern when you sort stream values at hoc:</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">students</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
	<span class="o">.</span><span class="na">sorted</span><span class="o">(</span>
	  <span class="n">comparing</span><span class="o">(</span><span class="nl">Student:</span><span class="o">:</span><span class="n">getSurname</span><span class="o">)</span>
		<span class="o">.</span><span class="na">thenComparing</span><span class="o">(</span><span class="nl">Student:</span><span class="o">:</span><span class="n">getName</span><span class="o">,</span> <span class="n">reverseOrder</span><span class="o">())</span>
		<span class="o">.</span><span class="na">thenComparing</span><span class="o">(</span><span class="nl">Student:</span><span class="o">:</span><span class="n">getAge</span><span class="o">)</span>
		<span class="o">.</span><span class="na">thenComparing</span><span class="o">(</span><span class="nl">Student:</span><span class="o">:</span><span class="n">getId</span><span class="o">,</span> <span class="n">reverseOrder</span><span class="o">())</span>
	<span class="o">)</span>
	<span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span></code></pre></figure>

<p>Notice how we used <code class="highlighter-rouge">reverseOrder()</code> to reverse order of sorting
by name and id. Also bear in mind that it is always a good idea
to extract complicated comparers to its own method or a final field.</p>

<ul>
  <li>Use <code class="highlighter-rouge">IntStream</code>, <code class="highlighter-rouge">LongStream</code> and <code class="highlighter-rouge">DoubleStream</code> when working with
 primitive types. They are faster (they avoid boxing) and easier to
 use (they add useful methods like <code class="highlighter-rouge">sum</code>).</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Stream</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">strings</span> <span class="o">=</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">,</span> <span class="s">"baz"</span><span class="o">);</span>

<span class="kt">double</span> <span class="n">averageLength</span> <span class="o">=</span> <span class="n">strings</span>
		<span class="o">.</span><span class="na">mapToInt</span><span class="o">(</span><span class="nl">String:</span><span class="o">:</span><span class="n">length</span><span class="o">)</span>
		<span class="o">.</span><span class="na">summaryStatistics</span><span class="o">()</span>
		<span class="o">.</span><span class="na">getAverage</span><span class="o">();</span></code></pre></figure>

<p>Use <code class="highlighter-rouge">mapTo[Int|Long|Double]</code> and <code class="highlighter-rouge">mapToObj</code> to convert 
between a stream and a specialized primitive stream.</p>

<p>Also learn about static helper methods exposed by specialized stream
classes:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// prints: 0 1 2 3 4 5 6 7 8 9</span>
<span class="n">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">)</span>
	<span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>

<span class="c1">// prints: 1 2 4 8 16 32 64 128 256 512</span>
<span class="n">IntStream</span><span class="o">.</span><span class="na">iterate</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">)</span>
	<span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
	<span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>

<span class="n">ThreadLocalRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="n">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">();</span>

<span class="c1">// prints: -376368599 2112239618</span>
<span class="c1">// just to demo generate method:</span>
<span class="n">IntStream</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="nl">random:</span><span class="o">:</span><span class="n">nextInt</span><span class="o">)</span>
	<span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
	<span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>

<span class="c1">// prints: -1134353240 2007034835</span>
<span class="c1">// stream of random int's - more idiomatic way:</span>
<span class="n">random</span><span class="o">.</span><span class="na">ints</span><span class="o">()</span>
	<span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
	<span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span></code></pre></figure>

<ul>
  <li>Avoid using <code class="highlighter-rouge">peek()</code>.
 Try to make your streams free of side-effects.</li>
</ul>

<p>This list is by no means complete. I will try to add some more
practices in the future. Bye!</p>


	  ]]></description>
	</item>

	<item>
	  <title>Hibernate HHH000179 warning&#58 Narrowing proxy to class this operation breaks ==</title>
	  <link>//HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality</link>
	  <author></author>
	  <pubDate>2017-07-30T02:00:00+02:00</pubDate>
	  <guid>//HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality</guid>
	  <description><![CDATA[
	     <p>In this post I will explain why Hibernate is generating the HHH000179
warning and when ignoring it may introduce bugs in your code.</p>

<p>To understand what this “Narrowing proxy” is all about,
first we must learn about Hibernate proxies.
When we read a value of lazy loaded property or when we call
<code class="highlighter-rouge">EntityManager::getReference</code> Hibernate returns a proxy object.
This proxy is an instance of a class that was generated at runtime using
library like <a href="http://jboss-javassist.github.io/javassist/">Javassit</a>.</p>

<p>For example for a simple entity:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"person"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="kd">extends</span> <span class="n">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"person_name"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"house_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">House</span> <span class="n">house</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"owner"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Pet</span><span class="o">&gt;</span> <span class="n">pets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;(</span><span class="mi">0</span><span class="o">);</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre></figure>

<p>Generated proxy class looks similar to:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person_</span><span class="err">$</span><span class="n">$_jvst5ed_2</span> 
        <span class="kd">extends</span> <span class="n">Person</span> 
        <span class="kd">implements</span> <span class="n">HibernateProxy</span><span class="o">,</span> <span class="n">ProxyObject</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="n">MethodHandler</span> <span class="n">handler</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span><span class="o">[]</span> <span class="n">_methods_</span><span class="o">;</span>
 
    <span class="c1">// plenty of other stuff here</span>
 
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">UUID</span> <span class="nf">_d7getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">UUID</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Method</span><span class="o">[]</span> <span class="n">var1</span> <span class="o">=</span> <span class="n">_methods_</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">UUID</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">handler</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">var1</span><span class="o">[</span><span class="mi">14</span><span class="o">],</span> <span class="n">var1</span><span class="o">[</span><span class="mi">15</span><span class="o">],</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>TIP: In Hibernate 5.1 you may write generated 
proxy classes to disk by putting a breakpoint
in <a href="https://github.com/hibernate/hibernate-orm/blob/ba3359fe62be258638554fe23a2a0a6a50f7e732/hibernate-core/src/main/java/org/hibernate/proxy/pojo/javassist/JavassistProxyFactory.java#L102"><code class="highlighter-rouge">JavassistProxyFactory::buildJavassistProxyFactory</code></a>
method and setting 
<code class="highlighter-rouge">factory.writeDirectory</code> field to a valid path. 
You may want to use a conditional
breakpoint to avoid doing this manually every time a proxy is generated.</p>

<p>The most important point here is that proxy class <em>extends</em> entity class.</p>

<p>Now let’s see what happens when we mix proxies with inheritance.
Given a simple class hierarchy:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">InheritanceType</span><span class="o">.</span><span class="na">SINGLE_TABLE</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"animal_type"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Pet</span> <span class="kd">extends</span> <span class="n">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"owner_id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Person</span> <span class="n">owner</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">String</span> <span class="nf">makeNoise</span><span class="o">();</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"cat"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cat</span> <span class="kd">extends</span> <span class="n">Pet</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"dog"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dog</span> <span class="kd">extends</span> <span class="n">Pet</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span></code></pre></figure>

<p>When we use <code class="highlighter-rouge">EntityManager::getReference</code> to load a <code class="highlighter-rouge">Pet</code> we will
get a proxy that extends <code class="highlighter-rouge">Pet</code> class because Hibernate does not know yet
whatever our pet is a <code class="highlighter-rouge">Cat</code> or a <code class="highlighter-rouge">Dog</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// In some earlier transaction:</span>
<span class="n">Cat</span> <span class="n">gerard</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cat</span><span class="o">(</span><span class="s">"gerard"</span><span class="o">);</span>
<span class="n">entityManager</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">gerard</span><span class="o">);</span>

<span class="n">gerardId</span> <span class="o">=</span> <span class="n">gerard</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>

<span class="c1">// In current transaction:</span>
<span class="n">Pet</span> <span class="n">pet</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">gerardId</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">)</span>
        <span class="o">.</span><span class="na">is</span><span class="o">(</span><span class="n">hibernateProxy</span><span class="o">())</span>
        <span class="o">.</span><span class="na">is</span><span class="o">(</span><span class="n">uninitialized</span><span class="o">())</span>
        <span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="n">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNotInstanceOf</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span></code></pre></figure>

<p>We may force Hiberante to query database to load proxied entity
state but that doesn’t change proxy identity:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// makeNoise() will access field *via getter* to initialize proxy</span>
<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Pet is a cat: "</span> <span class="o">+</span> <span class="n">pet</span><span class="o">.</span><span class="na">makeNoise</span><span class="o">());</span> <span class="c1">// meow meeeow</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNot</span><span class="o">(</span><span class="n">uninitialized</span><span class="o">())</span>
        <span class="o">.</span><span class="na">isNotInstanceOf</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span></code></pre></figure>

<p>Even though now Hibernate knows that our pet is a <code class="highlighter-rouge">Cat</code> it cannot
change already loaded proxy class definition,
<code class="highlighter-rouge">Pet</code> proxy continues to be so.
This may cause you problems because tests like <code class="highlighter-rouge">pet instanceof Cat</code> will
fail although pet indeed represents a cat.</p>

<p>There is also a second issue that may come up when working with proxies.
If <code class="highlighter-rouge">makeNoise()</code> method would access pet data via field, proxy would not
be notified about that data access and it wouldn’t load data from DB,
causing our method to read an uninitialized field value.
<em>The moral is that we should always use getters and setters 
when dealing with entity state</em>.</p>

<p>Now you may think that if we try to load <code class="highlighter-rouge">Pet</code> again (after proxy was
initialized), Hibernate will return instance of the <code class="highlighter-rouge">Cat</code> entity.
The behavior displayed by Hibernate is slightly different
because of Hibernate first level cache
that prefers returning already
loaded entity instance than creating a new one:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Pet</span> <span class="n">pet2</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">gerardId</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">pet2</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNotInstanceOf</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isSameAs</span><span class="o">(</span><span class="n">pet</span><span class="o">);</span></code></pre></figure>

<p>What will happen when we try to explicitly load a <code class="highlighter-rouge">Cat</code> entity:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// HHH000179: Narrowing proxy to class Cat - this operation breaks ==</span>
<span class="n">Pet</span> <span class="n">pet3</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">gerardId</span><span class="o">);</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">pet3</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNot</span><span class="o">(</span><span class="n">hibernateProxy</span><span class="o">());</span></code></pre></figure>

<p>Now we got the famous HHH000179 warning, and Hiberante handled
us unproxied <code class="highlighter-rouge">Cat</code> instance.
But why was this warning generated? Because right now we 
we have two different object (the proxy and the <code class="highlighter-rouge">Cat</code> instance)
in our session that point to exactly the same entity.</p>

<p>Of course the pet proxy is pointing to the cat instance,
and changes applied to e.g. entity instance are reflected in the proxy state:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
    <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"gerard"</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">)</span>
    <span class="o">.</span><span class="na">isNotSameAs</span><span class="o">(</span><span class="n">pet3</span><span class="o">);</span>

<span class="c1">// set via Cat entity</span>
<span class="n">pet3</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"proton"</span><span class="o">);</span>

<span class="c1">// reflected via proxy</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
    <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"proton"</span><span class="o">);</span></code></pre></figure>

<p>So you may think that having two representation of the same DB row 
in memory is OK,
but the real troubles begin if we do not override <code class="highlighter-rouge">equals()</code> and <code class="highlighter-rouge">hashCode()</code>
methods properly. This is demonstrated by example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Alice is owner of the cat</span>
<span class="n">Person</span> <span class="n">alice</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">aliceId</span><span class="o">);</span>

<span class="c1">// Alice can own and not own the same cat...</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">alice</span><span class="o">.</span><span class="na">getPets</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">pet</span><span class="o">))</span>
        <span class="o">.</span><span class="na">isFalse</span><span class="o">();</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">alice</span><span class="o">.</span><span class="na">getPets</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">pet3</span><span class="o">))</span>
        <span class="o">.</span><span class="na">isTrue</span><span class="o">();</span>

<span class="c1">// But only if we rely on default equals() and </span>
<span class="c1">// hashCode() implementation</span></code></pre></figure>

<p>Fortunately this can be easily fixed by providing <code class="highlighter-rouge">equals()</code> implementation
that is based either on primary key or business key equality, for example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@MappedSuperclass</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Type</span><span class="o">(</span><span class="n">type</span><span class="o">=</span><span class="s">"binary(16)"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">UUID</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="nf">BaseEntity</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">BaseEntity</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="n">BaseEntity</span> <span class="n">that</span> <span class="o">=</span> <span class="o">(</span><span class="n">BaseEntity</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>

        <span class="c1">// remember to use *getters*</span>
        <span class="k">return</span> <span class="nf">getId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getId</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>We may also reproduce above behaviour with lazy loading,
you can find an example of how to do this in the attached source code.</p>

<h4 id="significance-in-the-real-world-application">Significance in the real world application</h4>

<p>Recently I developed a module in an application that was based on huge
in-house framework (Ughhh). This framework let’s call it X
contained some of the entities that we used, but we have no way of
modifying them. The only way to add some fields to an already existing entity
was to extend it (fortunately for us, most entities in X were declared
as base classes with inheritance strategy SINGLE_TABLE).
At the end of this project we had plenty of small class hierarchies
consisting only of super class and a single subclass.
We also had plenty of references from other entities to either
this sup or super classes. As you may expect this was a fertile 
ground for Hibernate HHH000179 warnings, and so I devoted a few hours of
my time to figure out what this warning is all about. In our case
providing proper <code class="highlighter-rouge">equals()</code> and <code class="highlighter-rouge">hashCode()</code> was all that was needed.
But just to sum up I want to present the last, more real world example.</p>

<p>Shipped with framework X:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"extensible_user"</span><span class="o">)</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">InheritanceType</span><span class="o">.</span><span class="na">SINGLE_TABLE</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"discriminator"</span><span class="o">)</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"NOT_USED"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LegacyUser</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userPreference1</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userPreference2</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"document"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LegacyDocument</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">contents</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"owner_id"</span><span class="o">)</span>
    <span class="c1">// !!! Entity referes to super class !!!</span>
    <span class="kd">private</span> <span class="n">LegacyUser</span> <span class="n">owner</span><span class="o">;</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre></figure>

<p>Shipped with my module:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"EXTENDED"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExtendedUser</span> <span class="kd">extends</span> <span class="n">LegacyUser</span> <span class="o">{</span>
    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userPreference3</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"comment"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Comment</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="cm">/*...*/</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"document_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">LegacyDocument</span> <span class="n">document</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="cm">/*...*/</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"author_id"</span><span class="o">)</span>
    <span class="c1">// !!! Entity refers to subclass !!!</span>
    <span class="kd">private</span> <span class="n">ExtendedUser</span> <span class="n">author</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">contents</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre></figure>

<p>As you can see legacy class <code class="highlighter-rouge">Document</code> is using <code class="highlighter-rouge">LegacyUser</code> to refer to
a system user. New class <code class="highlighter-rouge">Comment</code> is using <code class="highlighter-rouge">ExtendedUser</code> to refer to
a system user.</p>

<p>Without proper <code class="highlighter-rouge">equals()</code> implementation we may get into troubles:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">LegacyDocument</span> <span class="n">document</span> <span class="o">=</span> 
    <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">LegacyDocument</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">documentId</span><span class="o">);</span>

<span class="c1">// we load some data from document owner</span>
<span class="n">LegacyUser</span> <span class="n">documentOwner</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="na">getOwner</span><span class="o">();</span>
<span class="n">doSomethingWithOwner</span><span class="o">(</span><span class="n">documentOwner</span><span class="o">);</span>

<span class="c1">// HHH000179: Narrowing proxy to class ExtendedUser </span>
<span class="c1">//  - this operation breaks ==</span>
<span class="c1">// When Hibernate loads comment that has </span>
<span class="c1">// field of type ExtendedUser with the same Id as LegacyUser </span>
<span class="c1">// it realizes that documentOwner is indeed ExtendedUser.</span>
<span class="c1">// So this time Hibernate could figure out that </span>
<span class="c1">// it generated wrong proxy without querying DB.</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
            <span class="s">"select c from Comment c where c.document.id = :docId"</span><span class="o">,</span>
            <span class="n">Comment</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"docId"</span><span class="o">,</span> <span class="n">document</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
        <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

<span class="c1">// Now the most interesting part</span>
<span class="n">ExtendedUser</span> <span class="n">commentAuthor</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getAuthor</span><span class="o">();</span>

<span class="c1">// comment author and doc author is the same user</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">commentAuthor</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
        <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">documentOwner</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>

<span class="c1">// but...</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">commentAuthor</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNotSameAs</span><span class="o">(</span><span class="n">documentOwner</span><span class="o">);</span>

<span class="c1">// Now without overloading hashCode()/equals() we may</span>
<span class="c1">// expect troubles...</span>
<span class="n">Set</span><span class="o">&lt;</span><span class="n">LegacyUser</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">commentAuthor</span><span class="o">);</span>
<span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">documentOwner</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">users</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span></code></pre></figure>

<p>And that is all that I wanted to say about HHH000179. 
The most important thing that
you should remember from this article is that with 
good <code class="highlighter-rouge">equals()</code> and <code class="highlighter-rouge">hashCode()</code> implementation
HHH000179 warning can be safely ignored.</p>

<p>Source code: <a href="https://github.com/marcin-chwedczuk/hibernate_narrowing_proxy_warning_demo">https://github.com/marcin-chwedczuk/hibernate_narrowing_proxy_warning_demo</a></p>


	  ]]></description>
	</item>

	<item>
	  <title>Debugging OpenJDK 8 with NetBeans on Ubuntu</title>
	  <link>//debugging-openjdk8-with-netbeans-on-ubuntu</link>
	  <author></author>
	  <pubDate>2017-06-24T02:00:00+02:00</pubDate>
	  <guid>//debugging-openjdk8-with-netbeans-on-ubuntu</guid>
	  <description><![CDATA[
	     <p>In this post we will learn how to download, compile and debug OpenJDK 8
using Ubuntu and NetBeans IDE.</p>

<h4 id="downloading-and-compiling-openjdk-8">Downloading and compiling OpenJDK 8</h4>

<p><a href="http://openjdk.java.net/">OpenJDK</a> project uses Mercurial for source
code versioning. To get sources using Mercurial follow instructions described 
<a href="https://stackoverflow.com/a/29845834/1779504">in this SO answer</a>.</p>

<p>To get OpenJDK sources using Git, we need to clone OpenJDK repository mirror
provided by <a href="https://adoptopenjdk.net/about.html">AdoptOpenJDK project</a>.
To speed things up we will only clone <code class="highlighter-rouge">master</code> branch without commit history:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ git clone \
	--depth 1 \
	-b master \
	git@github.com:AdoptOpenJDK/openjdk-jdk8u.git</code></pre></figure>

<p>Now when we have sources, its time to compile OpenJDK.
First we need to install all required dependencies:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ sudo apt install \
        libx11-dev \
        libxext-dev \
        libxrender-dev \
        libxtst-dev \
        libxt-dev \
        libcups2-dev \
        libfreetype6-dev \
        libasound2-dev</code></pre></figure>

<p>Then we must run <code class="highlighter-rouge">configure</code> script:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ cd openjdk-jdk8u/
$ chmod +x ./configure
$ ./configure \
	--with-debug-level=slowdebug \
	--with-target-bits=64</code></pre></figure>

<p>We call <code class="highlighter-rouge">configure</code> with two options:</p>

<ul>
  <li><code class="highlighter-rouge">--with-debug-level=slowdebug</code> - enables generating debug information
 when compiling OpenJDK</li>
  <li><code class="highlighter-rouge">--with-target-bits=64</code> - we will generate 64-bit binaries</li>
</ul>

<p>It may happen than <code class="highlighter-rouge">configure</code> will return error telling you that you need
to install some additional tool/library. This is something to be expected,
just follow instructions printed by <code class="highlighter-rouge">configure</code>.
You may need to do this several times until you will 
have all required dependencies installed on your system.</p>

<p>Now it’s time to actually build OpenJDK:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ make</code></pre></figure>

<p>This may take some time…</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">----- Build times -------
Start 2017-06-24 17:45:26
End   2017-06-24 17:48:53
00:00:12 corba
00:01:25 hotspot
00:00:08 jaxp
00:00:12 jaxws
00:01:13 jdk
00:00:17 langtools
00:03:27 TOTAL
-------------------------
Finished building OpenJDK for target 'default'</code></pre></figure>

<p>Now we may use our newly built <code class="highlighter-rouge">java</code> to run “Hello, world!” program:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ ./build/linux-x86_64-normal-server-slowdebug/jdk/bin/java \
	-cp "/home/me/dev/java/helloWorld/" \
	App
Hello, world!</code></pre></figure>

<h4 id="creating-project-for-openjdk-8-in-netbeans">Creating project for OpenJDK 8 in NetBeans</h4>

<p>You need to <a href="https://netbeans.org/downloads/">download</a>
and install NetBeans IDE. Since HotSpot is written in C++ we will need
NetBeans with C/C++ support.</p>

<p>Now it is time to create project for OpenJDK in NetBeans.
Select File-&gt;New Project…-&gt;C/C++ Project with Existing Sources…
<img src="assets/images/2017-06-24/new_proj.png" alt="New project dialog window." /></p>

<p>Then select “Custom” configuration mode:
<img src="assets/images/2017-06-24/new_proj2.png" alt="New project dialog window 2 step." /></p>

<p>We must use the same <code class="highlighter-rouge">configure</code> arguments that we used on command line:
<img src="assets/images/2017-06-24/new_proj3.png" alt="Configure options." /></p>

<p>Now click “Next” a few more times and then click “Finish”.
NetBeans should now run <code class="highlighter-rouge">configure</code> and build OpenJDK, you should
see compiler output in Build tab:
<img src="assets/images/2017-06-24/new_proj4.png" alt="Build window." /></p>

<p>After build ends you should see output similar to:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">----- Build times -------
Start 2017-06-24 18:07:15
End   2017-06-24 18:11:17
00:00:14 corba
00:01:45 hotspot
00:00:08 jaxp
00:00:13 jaxws
00:01:22 jdk
00:00:20 langtools
00:04:02 TOTAL
-------------------------
Finished building OpenJDK for target 'default'

BUILD SUCCESSFUL (total time: 4m 2s)</code></pre></figure>

<p>Now we should try to run our “Hello, World!” program from NetBeans.
Click on project and then select “Properties”:
<img src="assets/images/2017-06-24/run_1.png" alt="Run command." />
Then go to “Run” category and click on “…” next to “Run command”, then
write any command that you want to run. Assume that <code class="highlighter-rouge">"${OUTPUT_PATH}"</code>
refers to <code class="highlighter-rouge">java</code> binary:
<img src="assets/images/2017-06-24/run_2.png" alt="Run command step 2." /></p>

<p>Now select Run-&gt;Run Project, NetBeans will ask you what binary you want to
run, select <code class="highlighter-rouge">java</code>:
<img src="assets/images/2017-06-24/run_3.png" alt="Run command step 3." /></p>

<p>Now you should see “Hello, world!” written in Output window:
<img src="assets/images/2017-06-24/run_4.png" alt="Run command step 4." /></p>

<h4 id="debugging-with-netbeans">Debugging with NetBeans</h4>

<p>Call to <code class="highlighter-rouge">System.out.println(...)</code> in Java will ultimately be handled
by <code class="highlighter-rouge">writeBytes</code> function in <code class="highlighter-rouge">jdk/src/share/native/java/io/io_util.c</code> file
(this is only valid for Linux builds of OpenJDK).</p>

<p>Lets put a breakpoint inside that function and see what will happen when we
try to debug Hello world program:
<img src="assets/images/2017-06-24/debug_1.png" alt="Debug step 1." /></p>

<p>Select Debug-&gt;Debug Main Project. After executing this command you
may see window:
<img src="assets/images/2017-06-24/debug_2.png" alt="Debug step 2." />
JVM uses <code class="highlighter-rouge">SIGSEGV</code> for its internal purposes, from our point of view
we may just ignore it (select “Don’t Catch this Singla Again” and 
“Forward and Continue”). After a few seconds we should be able to
catch a breakpoint and see what JVM is doing:
<img src="assets/images/2017-06-24/debug_3.png" alt="Debug step 3." /></p>

<p>And that’s it! 
Now you will be able to check and understand how JVM is working under cover.</p>

<h4 id="references">References</h4>

<ul>
  <li><a href="http://marcelinorc.com/2016/02/17/using-netbeans-to-hack-openjdk9-in-ubuntu/">http://marcelinorc.com/2016/02/17/using-netbeans-to-hack-openjdk9-in-ubuntu/</a></li>
  <li><a href="https://neugens.wordpress.com/2015/02/26/debugging-the-jdk-with-gdb/">https://neugens.wordpress.com/2015/02/26/debugging-the-jdk-with-gdb/</a></li>
  <li><a href="https://github.com/AdoptOpenJDK/openjdk-build">https://github.com/AdoptOpenJDK/openjdk-build</a></li>
</ul>


	  ]]></description>
	</item>

	<item>
	  <title>Zen and the Art of Unit Testing</title>
	  <link>//zen-and-the-art-of-unit-testing</link>
	  <author></author>
	  <pubDate>2017-02-19T01:00:00+01:00</pubDate>
	  <guid>//zen-and-the-art-of-unit-testing</guid>
	  <description><![CDATA[
	     <p>In this blog post we will concern ourselves with unit testing of
classic 3-layer business applications. We will assume that
all business logic lives in services and components,
that these services operate on entities that are stored and retrieved
from relational database, 
and that these entities doesn’t contain any logic.
Moreover we assume usage of 
DTO (<a href="https://en.wikipedia.org/wiki/Data_transfer_object">Data Transfer Object</a>)
to pass data between GUI and application services.</p>

<p><img src="assets/images/2017-02-19/L3arch.svg" alt="High level overview of 3-layer architecture" /></p>

<p><a href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a>
is indispensable when it comes to unit testing of
modern business applications. Without DI you are forced to write slow
and difficult to maintain integration tests instead of unit tests.
If you don’t know what DI
is or if you don’t used it before please read articles on <a href="https://en.wikipedia.org/wiki/Dependency_injection">Wikipedia</a> and <a href="https://martinfowler.com/articles/injection.html">Martin Fowler site</a>,
and return here after you are comfortable with both idea and usage of DI.</p>

<p>Now when we are ready to start, we will follow Confucius advice:</p>

<blockquote>
  <p>By three methods we may learn wisdom: First, by reflection, which is noblest;
Second, by imitation, which is easiest; 
and third by experience, which is the bitterest.</p>

  <p>Confucius</p>
</blockquote>

<p>and learn by imitation,
by observing how we may unit test <code class="highlighter-rouge">UserService</code> component.
We will use popular <a href="http://junit.org/junit4/">JUnit</a> unit testing framework
with <a href="http://site.mockito.org/">Mockito</a> mocking library.</p>

<h4 id="userservice-component"><code class="highlighter-rouge">UserService</code> component</h4>

<p><code class="highlighter-rouge">UserService</code> implements following business requirements:</p>

<ul>
  <li>Users forgot their passwords from time to time, application should
 provide a way to reset forgotten passwords.</li>
  <li>To reset their passwords users must provide email address they use
 to login to our system.</li>
  <li>If provided email address does not belong to any user, application 
 should do nothing. Otherwise application should generate unique
 password reset token and send
 to provided email address message with link to reset password form.
 Link should contain reset password token.
 In both cases application should show to user success message.</li>
  <li>Password reset tokens should be unique. Tokens should be hard to
 guess or enumerate (no numbers here). Token may be used only once
 to reset password. If we want to reset password again we need a new token.
 Token is valid for 24 hours starting from the date it was created, after 24
 hours token cannot be used to change password.</li>
  <li>When user open reset password link in her browser it should be presented
 with a form that allows to enter a new password. After clicking OK,
 application should validate token used in link, and if it is still
 valid application should change user password and make token invalid.
 Then application should send password change confirmation message to user.
 In case of expired token application should show warning to user.</li>
</ul>

<p><img src="assets/images/2017-02-19/flow.svg" alt="Password change flow" /></p>

<p>WARNING Before implementing real password reset feature please read
<a href="https://www.troyhunt.com/everything-you-ever-wanted-to-know/">Everything you ever wanted to know about building a secure password reset feature</a>.</p>

<p>Now when we understand business requirements we may attempt to implement
<code class="highlighter-rouge">UserService</code> component:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="kd">implements</span> <span class="n">UserService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">NotificationService</span> <span class="n">notificationService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">DateTimeProvider</span> <span class="n">dateTimeProvider</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">CryptoService</span> <span class="n">cryptoService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UserServiceImpl</span><span class="o">(</span>
		<span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">,</span>
		<span class="n">DateTimeProvider</span> <span class="n">dateTimeProvider</span><span class="o">,</span>
		<span class="n">CryptoService</span> <span class="n">cryptoService</span><span class="o">,</span>
		<span class="n">NotificationService</span> <span class="n">notificationService</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">userRepository</span> <span class="o">=</span> <span class="n">requireNonNull</span><span class="o">(</span><span class="n">userRepository</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">notificationService</span> <span class="o">=</span> <span class="n">requireNonNull</span><span class="o">(</span><span class="n">notificationService</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dateTimeProvider</span> <span class="o">=</span> <span class="n">requireNonNull</span><span class="o">(</span><span class="n">dateTimeProvider</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cryptoService</span> <span class="o">=</span> <span class="n">requireNonNull</span><span class="o">(</span><span class="n">cryptoService</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startResetPasswordProcess</span><span class="o">(</span><span class="n">String</span> <span class="n">userEmailAddress</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="n">userEmailAddress</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span><span class="o">;</span>

        <span class="n">UUID</span> <span class="n">token</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
        <span class="n">LocalDateTime</span> <span class="n">tokenValidityEndDate</span> <span class="o">=</span>
                <span class="n">dateTimeProvider</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusDays</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="n">user</span><span class="o">.</span><span class="na">setResetPasswordToken</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setResetPasswordTokenValidityEndDate</span><span class="o">(</span>
                <span class="n">tokenValidityEndDate</span><span class="o">);</span>

        <span class="n">ResetPasswordNotificationData</span> <span class="n">notificationData</span> <span class="o">=</span> 
            <span class="k">new</span> <span class="nf">ResetPasswordNotificationData</span><span class="o">(</span>
                <span class="n">user</span><span class="o">.</span><span class="na">getEmail</span><span class="o">(),</span>
                <span class="n">token</span><span class="o">,</span>
                <span class="n">tokenValidityEndDate</span><span class="o">);</span>

        <span class="n">notificationService</span>
            <span class="o">.</span><span class="na">sendResetPasswordNotification</span><span class="o">(</span><span class="n">notificationData</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">finishResetPasswordProcess</span><span class="o">(</span>
            <span class="n">String</span> <span class="n">userEmailAddress</span><span class="o">,</span>
            <span class="n">String</span> <span class="n">newPassword</span><span class="o">,</span>
            <span class="n">UUID</span> <span class="n">resetPasswordToken</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="n">userEmailAddress</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getResetPasswordToken</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">return</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">user</span><span class="o">.</span><span class="na">getResetPasswordToken</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">resetPasswordToken</span><span class="o">))</span>
            <span class="k">return</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getResetPasswordTokenValidityEndDate</span><span class="o">()</span>
                <span class="o">.</span><span class="na">isBefore</span><span class="o">(</span><span class="n">dateTimeProvider</span><span class="o">.</span><span class="na">now</span><span class="o">()))</span>
            <span class="k">return</span><span class="o">;</span>

        <span class="n">user</span><span class="o">.</span><span class="na">setResetPasswordToken</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setResetPasswordTokenValidityEndDate</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">newPasswordHash</span> <span class="o">=</span> <span class="n">cryptoService</span><span class="o">.</span><span class="na">sha1</span><span class="o">(</span><span class="n">newPassword</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setPasswordHash</span><span class="o">(</span><span class="n">newPasswordHash</span><span class="o">);</span>

        <span class="n">notificationService</span>
            <span class="o">.</span><span class="na">sendPasswordChangedConfirmation</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getEmail</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p><code class="highlighter-rouge">UserService</code> operates on the following <code class="highlighter-rouge">User</code> entity:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">passwordHash</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="n">UUID</span> <span class="n">resetPasswordToken</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">LocalDateTime</span> <span class="n">resetPasswordTokenValidityEndDate</span><span class="o">;</span>
    
    <span class="c1">// getter, setter, etc.</span>
<span class="o">}</span></code></pre></figure>

<p>And requires four other components to work, namely: <code class="highlighter-rouge">UserRepository</code>,
<code class="highlighter-rouge">NotificationService</code>, <code class="highlighter-rouge">DateTimeProvider</code> and <code class="highlighter-rouge">CryptoService</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="o">{</span>
    <span class="n">User</span> <span class="nf">findByEmailAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">emailAddress</span><span class="o">);</span>
<span class="o">}</span>
    
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">NotificationService</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">sendResetPasswordNotification</span><span class="o">(</span>
            <span class="n">ResetPasswordNotificationData</span> <span class="n">data</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">sendPasswordChangedConfirmation</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">);</span>
<span class="o">}</span>
    
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DateTimeProvider</span> <span class="o">{</span>
    <span class="n">LocalDateTime</span> <span class="nf">now</span><span class="o">();</span>
<span class="o">}</span>
    
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CryptoService</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">sha1</span><span class="o">(</span><span class="n">String</span> <span class="n">input</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p><code class="highlighter-rouge">DateTimeProvider</code> dependency was introduced solely for the purpose
of easier unit testing, as we will find out later.</p>

<p>Design of <code class="highlighter-rouge">UserService</code> follows principles of DI, component advertises
all dependencies it needs as constructor parameters.
DI containers may then use <a href="https://www.tutorialspoint.com/spring/constructor_based_dependency_injection.htm">constructor based dependency injection</a> to
provide implementations of these dependencies.
Right now we have only implemented <code class="highlighter-rouge">UserService</code>, <code class="highlighter-rouge">UserRepository</code> and
other dependencies are not implemented yet.
Nevertheless with usage of stubs and
mocks we may test <code class="highlighter-rouge">UserService</code> implementation right now.</p>

<h4 id="writing-tests-for-startresetpasswordprocess">Writing tests for <code class="highlighter-rouge">startResetPasswordProcess</code></h4>

<p>By convention we should put tests for <code class="highlighter-rouge">ComponentName</code> into <code class="highlighter-rouge">ComponentNameTest</code>
class. For example tests for <code class="highlighter-rouge">UserServiceImpl</code> should be put 
into <code class="highlighter-rouge">UserServiceImplTest</code> class.</p>

<p>When you use Maven you should put your test class in 
the same package that contains tested component.
For example <code class="highlighter-rouge">UserServiceImpl</code>
is part of <code class="highlighter-rouge">io.mc.letsmock.demo</code> package, so <code class="highlighter-rouge">UserServiceImplTest</code>
should also belong to <code class="highlighter-rouge">io.mc.letsmock.demo</code> package.
With Maven the only difference between application code and test code is the
directory in which code resides. Application code will be in <code class="highlighter-rouge">src/main/java</code>
directory and test code will be in <code class="highlighter-rouge">src/test/java</code> directory:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">.
`-- src
    |-- main
    |   `-- java
    |       `-- io
    |           `-- mc
    |               `-- letsmock
    |                   `-- demo
    |                       |-- UserServiceImpl.java
    |                       `-- UserService.java
    `-- test
        `-- java
            `-- io
                `-- mc
                    `-- letsmock
                        `-- demo
                            `-- UserServiceImplTest.java</code></pre></figure>

<p>Another popular
convention used with e.g. Ant is to put applicaiton code into
<code class="highlighter-rouge">mycompany.productA.xx.yy</code> package and test code
into <code class="highlighter-rouge">mycompany.productA.test.xx.yy</code> package.</p>

<p>The important thing here is that team should choose one particular convention
how to name tests and where to put test classes and stick to it.
If you use Maven I strongly encourage using conventions that I described above.</p>

<h5 id="naming-tests">Naming tests</h5>

<p>After reading requirements we come to conclusion that we need the following
test cases to be sure that <code class="highlighter-rouge">startResetPasswordProcess</code> method works:</p>

<ul>
  <li>When we couldn’t find <code class="highlighter-rouge">User</code> with specified email address, component should
 do not nothing, in particular is should not crash</li>
  <li>When there is <code class="highlighter-rouge">User</code> with specified email address, component should set
 <code class="highlighter-rouge">resetPasswordToken</code> and <code class="highlighter-rouge">resetPasswordTokenValidityEndDate</code> fields on <code class="highlighter-rouge">User</code>
 instance to respectively 
 newly generated token, and <code class="highlighter-rouge">LocalDateTime</code> instance that represent point
 in time 24 hours later than now.</li>
  <li>When there is <code class="highlighter-rouge">User</code> with specified email address, component should send
 message with token to user using <code class="highlighter-rouge">NotificationService</code>.</li>
</ul>

<p>Notice that each of these test cases test only single thing, this is
very important if we want to have clean and independent tests.
As method should do only one thing, 
test should test only one “outcome” of a method.
When you gain more experience you may want to relax this rule, 
but if you just started unit testing
you should stick with it for some time.</p>

<p>There are two schools when it comes to naming test methods, first
school teaches that test name should consists of three parts:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kt">void</span> <span class="nf">scenario_conditions_outcome</span><span class="o">()</span></code></pre></figure>

<p><code class="highlighter-rouge">scenario</code> is the thing that we want to test, this in most cases
will be the name of the method that we want to test.
<code class="highlighter-rouge">conditions</code> describe the state of program that tested method
may expect when it is called. <code class="highlighter-rouge">outcome</code> is the state of the program
that we expect after tested method returns.</p>

<p>To give you a feeling how this naming scheme works here
are some dummy tests for Java <code class="highlighter-rouge">+</code> operator:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">plusOperator_given1And5_returns6</span><span class="o">()</span>
<span class="kt">void</span> <span class="nf">plusOperator_given1AndMinus7_returnsMinus6</span><span class="o">()</span>
<span class="kt">void</span> <span class="nf">plusOperator_whenResultIsGreaterThanMAXINT_wrapsResultsUsingMod2Arithmetic</span><span class="o">()</span></code></pre></figure>

<p>The second school took inspiration for thier naming scheme from 
<a href="https://en.wikipedia.org/wiki/Behavior-driven_development">BDD</a>
movement.
This school advices that 
test names should consists of full sentences that describe both
conditions and outcome of tested method. 
Names for <code class="highlighter-rouge">+</code> operator tests following this
scheme looks like:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">_1_plus_5_should_return_6</span><span class="o">()</span>
<span class="kt">void</span> <span class="nf">_1_plus_minus_7_should_return_minus_6</span><span class="o">()</span>
<span class="kt">void</span> <span class="nf">when_result_of_addition_is_greater_than_MAXINT_plus_operator_should_wrap_result_using_mod_2_arithmetic</span><span class="o">()</span></code></pre></figure>

<p>As you can see test names generated using this approach 
can be quite verbose at times. Verbosity of this schema is it great advantage 
because the main purpose of test name is to tell you
what exactly is not working when given test fails.</p>

<p>I prefer first school with scenario/conditions/outcome division of test name,
so I will use it exclusively in the rest of this post.</p>

<p>Returning to <code class="highlighter-rouge">startResetPasswordProcess</code> we should create three tests:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">void</span> <span class="nf">startResetPasswordProcess_givenEmailNotBelongingToAnyUser_doesNothing</span><span class="o">()</span>
<span class="kt">void</span> <span class="nf">startResetPasswordProcess_givenEmailOfExistingUser_generatesToken</span><span class="o">()</span>
<span class="kt">void</span> <span class="nf">startResetPasswordProcess_givenEmailOfExistingUser_sendsNotificationToUser</span><span class="o">()</span></code></pre></figure>

<p>These test names are not as descriptive as they may be, but are close
to what you may expect in average enterprise application.</p>

<h5 id="anatomy-of-test-method">Anatomy of test method</h5>

<p>Our first test will check that <code class="highlighter-rouge">startResetPasswordProcess</code> won’t throw
exceptions when called with email address of non-existing user.
But to test <code class="highlighter-rouge">UserServiceImpl</code> class we must create it’s instance and this
will require providing all necessary dependencies.
Fortunately we may use Mockito library to 
to generate 
dummy implementations of <code class="highlighter-rouge">UserRepository</code>, <code class="highlighter-rouge">NotificationService</code> 
and others. By default these dummy implementations do nothing and
are similar to handcrafted test stubs like:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRepositoryStub</span> <span class="kd">implements</span> <span class="n">UserRepository</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">findByEmailAddress</span><span class="o">(</span><span class="n">String</span> <span class="n">emailAddress</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>But we will soon see that we can instruct Mockito to return
values from these stubs or to check if a given method was called
on dummy object.</p>

<p>Below you can see our first test code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">startResetPasswordProcess_givenEmailNotBelongingToAnyUser_doesNothing</span><span class="o">()</span> <span class="o">{</span>
   <span class="c1">// arrange</span>
   <span class="n">UserRepository</span> <span class="n">userRepository</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">UserRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">DateTimeProvider</span> <span class="n">dateTimeProvider</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">DateTimeProvider</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">CryptoService</span> <span class="n">cryptoService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">CryptoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">NotificationService</span> <span class="n">notificationService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">NotificationService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

   <span class="n">when</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="s">"unknown@example.com"</span><span class="o">))</span>
	   <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

   <span class="n">UserServiceImpl</span> <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserServiceImpl</span><span class="o">(</span>
	   <span class="n">userRepository</span><span class="o">,</span>
	   <span class="n">dateTimeProvider</span><span class="o">,</span>
	   <span class="n">cryptoService</span><span class="o">,</span>
	   <span class="n">notificationService</span><span class="o">);</span>
   <span class="c1">// act</span>
   <span class="n">userService</span><span class="o">.</span><span class="na">startResetPasswordProcess</span><span class="o">(</span><span class="s">"unknown@example.com"</span><span class="o">);</span>

   <span class="c1">// assert</span>
   <span class="n">verify</span><span class="o">(</span><span class="n">notificationService</span><span class="o">,</span> <span class="n">never</span><span class="o">())</span>
	   <span class="o">.</span><span class="na">sendResetPasswordNotification</span><span class="o">(</span><span class="n">any</span><span class="o">());</span>

   <span class="n">verify</span><span class="o">(</span><span class="n">notificationService</span><span class="o">,</span> <span class="n">never</span><span class="o">())</span>
	   <span class="o">.</span><span class="na">sendPasswordChangedConfirmation</span><span class="o">(</span><span class="n">anyString</span><span class="o">());</span>
<span class="o">}</span></code></pre></figure>

<p>Before we dig into details let’s look at this test from high level
point of view. Almost every test method can be divided into three
parts called Arrange-Act-Assert or Given-When-Then. I used comments
to signify when each of these parts start. Each of these parts has
different purpose. In Arrange part we must create instance of
tested component and all necessary test data and
also we must set up Mockito mocks.
If we may compare test method to theater play, then Arrange is like 
preparing scene, costumes and lights.</p>

<p>The first four lines of our test Arrange section are responsible for
creating dummy implementations of <code class="highlighter-rouge">UserServiceImpl</code> dependencies:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">UserRepository</span> <span class="n">userRepository</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">UserRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">DateTimeProvider</span> <span class="n">dateTimeProvider</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">DateTimeProvider</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">CryptoService</span> <span class="n">cryptoService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">CryptoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">NotificationService</span> <span class="n">notificationService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">NotificationService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span></code></pre></figure>

<p>Then we set up one of our stub objects:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">when</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="s">"unknown@example.com"</span><span class="o">))</span>
	<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span></code></pre></figure>

<p>Here we instruct Mockito that dummy implementation generated for 
<code class="highlighter-rouge">UserRepository::findByEmailAddress</code>
should return <code class="highlighter-rouge">null</code> when called with <code class="highlighter-rouge">"unknown@example.com"</code> string.
But to be honest these lines are redundant because
method stubs generated by Mockito by default return <code class="highlighter-rouge">null</code> for
reference types, default values for primitives and empty collections
for methods returning collections. 
Still I leave them because they 
make purpose of our test more evident.</p>

<p>After Arrange section we have an Act section. Again (so many AAAAs)
returning to our theater play analogy (another A, no pun intended)
Act section is like the actual play, we invoke tested component and let
the code be alive. Act part is usually very short, in most cases
it consists of single line of code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">userService</span><span class="o">.</span><span class="na">startResetPasswordProcess</span><span class="o">(</span><span class="s">"unknown@example.com"</span><span class="o">);</span></code></pre></figure>

<p>The last section in the test method is Assert when we want to
check results produced by tested code. In our test we check two
assumptions:</p>

<ol>
  <li>Invocation of <code class="highlighter-rouge">startResetPasswordProcess</code> does not throw any exceptions.
 This is tested implicitly by JUnit - test fails when test method throwns
 exception. Since our test passes we are certain that <code class="highlighter-rouge">startResetPasswordProcess</code>
 doesn’t throw any.</li>
  <li>We want to be certain that no notification was send to provided email address
 so we asses with the help of Mockit that none of the methods on <code class="highlighter-rouge">NotificationService</code>
 was called.</li>
</ol>

<p>Mockito verification syntax is a bit unintuitive, so let’s take a closer
look at one of our assertions:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">verify</span><span class="o">(</span><span class="n">notificationService</span><span class="o">,</span> <span class="n">never</span><span class="o">())</span>
	   <span class="o">.</span><span class="na">sendResetPasswordNotification</span><span class="o">(</span><span class="n">any</span><span class="o">());</span></code></pre></figure>

<p>We use <code class="highlighter-rouge">verify</code> to tell Mockit that we want to preform verification.
<code class="highlighter-rouge">never()</code> means that we expect that method was not called on dummy object.
Then we specify method that should not be called,
in our case <code class="highlighter-rouge">sendResetPasswordNotification</code>. 
We pass <code class="highlighter-rouge">any()</code> as method parameter to tell Mockito that method
should just not be called, and that we don’t care about parameters
that was passed to it. Mockito is quite flexible here
and we may for example verify that method should not be called with given
set of parameters but must be called with another. We may also replace
<code class="highlighter-rouge">never()</code> with one of several predicates like e.g. <code class="highlighter-rouge">times(2)</code> to assert that
method was called twice.</p>

<h4 id="testing-with-assertions">Testing with assertions</h4>

<p>Our first test assured us that <code class="highlighter-rouge">startResetPasswordProcess</code> works correctly
with email address of unknown user. Now it is time to check if
it also works correctly given email addresses of existing user.
Our second test will check if given valid email address <code class="highlighter-rouge">UserServiceImpl</code>
generates a new token for <code class="highlighter-rouge">User</code> and sets it expiry date correctly.
We also will check that user password is not altered in any way by
starting reset password process (it should change only when we <em>finish</em>
password change process).
Here is our second test code:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">startResetPasswordProcess_givenEmailOfExistingUser_generatesToken</span><span class="o">()</span> <span class="o">{</span>
   <span class="c1">// arrange</span>
   <span class="n">UserRepository</span> <span class="n">userRepository</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">UserRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">DateTimeProvider</span> <span class="n">dateTimeProvider</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">DateTimeProvider</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">CryptoService</span> <span class="n">cryptoService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">CryptoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
   <span class="n">NotificationService</span> <span class="n">notificationService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">NotificationService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

   <span class="n">UserServiceImpl</span> <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserServiceImpl</span><span class="o">(</span>
	   <span class="n">userRepository</span><span class="o">,</span>
	   <span class="n">dateTimeProvider</span><span class="o">,</span>
	   <span class="n">cryptoService</span><span class="o">,</span>
	   <span class="n">notificationService</span><span class="o">);</span>

   <span class="n">User</span> <span class="n">joe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>
   <span class="n">joe</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="s">"joe@example.com"</span><span class="o">);</span>
   <span class="n">joe</span><span class="o">.</span><span class="na">setResetPasswordToken</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
   <span class="n">joe</span><span class="o">.</span><span class="na">setResetPasswordTokenValidityEndDate</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
   <span class="n">joe</span><span class="o">.</span><span class="na">setPasswordHash</span><span class="o">(</span><span class="s">"old-password-hash"</span><span class="o">);</span>

   <span class="n">when</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="s">"joe@example.com"</span><span class="o">))</span>
	   <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">joe</span><span class="o">);</span>

   <span class="n">when</span><span class="o">(</span><span class="n">dateTimeProvider</span><span class="o">.</span><span class="na">now</span><span class="o">())</span>
	   <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">2017</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>

   <span class="c1">// act</span>
   <span class="n">userService</span><span class="o">.</span><span class="na">startResetPasswordProcess</span><span class="o">(</span><span class="s">"joe@example.com"</span><span class="o">);</span>

   <span class="c1">// assert</span>
   <span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getResetPasswordToken</span><span class="o">())</span>
	   <span class="o">.</span><span class="na">isNotNull</span><span class="o">();</span>

   <span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getResetPasswordTokenValidityEndDate</span><span class="o">())</span>
	   <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">2017</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>

   <span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getPasswordHash</span><span class="o">())</span>
	   <span class="o">.</span><span class="na">withFailMessage</span><span class="o">(</span><span class="s">"Password should not be changed"</span><span class="o">)</span>
	   <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"old-password-hash"</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Arrange section of our second test does not differ much from Arrange
section of our first test, except that we added code for creation
of an <code class="highlighter-rouge">User</code> instance. Notice that we populate <code class="highlighter-rouge">User</code> with carefully 
chosen data that will allow us to test <code class="highlighter-rouge">startResetPasswordProcess</code>
implementation easily e.g. we set both <code class="highlighter-rouge">resetPasswordToken</code> and
<code class="highlighter-rouge">resetPasswordTokenValidityEndDate</code> to <code class="highlighter-rouge">null</code>.
Then we instruct Mockito to return our <code class="highlighter-rouge">User</code> instance when we
ask <code class="highlighter-rouge">UserRepository</code> for user with <code class="highlighter-rouge">joe@example.com</code> email address:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">when</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="s">"joe@example.com"</span><span class="o">))</span>
	<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">joe</span><span class="o">);</span></code></pre></figure>

<p>We should strive to make our unit tests as much deterministic as possible.
Unit test that sometimes fails without a reason is burden rather than
a benefit, and should be either fixed or removed.
To make unit more robust we should avoid depending on external input
like information about current time. To facilitate that I decided to
introduce <code class="highlighter-rouge">DateTimeProvider</code> component with sole purpose of making
unit tests more predictable. With small help of Mockito we are now
masters of time:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">when</span><span class="o">(</span><span class="n">dateTimeProvider</span><span class="o">.</span><span class="na">now</span><span class="o">())</span>
	<span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">2017</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span></code></pre></figure>

<p>After all this preparations, we are now free to invoke <code class="highlighter-rouge">startResetPasswordProcess</code>
and check it’s outcome. In unit tests we mainly use assertions to check
correctness of tested code. JUnit already comes with handy assertion library
that we may use like this:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.*;</span>

<span class="n">assertNotNull</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getResetPasswordToken</span><span class="o">());</span>
<span class="n">assertEquals</span><span class="o">(</span><span class="s">"old-password-hash"</span><span class="o">,</span> <span class="n">joe</span><span class="o">.</span><span class="na">getPasswordHash</span><span class="o">());</span></code></pre></figure>

<p>When JUnit assertion fails it throws <code class="highlighter-rouge">AssertionError</code>, test fails and
we get error similar to:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">AssertionError</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">fail</span><span class="o">(</span><span class="n">Assert</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">86</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">Assert</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">41</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">Assert</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">712</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">(</span><span class="n">Assert</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">722</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">io</span><span class="o">.</span><span class="na">mc</span><span class="o">.</span><span class="na">letsmock</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">UserServiceImplTest</span><span class="o">.</span><span class="na">startResetPasswordProcess_givenEmailOfExistingUser_generatesToken</span><span class="o">(</span><span class="n">UserServiceImplTest</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">113</span><span class="o">)</span></code></pre></figure>

<p>Unfortunately error messages generated by JUnit assertions are not
always the best way to find out what went wrong with failing tests.
JUnit assertions are also cumbersome to use at times. From these
and other reasons I prefer to use assertions from assertJ library
and I used them when I wrote our second test:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">assertj</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">;</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getResetPasswordToken</span><span class="o">())</span>
	<span class="o">.</span><span class="na">isNotNull</span><span class="o">();</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getResetPasswordTokenValidityEndDate</span><span class="o">())</span>
	<span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">2017</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getPasswordHash</span><span class="o">())</span>
	<span class="o">.</span><span class="na">withFailMessage</span><span class="o">(</span><span class="s">"Password should not be changed"</span><span class="o">)</span>
	<span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"old-password-hash"</span><span class="o">);</span></code></pre></figure>

<p>Here we check three things:</p>

<ol>
  <li>New password reset token was generated and assigned to <code class="highlighter-rouge">resetPasswordToken</code>
 property</li>
  <li>Expiry date of password reset token was set correctly (token should be
 valid for the next 24 hours)</li>
  <li>Current user password was not changed</li>
</ol>

<p>Notice also that we use <code class="highlighter-rouge">withFailMessage</code> to provide additional
information in case our third assertion fails.
Without <code class="highlighter-rouge">withFailMessage</code> we would get following error:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">org.junit.ComparisonFailure: 
Expected :"old-password-hash"
Actual   :"xxx"</code></pre></figure>

<p>With <code class="highlighter-rouge">withFailMessage</code> we get:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">java.lang.AssertionError: Password should not be changed</code></pre></figure>

<h4 id="merciless-refactoring">Merciless refactoring</h4>

<p>Right now both of our tests pass, but we see a lot of code duplication
between them. Now it is a good time to extract common parts of both
tests into <code class="highlighter-rouge">setUp</code> method and to create some fields in our test class:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImplTestAfterRefactoring</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">DateTimeProvider</span> <span class="n">dateTimeProvider</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">CryptoService</span> <span class="n">cryptoService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">NotificationService</span> <span class="n">notificationService</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">UserServiceImpl</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">userRepository</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">UserRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">dateTimeProvider</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">DateTimeProvider</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">cryptoService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">CryptoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">notificationService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">NotificationService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserServiceImpl</span><span class="o">(</span>
                <span class="n">userRepository</span><span class="o">,</span>
                <span class="n">dateTimeProvider</span><span class="o">,</span>
                <span class="n">cryptoService</span><span class="o">,</span>
                <span class="n">notificationService</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startResetPasswordProcess_givenEmailNotBelongingToAnyUser_doesNothing</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// arrange</span>
        <span class="n">when</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="s">"unknown@example.com"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="c1">// act</span>
        <span class="n">userService</span><span class="o">.</span><span class="na">startResetPasswordProcess</span><span class="o">(</span><span class="s">"unknown@example.com"</span><span class="o">);</span>

        <span class="c1">// assert</span>
        <span class="n">verify</span><span class="o">(</span><span class="n">notificationService</span><span class="o">,</span> <span class="n">never</span><span class="o">())</span>
                <span class="o">.</span><span class="na">sendResetPasswordNotification</span><span class="o">(</span><span class="n">any</span><span class="o">());</span>

        <span class="n">verify</span><span class="o">(</span><span class="n">notificationService</span><span class="o">,</span> <span class="n">never</span><span class="o">())</span>
                <span class="o">.</span><span class="na">sendPasswordChangedConfirmation</span><span class="o">(</span><span class="n">anyString</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">startResetPasswordProcess_givenEmailOfExistingUser_generatesToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// arrange</span>
        <span class="n">User</span> <span class="n">joe</span> <span class="o">=</span> <span class="n">Fixtures</span><span class="o">.</span><span class="na">userJoe</span><span class="o">();</span>

        <span class="n">when</span><span class="o">(</span><span class="n">userRepository</span><span class="o">.</span><span class="na">findByEmailAddress</span><span class="o">(</span><span class="s">"joe@example.com"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">joe</span><span class="o">);</span>

        <span class="n">when</span><span class="o">(</span><span class="n">dateTimeProvider</span><span class="o">.</span><span class="na">now</span><span class="o">())</span>
                <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">2017</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>

        <span class="c1">// act</span>
        <span class="n">userService</span><span class="o">.</span><span class="na">startResetPasswordProcess</span><span class="o">(</span><span class="s">"joe@example.com"</span><span class="o">);</span>

        <span class="c1">// assert</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getResetPasswordToken</span><span class="o">())</span>
                <span class="o">.</span><span class="na">isNotNull</span><span class="o">();</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getResetPasswordTokenValidityEndDate</span><span class="o">())</span>
                <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">LocalDateTime</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="mi">2017</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">joe</span><span class="o">.</span><span class="na">getPasswordHash</span><span class="o">())</span>
                <span class="o">.</span><span class="na">withFailMessage</span><span class="o">(</span><span class="s">"Password should not be changed"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"old-password-hash"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>After refactoring both dependencies and tested components are
now stored in fields of test class. 
JUnit calls any method annotated by <code class="highlighter-rouge">@Before</code> before executing each
of test methods contained in test class. 
This makes <code class="highlighter-rouge">setUp</code> method suitable place to initialize fields
that will be used by many tests.</p>

<p>Now you may be tempted to move initialization code to the test class
constructor, but don’t do that. Unit tests should be independent of
each other. One of the worst sins when writing unit tests is to write
a test that depends on some data created by other test methods. 
Such incorrect test may pass when we ran all tests but will
fail when run it alone. This is one of the worst things that may happen
when writing unit tests, and clearly shows that we do something wrong.
Instead every test should create it’s own test data and should use 
fresh Mockito stubs. Later you will appreciate this independence of
tests when you will try to run tests in parallel.</p>

<p>Unit tests often require some dummy data, instead of creating the
same object again and again in various tests we should group them
into library of test objects. Such library of test data is often called
a fixture. Since I expected that we will need <code class="highlighter-rouge">User</code> instance in other
test, I extracted code that created dummy user into <code class="highlighter-rouge">Fixtures</code> class:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Fixtures</span> <span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="n">User</span> <span class="nf">userJoe</span><span class="o">()</span> <span class="o">{</span>
	  <span class="n">User</span> <span class="n">joe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">();</span>

	  <span class="n">joe</span><span class="o">.</span><span class="na">setEmail</span><span class="o">(</span><span class="s">"joe@example.com"</span><span class="o">);</span>
	  <span class="n">joe</span><span class="o">.</span><span class="na">setPasswordHash</span><span class="o">(</span><span class="s">"old-password-hash"</span><span class="o">);</span>
	  <span class="n">joe</span><span class="o">.</span><span class="na">setResetPasswordToken</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
	  <span class="n">joe</span><span class="o">.</span><span class="na">setResetPasswordTokenValidityEndDate</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

	  <span class="k">return</span> <span class="n">joe</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h5 id="terminology">Terminology</h5>

<p>When reading about unit testing you may encounter terms <em>fake</em>, <em>mock</em> and <em>stub</em>.
Fake is any object that is used only by test code, fake may be implemented as
concrete class like <code class="highlighter-rouge">UserRepositoryStub</code> or as anonymous class generated at runtime.
In this last category we find all dummy implementations generated by Mockito.</p>

<p>Fakes can be divided into two groups stubs and mocks. Form practical point of
view we use mock to test interactions, and stubs to provide dummy data or
do-nothing implementation. We used <code class="highlighter-rouge">NotificationService</code> as a mock in our first
test because we used it to assert that no interaction took place (no message was
send to user). On the other hand all dummy implementations generated
by Mockito for <code class="highlighter-rouge">UserRepository</code>, <code class="highlighter-rouge">DateTimeProvider</code> etc. are examples of stubs.</p>

<p>More information about difference between mocks and stubs
can be found in Martin Fowler article
<a href="https://www.martinfowler.com/articles/mocksArentStubs.html">Mocks aren’t stubs</a>.</p>

<h5 id="code-coverage">Code coverage</h5>

<p>When unit testing it is important to test all execution paths in our code.
Sometimes we may be convinced that we covered all corner cases only to
find out (usually in production) that we overlooked testing some obscure conditions.
In such situation after fixing bug, we should add missing test.
But we could do better, almost any popular Java IDE can measure
and show us code coverage of tested component. IDE can usually highlight
in red lines that were not tested, for example here how it looks like in IntelliJ:
<img src="assets/images/2017-02-19/code_cov.png" alt="Code coverage in IntelliJ" />
Greenish bar next to line number tells us that line of code was <em>executed</em>
when running unit tests (being executed doesn’t automatically mean that
the line of code is well tested, it is only a heuristic). On the other hand 
red bar tells that lines of code was not reached by tests and certainly is not tested.</p>

<p>When we are at it, you may heard that the higher code coverage the better.
Having 100% code coverage is impossible in any reasonable sized enterprise application.
There is an ongoing debate about how much code coverage is enough.
For me code coverage is just a tool that I use to check that I tested
all execution paths in code and nothing more.</p>

<h5 id="its-your-turn-now">It’s your turn now</h5>

<p>Right now we have only two tests for our <code class="highlighter-rouge">UserServiceImpl</code> component,
of course it is not enough to assure us that all of the business requirements
were fulfilled. When I tested <code class="highlighter-rouge">UserServiceImpl</code> I wrote seven more tests:</p>

<ul>
  <li><code class="highlighter-rouge">startResetPasswordProcess_givenEmailOfExistingUser_sendsNotificationToUser</code></li>
  <li><code class="highlighter-rouge">finishResetPasswordProcess_noUserHasSpecifiedEmail_doesNothing</code></li>
  <li><code class="highlighter-rouge">finishResetPasswordProcess_userHasNoTokenSet_doesNothing</code></li>
  <li><code class="highlighter-rouge">finishResetPasswordProcess_tokenExpired_doesNothing</code></li>
  <li><code class="highlighter-rouge">finishResetPasswordProcess_tokenNotMatch_doesNothing</code></li>
  <li><code class="highlighter-rouge">finishResetPasswordProcess_validToken_changesPassword</code></li>
  <li><code class="highlighter-rouge">finishResetPasswordProcess_validToken_sendsConfirmationToUser</code></li>
</ul>

<p>and only now I am certain that <code class="highlighter-rouge">UserServiceImpl</code> works correctly.</p>

<p>You may find source code for all these tests (with other goodies)
<a href="https://github.com/marcin-chwedczuk/mockito-unit-test-demo">HERE</a>.
But before you look at what I wrote, please try to implement these tests
yourself and then compare your code with mine. I am certain that you will
learn more this way.</p>

<p>Thanks for reading. If you liked this post please start my Github repository.
And see you soon again!</p>


	  ]]></description>
	</item>

	<item>
	  <title>Hello, Hibernate Validator</title>
	  <link>//hello-hibernate-validator</link>
	  <author></author>
	  <pubDate>2017-02-05T01:00:00+01:00</pubDate>
	  <guid>//hello-hibernate-validator</guid>
	  <description><![CDATA[
	     <p>In every enterprise application there is a need for
validation. You may want to validate data send by user to
your REST service, messages coming to your application from some
other system, or your own entities before saving them to database.</p>

<p>Standard
<a href="http://beanvalidation.org/1.0/spec">JSR 303</a>
defines API for validating Java Beans without tying us to any
particular implementation.
Nevertheless some implementations are more polished than others,
and subject of this post -
Hibernate Validator is considered one of the best.</p>

<h4 id="project-setup">Project setup</h4>

<p>Before we can use Hibernate Validator we must do
some groundwork.</p>

<h5 id="maven-dependencies">Maven dependencies</h5>

<p>To use Hibernate Validator we need following Maven dependencies:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.hibernate<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>hibernate-validator<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.3.4.Final<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>javax.el<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>el-api<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.glassfish.web<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>javax.el<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<p>Hibernate Validator uses Java Unified Expression Language (JavaEL)
to format validation messages. When your application runs
inside JEE container, container already provides JavaEL 
implementation.
Since we want to create a command line application we must provide 
JavaEL implementation ourselves and that’s the reason
why we included <code class="highlighter-rouge">javax.el:el-api</code> and <code class="highlighter-rouge">org.glassfish.web:javax.el</code> as
dependencies.</p>

<p>Later on to demonstrate all features of Hibernate Validator we will need
Spring DI container and <code class="highlighter-rouge">commons-beanutils</code> library:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>commons-beanutils<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>commons-beanutils<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.9.3<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>4.3.5.RELEASE<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure>

<h5 id="obtaining-validator-instance">Obtaining <code class="highlighter-rouge">Validator</code> instance</h5>

<p>After all these preparations we are ready to create <code class="highlighter-rouge">Validator</code>
instance:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">javax.validation.Validation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.validation.Validator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Validator</span> <span class="n">validator</span> <span class="o">=</span> <span class="n">Validation</span>
                              <span class="o">.</span><span class="na">buildDefaultValidatorFactory</span><span class="o">()</span>
                              <span class="o">.</span><span class="na">getValidator</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>Note that we don’t have any reference to Hibernate Validator in
our code, instead we are relying on classes and interfaces defined in
JSR 303 (Bean Validation).
This is very similar to how JDBC providers works.</p>

<p>Returned <code class="highlighter-rouge">Validator</code> instance is thread safe and may be assigned to
static field or registered as a singleton in DI container for later use.</p>

<h4 id="validating-beans">Validating beans</h4>

<h5 id="property-level-constraints">Property level constraints</h5>

<p>The easiest way to define validation rules for a bean
is to use JSR 303 annotations.
We may put annotations on both fields and getters, for example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@NotNull</span>           
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">// or:</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@NotNull</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>             
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>                      
    <span class="o">}</span>                                     
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>    
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>                 
    <span class="o">}</span>                                     
<span class="o">}</span></code></pre></figure>

<p>We should prefer putting annotations on getters since this will
allow for greater flexibility when later we will want to
change our beans.
Said that, to conserve space in this post I will
put annotations on fields from now on.</p>

<p>Here is a simple bean representing a person,
annotated with JSR 303 constraints:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Length</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">1</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Length</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">1</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">surname</span><span class="o">;</span>

    <span class="nd">@Range</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">200</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
  
    <span class="c1">// getters, setters </span>
<span class="o">}</span></code></pre></figure>

<p>Validation rules should be self evident. There is nothing fancy -
we check that a person must have a non empty name and a non empty
surname, and that an age of a person falls within a range of 1 and 200.</p>

<p>Then we may use Hibernate Validator to check if 
a <code class="highlighter-rouge">Person</code> instance is valid:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Validator</span> <span class="n">validator</span> <span class="o">=</span> <span class="n">Validation</span>
       <span class="o">.</span><span class="na">buildDefaultValidatorFactory</span><span class="o">()</span>
       <span class="o">.</span><span class="na">getValidator</span><span class="o">();</span>

<span class="n">Person</span> <span class="n">joe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"Joe"</span><span class="o">);</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setSurname</span><span class="o">(</span><span class="s">"Doe"</span><span class="o">);</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">43</span><span class="o">);</span>

<span class="n">Set</span><span class="o">&lt;</span><span class="n">ConstraintViolation</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;&gt;</span> <span class="n">constraintViolations</span> <span class="o">=</span>
       <span class="n">validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">joe</span><span class="o">);</span>

<span class="k">assert</span> <span class="n">constraintViolations</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// yeah, no errors</span></code></pre></figure>

<p>In rare cases when <code class="highlighter-rouge">Person</code> is invalid, Hibernate Validator
provides us with all necessary information about what
properties and values are wrong:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Person</span> <span class="n">joe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setSurname</span><span class="o">(</span><span class="s">"Doe"</span><span class="o">);</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>

<span class="n">Set</span><span class="o">&lt;</span><span class="n">ConstraintViolation</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;&gt;</span> <span class="n">constraintViolations</span> <span class="o">=</span>
       <span class="n">validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">joe</span><span class="o">);</span>

<span class="k">for</span> <span class="o">(</span><span class="n">ConstraintViolation</span><span class="o">&lt;?&gt;</span> <span class="nl">violation:</span> <span class="n">constraintViolations</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%10s | %30s | is %10s%n"</span><span class="o">,</span>
           <span class="n">violation</span><span class="o">.</span><span class="na">getPropertyPath</span><span class="o">(),</span>
           <span class="n">violation</span><span class="o">.</span><span class="na">getMessage</span><span class="o">(),</span>
           <span class="n">violation</span><span class="o">.</span><span class="na">getInvalidValue</span><span class="o">()</span>
           <span class="o">);</span>
<span class="o">}</span>
<span class="c1">// OUTPUT:</span>
<span class="c1">//       age |      must be between 1 and 200 | is       1024</span>
<span class="c1">//      name |                may not be null | is       null</span></code></pre></figure>

<h5 id="bean-level-constraints">Bean level constraints</h5>

<p>Some validation rules may be expressed only by using
values of two or more properties, for such rules 
Hibernate Validator provides class-level constrains.
Returning to our <code class="highlighter-rouge">Person</code> example, suppose that we want to add
two new properties to <code class="highlighter-rouge">Person</code>: <code class="highlighter-rouge">dateOfBirth</code> and <code class="highlighter-rouge">dateOfDeath</code>, with
condition that <code class="highlighter-rouge">dateOfBirth</code> cannot be later than <code class="highlighter-rouge">dateOfDeath</code>
(when both dates are present):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="n">LocalDate</span> <span class="n">dateOfBirth</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">LocalDate</span> <span class="n">dateOfDeath</span><span class="o">;</span>
    
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre></figure>

<p>We can express our rule using proprietary (not included in JSR 303)
class-level <code class="highlighter-rouge">@ScriptAssert</code> annotation:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.ScriptAssert</span><span class="o">;</span>

<span class="nd">@ScriptAssert</span><span class="o">(</span><span class="n">lang</span> <span class="o">=</span> <span class="s">"javascript"</span><span class="o">,</span>
        <span class="n">script</span><span class="o">=</span><span class="s">"_.dateOfBirth == null || _.dateOfDeath == null || _.dateOfBirth &lt;= _.dateOfDeath"</span><span class="o">,</span>
        <span class="n">alias</span><span class="o">=</span><span class="s">"_"</span><span class="o">,</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">"date of death cannot be before date of birth"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
   <span class="c1">// ...</span>
<span class="o">}</span> </code></pre></figure>

<p>Here I decided to use JavaScript scripting engine (<code class="highlighter-rouge">lang = "javascript"</code>)
because it
is already shipped with Java SE, moreover JavaScript syntax should be
familiar to any Java developer. Hibernate Validator supports
any implementation adhering to JSR 223 standard
(scripting for the Java platform).</p>

<p>JavaScript expression used as value of <code class="highlighter-rouge">script</code> argument:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">_</span><span class="p">.</span><span class="nx">dateOfBirth</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> 
   <span class="nx">_</span><span class="p">.</span><span class="nx">dateOfDeath</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> 
   <span class="nx">_</span><span class="p">.</span><span class="nx">dateOfBirth</span> <span class="o">&lt;=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">dateOfDeath</span></code></pre></figure>

<p>must <em>always</em> return either <code class="highlighter-rouge">true</code> when validation rule is
fullfiled or <code class="highlighter-rouge">false</code>.
We must also take care of handling <code class="highlighter-rouge">null</code> values otherwise we may
get pesky <code class="highlighter-rouge">javax.script.ScriptException</code>.</p>

<p>Inside <code class="highlighter-rouge">script</code> we may refer to currently validated bean by name of <code class="highlighter-rouge">_this</code>,
or by name of our choosing if we set <code class="highlighter-rouge">alias</code> argument like we do in
our example.</p>

<p><code class="highlighter-rouge">@ScriptAssert</code> is a duct tape of validation. You should
use it only when performance is not a concern, and you must
provide a solution quickly. In most cases you should prefer
to write you own constraint and validator. Anyway <code class="highlighter-rouge">@ScriptAssert</code> is
a great example of class-level constraint.</p>

<h5 id="validating-child-beans">Validating child beans</h5>

<p>To demonstrate parent-child bean validation we will
add <code class="highlighter-rouge">Address</code> to <code class="highlighter-rouge">Person</code> class.
<code class="highlighter-rouge">Address</code> will be optional so not every <code class="highlighter-rouge">Person</code> instance will have one,
we only require that if a <code class="highlighter-rouge">Person</code> has an address it must be a
valid one.
<code class="highlighter-rouge">Address</code> will be represented by the following bean:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="o">{</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">street</span><span class="o">;</span>

    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">zipCode</span><span class="o">;</span>

    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">city</span><span class="o">;</span>

    <span class="c1">// getter,setters</span>
<span class="o">}</span></code></pre></figure>

<p>Also we must add <code class="highlighter-rouge">address</code> property to <code class="highlighter-rouge">Person</code> bean:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@Valid</span>
    <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p><code class="highlighter-rouge">@Valid</code> annotation that we put on <code class="highlighter-rouge">address</code> field
tells Hibernate Validator that
when validating a <code class="highlighter-rouge">Person</code> the <code class="highlighter-rouge">Address</code> should also be
validated, but only when address is provided (<code class="highlighter-rouge">address</code> is non null).
If we require that a <code class="highlighter-rouge">Person</code> must always have an address we may use
<code class="highlighter-rouge">@NotNull</code> to enforce that rule:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@NotNull</span>
    <span class="nd">@Valid</span>
    <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>Now when validating person with an invalid address we get:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// ...</span>
<span class="n">Address</span> <span class="n">joeHomeAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Address</span><span class="o">();</span>
<span class="n">joeHomeAddress</span><span class="o">.</span><span class="na">setCity</span><span class="o">(</span><span class="s">"Warsaw"</span><span class="o">);</span>
<span class="n">joeHomeAddress</span><span class="o">.</span><span class="na">setZipCode</span><span class="o">(</span><span class="s">"00-120"</span><span class="o">);</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">joeHomeAddress</span><span class="o">);</span>

<span class="n">validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">joe</span><span class="o">);</span>
<span class="c1">// CONSTRAINT VIOLATIONS:</span>
<span class="c1">// address.street |               may not be empty | is       null</span></code></pre></figure>

<h5 id="validating-collections">Validating collections</h5>

<p>To demonstrate how collection validation works
we will add a list of contacts
to <code class="highlighter-rouge">Person</code> bean:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@Valid</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Contact</span><span class="o">&gt;</span> <span class="n">contacts</span><span class="o">;</span>
    <span class="c1">// getters,setters,...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Contact</span> <span class="o">{</span> <span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmailContact</span> <span class="kd">extends</span> <span class="n">Contact</span> <span class="o">{</span>
    <span class="nd">@Email</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EmailContact</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">EmailContact</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getEmail</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">email</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="n">email</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhoneContact</span> <span class="kd">extends</span> <span class="n">Contact</span> <span class="o">{</span>
    <span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">"\\d{3}-\\d{3}-\\d{3}"</span><span class="o">,</span>
             <span class="n">message</span> <span class="o">=</span> <span class="s">"invalid phone number"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">phoneNumber</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PhoneContact</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">PhoneContact</span><span class="o">(</span><span class="n">String</span> <span class="n">phoneNumber</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">phoneNumber</span> <span class="o">=</span> <span class="n">phoneNumber</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPhoneNumber</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">phoneNumber</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPhoneNumber</span><span class="o">(</span><span class="n">String</span> <span class="n">phoneNumber</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">phoneNumber</span> <span class="o">=</span> <span class="n">phoneNumber</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Again we used <code class="highlighter-rouge">@Valid</code> annotation to tell Hibernate Validator to
validate all non null beans contained in <code class="highlighter-rouge">contacts</code> collection.
Now we may check if all <code class="highlighter-rouge">Person</code> contacts are valid:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">joe</span><span class="o">.</span><span class="na">setContacts</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">EmailContact</span><span class="o">(</span><span class="s">"joe@example.com"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">PhoneContact</span><span class="o">(</span><span class="s">"123-123-123"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">EmailContact</span><span class="o">(</span><span class="s">"invalid_email"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">PhoneContact</span><span class="o">(</span><span class="s">"invali_phone"</span><span class="o">)</span>
<span class="o">));</span>

<span class="n">validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">joe</span><span class="o">);</span>
<span class="c1">// CONSTRAINT VIOLATIONS:</span>
<span class="c1">// contacts[3].phoneNumber |           invalid phone number  | is invali_phone</span>
<span class="c1">// contacts[2].email       | not a well-formed email address | is invalid_email</span></code></pre></figure>

<p>Unfortunately there is no build-in annotation that would protect
us from collections containing <code class="highlighter-rouge">null</code>s:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">joe</span><span class="o">.</span><span class="na">setContacts</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="kc">null</span><span class="o">));</span>
<span class="k">assert</span> <span class="n">validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">joe</span><span class="o">).</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span></code></pre></figure>

<p>To fix that problem we must write a custom constraint ourselves.</p>

<h5 id="customizing-validation-messages">Customizing validation messages</h5>

<p>The easiest way to customize validation message is to
set it explicitly via 
<code class="highlighter-rouge">message</code> parameter:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Range</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">200</span><span class="o">,</span> 
    <span class="n">message</span> <span class="o">=</span> <span class="s">"person age must be between 1 and 200 years"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span></code></pre></figure>

<p>This approach is inflexible and you should avoid it, instead
try to load validation messages from application resources.
Hibernate Validator by default will load validation messages from
<code class="highlighter-rouge">resources/ValidationMessages.properties</code> file.
We may use this file to either add new validation message or
customize existing:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight"># Override existing message
org.hibernate.validator.constraints.Range.message=${validatedValue} is not in range (min: {min}, max: {max})

# Create new message
invalid_person_age=person age must be between 1 and 200 years </code></pre></figure>

<p>Then we may use are new message:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Range</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">1</span><span class="o">,</span> <span class="n">max</span><span class="o">=</span><span class="mi">200</span><span class="o">,</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"{invalid_person_age}"</span><span class="o">)</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span></code></pre></figure>

<h4 id="extending-hibernate-validator">Extending Hibernate Validator</h4>

<h5 id="constraint-composition">Constraint composition</h5>

<p>Earlier we used the following code to validate phone number:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">"\\d{3}-\\d{3}-\\d{3}"</span><span class="o">,</span>
         <span class="n">message</span> <span class="o">=</span> <span class="s">"invalid phone number"</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">phoneNumber</span><span class="o">;</span></code></pre></figure>

<p>We certainly don’t want to repeat this annotation with regex expression and
message accross all codebase, that would violate 
<a href="https://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY principle</a>.
On the other hand the following code validated person name:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@NotNull</span>
<span class="nd">@Length</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">1</span><span class="o">)</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span></code></pre></figure>

<p>Here we see that to validate name we need two constraints, again
repeating two constraints in various DTO’s is not a receipt for
a good code.</p>

<p>To solve above problems JSR 303 introduces constraint composition.
In short you create a new constraint annotation and put
on it all required constraints, you may also adjust
message, payload and/or groups to which constraint belongs.
For example we may create <code class="highlighter-rouge">ValidPhoneNumber</code> constraint:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Pattern</span><span class="o">(</span><span class="n">regexp</span> <span class="o">=</span> <span class="s">"\\d{3}-\\d{3}-\\d{3}"</span><span class="o">)</span>
<span class="nd">@ReportAsSingleViolation</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="o">})</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ValidPhoneNumber</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">"phone number should be in format 999-999-999"</span><span class="o">;</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>
    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>
<span class="o">}</span></code></pre></figure>

<p>And then use it accross our codebase:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhoneContact</span> <span class="kd">extends</span> <span class="n">Contact</span> <span class="o">{</span>
    <span class="nd">@ValidPhoneNumber</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">phoneNumber</span><span class="o">;</span>
    <span class="c1">//...</span>
<span class="o">}</span></code></pre></figure>

<p>Not only this adheres to DRY princible but our code
is now more readable.</p>

<p>When we put multiple constraints on composed constraint:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@NotNull</span>
<span class="nd">@Length</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">1</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="o">{</span> <span class="o">})</span>
<span class="nd">@Documented</span>
<span class="c1">// @ReportAsSingleViolation</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">ValidPersonName</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">"person must have a name"</span><span class="o">;</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>
    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>
<span class="o">}</span></code></pre></figure>

<p>And then use it on a field:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@ValidPersonName</span>
<span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span></code></pre></figure>

<p>Each of composing constrains will be reported independently:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Person</span> <span class="n">joe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
<span class="c1">//       name | length must be between 1 and 2147483647 | is     </span>

<span class="n">joe</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="c1">//       name |                may not be null | is       null</span></code></pre></figure>

<p>We may add <code class="highlighter-rouge">@ReportAsSingleViolation</code> annotation to our
composed constrain to report all violations as a single error.
With <code class="highlighter-rouge">@ReportAsSingleViolation</code> we get:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Person</span> <span class="n">joe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
<span class="c1">//       name |        person must have a name | is       </span>
<span class="n">joe</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
<span class="c1">//       name |        person must have a name | is       null</span></code></pre></figure>

<p>Notice that this time message was taken from composed constraint.</p>

<h5 id="using-payloads">Using payloads</h5>

<p>We may use payloads to pass some additional informations
with validation errors. Canonical example of using payloads is
to differentiate between errors and warnings.</p>

<p>First we must define our payload values:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">javax.validation.Payload</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SEVERITY</span> <span class="o">{</span>
    <span class="kd">interface</span> <span class="nc">WARNING</span> <span class="kd">extends</span> <span class="n">Payload</span> <span class="o">{</span> <span class="o">}</span>
    <span class="kd">interface</span> <span class="nc">ERROR</span> <span class="kd">extends</span> <span class="n">Payload</span> <span class="o">{</span> <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Then we may use them with constraints:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">io.mc.validationdemo.constraints.SEVERITY.ERROR</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.mc.validationdemo.constraints.SEVERITY.WARNING</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hibernate.validator.constraints.NotBlank</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SeverityDTO</span> <span class="o">{</span>
    <span class="nd">@NotBlank</span><span class="o">(</span><span class="n">payload</span> <span class="o">=</span> <span class="n">ERROR</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">important</span><span class="o">;</span>
    
    <span class="nd">@NotBlank</span><span class="o">(</span><span class="n">payload</span> <span class="o">=</span> <span class="n">WARNING</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">unimportant</span><span class="o">;</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre></figure>

<p>Finally we may use them to decide if given <code class="highlighter-rouge">ConstraintViolation</code>
is warning or error:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">isWarning</span><span class="o">(</span><span class="n">ConstraintViolation</span><span class="o">&lt;?&gt;</span> <span class="n">violation</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">isWarning</span> <span class="o">=</span> <span class="n">violation</span><span class="o">.</span><span class="na">getConstraintDescriptor</span><span class="o">()</span>
            <span class="o">.</span><span class="na">getPayload</span><span class="o">()</span>
            <span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">SEVERITY</span><span class="o">.</span><span class="na">WARNING</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">isWarning</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>I am certain that you will find some creative usages of payloads
in you application.</p>

<h5 id="creating-new-constraints">Creating new constraints</h5>

<p>To demonstrate how to create a new constraint,
we will create <code class="highlighter-rouge">@NotContain</code> validation rule that
checks that <code class="highlighter-rouge">String</code> doesn’t contains specified value.</p>

<p>We will start by creating annotation (here it is best
to follow example from <a href="https://docs.jboss.org/hibernate/stable/validator/reference/en-US/html_single/#validator-customconstraints-constraintannotation">official documentation</a>):</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Target</span><span class="o">({</span><span class="n">FIELD</span><span class="o">,</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
<span class="nd">@Documented</span>
<span class="nd">@Constraint</span><span class="o">(</span><span class="n">validatedBy</span> <span class="o">=</span> <span class="n">NotContainValidator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="n">NotContain</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">message</span><span class="o">()</span> <span class="k">default</span> <span class="s">"{validation.NotContain}"</span><span class="o">;</span>
    <span class="n">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">groups</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>
    <span class="n">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">Payload</span><span class="o">&gt;[]</span> <span class="nf">payload</span><span class="o">()</span> <span class="k">default</span> <span class="o">{</span> <span class="o">};</span>
    <span class="n">String</span> <span class="nf">value</span><span class="o">();</span>

    <span class="nd">@Target</span><span class="o">({</span> <span class="n">FIELD</span><span class="o">,</span> <span class="n">METHOD</span><span class="o">,</span> <span class="n">ANNOTATION_TYPE</span> <span class="o">})</span>
    <span class="nd">@Retention</span><span class="o">(</span><span class="n">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@interface</span> <span class="n">List</span> <span class="o">{</span>
        <span class="n">NotContain</span><span class="o">[]</span> <span class="nf">value</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Then we must implement <code class="highlighter-rouge">NotContainValidator</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotContainValidator</span> 
    <span class="kd">implements</span> <span class="n">ConstraintValidator</span><span class="o">&lt;</span><span class="n">NotContain</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">bannedPhrase</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">NotContain</span> <span class="n">constraintAnnotation</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bannedPhrase</span> <span class="o">=</span> <span class="n">constraintAnnotation</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isValid</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">,</span> <span class="n">ConstraintValidatorContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">isValid</span> <span class="o">=</span>
            <span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">value</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">bannedPhrase</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">isValid</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Then we should define our validation message
in <code class="highlighter-rouge">resources/ValidationMessages.properties</code> file, and we are done:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="nd">@ValidPersonName</span>
    <span class="nd">@NotContain</span><span class="o">(</span><span class="s">"f**k"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="n">Person</span> <span class="n">joe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
<span class="n">joe</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"f**k"</span><span class="o">);</span>

<span class="n">validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">joe</span><span class="o">);</span>
<span class="c1">// VIOLATED CONSTRAINTS:</span>
<span class="c1">// name | Property should not contain f**k | is       f**k</span></code></pre></figure>

<h5 id="value-unwrappers">Value unwrappers</h5>

<p>Sometimes we want to validate value that is contained in some other
type. For example we may want to validate a <code class="highlighter-rouge">String</code> contained
in <code class="highlighter-rouge">Optional&lt;String&gt;</code>.
This is possible in Hibernate Validator thanks to value unwrappers.</p>

<p>Hibernate Validator out of the box supports <code class="highlighter-rouge">Optional&lt;T&gt;</code> type, so
for a sake of example we will create our own “wrapper” type:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">T</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">T</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setValue</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now we may use our wapper type in DTOs:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UnwrappingDTO</span> <span class="o">{</span>
    <span class="nd">@Length</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">3</span><span class="o">,</span><span class="n">max</span><span class="o">=</span><span class="mi">10</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Box</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@Min</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Box</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">age</span><span class="o">;</span>

    <span class="c1">// getters, setters </span>
<span class="o">}</span></code></pre></figure>

<p>If we try to validate <code class="highlighter-rouge">UnwrappingDTO</code> instance we will get
an exception:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">javax.validation.UnexpectedTypeException: HV000030: 
    No validator could be found for constraint 'Length' 
    validating type 'Box&lt;String&gt;'.</code></pre></figure>

<p>To make validation work again we must create are
own type unwrapper:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BoxUnwrapper</span> <span class="kd">extends</span> <span class="n">ValidatedValueUnwrapper</span><span class="o">&lt;</span><span class="n">Box</span><span class="o">&lt;?&gt;&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">handleValidatedValue</span><span class="o">(</span><span class="n">Box</span><span class="o">&lt;?&gt;</span> <span class="n">property</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">property</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Type</span> <span class="nf">getValidatedValueType</span><span class="o">(</span><span class="n">Type</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// return generic parameter T of Box&lt;T&gt;</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;)</span>
                <span class="o">((</span><span class="n">ParameterizedType</span><span class="o">)</span><span class="n">type</span><span class="o">).</span><span class="na">getActualTypeArguments</span><span class="o">()[</span><span class="mi">0</span><span class="o">];</span>

        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>And register it in Hibernate Validatior framework:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Validator</span> <span class="n">validator</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="na">byProvider</span><span class="o">(</span><span class="n">HibernateValidator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">configure</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addValidatedValueHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">BoxUnwrapper</span><span class="o">())</span>
        <span class="o">.</span><span class="na">buildValidatorFactory</span><span class="o">()</span>
        <span class="o">.</span><span class="na">getValidator</span><span class="o">();</span></code></pre></figure>

<p>The last thing that we should do, is to annotate <code class="highlighter-rouge">Box&lt;T&gt;</code> properties with
<code class="highlighter-rouge">@UnwrapValidatedValue</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Length</span><span class="o">(</span><span class="n">min</span><span class="o">=</span><span class="mi">3</span><span class="o">,</span><span class="n">max</span><span class="o">=</span><span class="mi">10</span><span class="o">)</span>
<span class="nd">@UnwrapValidatedValue</span>
<span class="kd">private</span> <span class="n">Box</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">name</span><span class="o">;</span>

<span class="nd">@Min</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nd">@UnwrapValidatedValue</span>
<span class="kd">private</span> <span class="n">Box</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">age</span><span class="o">;</span></code></pre></figure>

<p>And now we can validate <code class="highlighter-rouge">Box</code>ed values, yay!</p>

<h5 id="integrating-hibernate-validator-with-spring-di">Integrating Hibernate Validator with Spring DI</h5>

<p>This section shows how to quickly integrate Hibernate Validator
with Spring. This is not the offical way of how you should integrate
with DI, just a quick and dirty solution that you may find helpful.
You have been warned. Also remember that Spring provides it’s
own validation framework, fully complaint with JSR 303 and called
<a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/html/validation.html#validation-beanvalidation">Spring Validation</a>.</p>

<p>First we must create validator factory and register it in Spring
and in Hibernate Validator framework:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringConstrainValidationFactory</span> 
<span class="kd">implements</span> <span class="n">ConstraintValidatorFactory</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">ApplicationContext</span> <span class="n">context</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span> <span class="kd">extends</span> <span class="n">ConstraintValidator</span><span class="o">&lt;?,</span> <span class="o">?&gt;&gt;</span> <span class="n">T</span> <span class="nf">getInstance</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">getPackage</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"javax.validation"</span><span class="o">)</span> <span class="o">||</span>
            <span class="n">key</span><span class="o">.</span><span class="na">getPackage</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"org.hibernate.validator"</span><span class="o">))</span>
        <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// create standard validators by calling</span>
                <span class="c1">// default constructor</span>
                <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="c1">// Use Spring to create validator bean</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">releaseInstance</span><span class="o">(</span><span class="n">ConstraintValidator</span><span class="o">&lt;?,</span> <span class="o">?&gt;</span> <span class="n">instance</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// DO NOTHING</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>And in application configuration we should have:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span><span class="o">(</span><span class="s">"your.package.name"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Validator</span> <span class="nf">getHibernateValidator</span><span class="o">(</span>
        <span class="n">SpringConstrainValidationFactory</span> <span class="n">factory</span><span class="o">)</span>
    <span class="o">{</span>
       <span class="n">Validator</span> <span class="n">validatorEx</span> <span class="o">=</span> <span class="n">Validation</span><span class="o">.</span><span class="na">byProvider</span><span class="o">(</span><span class="n">HibernateValidator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">configure</span><span class="o">()</span>
                <span class="o">.</span><span class="na">addValidatedValueHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">BoxUnwrapper</span><span class="o">())</span>
                <span class="c1">// register Spring based validator factory</span>
                <span class="o">.</span><span class="na">constraintValidatorFactory</span><span class="o">(</span><span class="n">factory</span><span class="o">)</span>
                <span class="o">.</span><span class="na">buildValidatorFactory</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getValidator</span><span class="o">();</span>

       <span class="k">return</span> <span class="n">validatorEx</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Also do not forget to mark validators as <code class="highlighter-rouge">@Component</code>, now we may
use dependency injection inside validators.</p>


	  ]]></description>
	</item>

	<item>
	  <title>Comparing with nullsFirst and nullsLast</title>
	  <link>//comparing-with-nullsFirst-and-nullsLast</link>
	  <author></author>
	  <pubDate>2017-01-14T01:00:00+01:00</pubDate>
	  <guid>//comparing-with-nullsFirst-and-nullsLast</guid>
	  <description><![CDATA[
	     <p>Sorting in Java is easy:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Data</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">value</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Data</span><span class="o">(</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
 
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Data(%s)"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">List</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span> <span class="n">listOfData</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
          <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"foo"</span><span class="o">),</span>
          <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"bar"</span><span class="o">),</span>
          <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"nyu"</span><span class="o">));</span>
 
   <span class="n">listOfData</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">comparing</span><span class="o">(</span><span class="nl">Data:</span><span class="o">:</span><span class="n">getValue</span><span class="o">));</span>
   <span class="n">listOfData</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//OUTPUT:</span>
<span class="c1">// Data(bar)</span>
<span class="c1">// Data(foo)</span>
<span class="c1">// Data(nyu)</span></code></pre></figure>

<p>…unless we try to sort a collection containing null values:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span> <span class="n">listOfData</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"foo"</span><span class="o">),</span>
       <span class="kc">null</span><span class="o">,</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"bar"</span><span class="o">),</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"nyu"</span><span class="o">));</span>
 
<span class="n">listOfData</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">comparing</span><span class="o">(</span><span class="nl">Data:</span><span class="o">:</span><span class="n">getValue</span><span class="o">));</span>
<span class="n">listOfData</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="c1">//OUTPUT:</span>
<span class="c1">// Exception in thread "main" java.lang.NullPointerException</span>
<span class="c1">//    at java.util.Comparator.lambda$comparing$77a9974f$1(Comparator.java:469)</span></code></pre></figure>

<p>Fortunately there is easy solution to this problem. But first we must
decide whenever we want <code class="highlighter-rouge">null</code>s to be first or last in sorted collection.
After we made our mind we may use nifty <code class="highlighter-rouge">nullsFirst</code> or <code class="highlighter-rouge">nullsLast</code>
decorators provided by <code class="highlighter-rouge">Comparator</code> interface:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Comparator</span><span class="o">.*;</span>
 
<span class="n">List</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span> <span class="n">listOfData</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"foo"</span><span class="o">),</span>
       <span class="kc">null</span><span class="o">,</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"bar"</span><span class="o">),</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"nyu"</span><span class="o">));</span>
 
<span class="n">listOfData</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">nullsFirst</span><span class="o">(</span><span class="n">comparing</span><span class="o">(</span><span class="nl">Data:</span><span class="o">:</span><span class="n">getValue</span><span class="o">)));</span>
<span class="n">listOfData</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="c1">//OUTPUT:</span>
<span class="c1">// null</span>
<span class="c1">// Data(bar)</span>
<span class="c1">// Data(foo)</span>
<span class="c1">// Data(nyu)</span></code></pre></figure>

<p><code class="highlighter-rouge">nullsFirst</code> is great example of decorator design pattern
(it adds functionality but doesn’t change interface).
<code class="highlighter-rouge">nullsFirst</code> works by wrapping provided comparator in code similar to:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">nullsFirst</span><span class="o">(</span><span class="n">Comparator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">comparator</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
 
    <span class="k">if</span> <span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
      <span class="k">return</span> <span class="mi">1</span><span class="o">;</span>
 
    <span class="c1">// a and b are not null here</span>
    <span class="k">return</span> <span class="n">comparator</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span>
  <span class="o">};</span>
<span class="o">}</span></code></pre></figure>

<p>Previous example works great unless we try to sort a collection
containing <code class="highlighter-rouge">Data(null)</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">List</span><span class="o">&lt;</span><span class="n">Data</span><span class="o">&gt;</span> <span class="n">listOfData</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"foo"</span><span class="o">),</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="kc">null</span><span class="o">),</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"bar"</span><span class="o">),</span>
       <span class="k">new</span> <span class="nf">Data</span><span class="o">(</span><span class="s">"nyu"</span><span class="o">));</span>

<span class="n">listOfData</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">nullsFirst</span><span class="o">(</span><span class="n">comparing</span><span class="o">(</span><span class="nl">Data:</span><span class="o">:</span><span class="n">getValue</span><span class="o">)));</span>
<span class="n">listOfData</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="c1">//OUTPUT:</span>
<span class="c1">// Exception in thread "main" java.lang.NullPointerException</span>
<span class="c1">//  at java.util.Comparator.lambda$comparing$77a9974f$1(Comparator.java:469)</span>
<span class="c1">//  at java.util.Comparators$NullComparator.compare(Comparators.java:83)</span></code></pre></figure>

<p>But do not despair <code class="highlighter-rouge">nullsFirst</code> can help us again:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">listOfData</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">nullsFirst</span><span class="o">(</span>
    <span class="n">comparing</span><span class="o">(</span><span class="nl">Data:</span><span class="o">:</span><span class="n">getValue</span><span class="o">,</span> <span class="n">nullsFirst</span><span class="o">(</span><span class="n">naturalOrder</span><span class="o">()))));</span>

<span class="n">listOfData</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
<span class="c1">//OUTPUT:</span>
<span class="c1">// Data(null)</span>
<span class="c1">// Data(bar)</span>
<span class="c1">// Data(foo)</span>
<span class="c1">// Data(nyu)</span></code></pre></figure>

<p>Ta da! It works but readability suffers greatly… You may ask what is
this thing:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">comparing</span><span class="o">(</span><span class="nl">Data:</span><span class="o">:</span><span class="n">getValue</span><span class="o">,</span> <span class="n">nullsFirst</span><span class="o">(</span><span class="n">naturalOrder</span><span class="o">()))</span></code></pre></figure>

<p>First: we use the following overload of <code class="highlighter-rouge">comparing</code> method:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">,</span> <span class="n">U</span><span class="o">&gt;</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">comparing</span><span class="o">(</span>
   <span class="n">Function</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">T</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="n">U</span><span class="o">&gt;</span> <span class="n">keyExtractor</span><span class="o">,</span>
   <span class="n">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="n">U</span><span class="o">&gt;</span>            <span class="n">keyComparator</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">c1</span><span class="o">,</span> <span class="n">c2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">keyComparator</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span>
          <span class="n">keyExtractor</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">c1</span><span class="o">),</span>
          <span class="n">keyExtractor</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">c2</span><span class="o">));</span>
<span class="o">}</span></code></pre></figure>

<p>Second: in our example <code class="highlighter-rouge">nullsFirst(naturalOrder())</code> is a comparator that can
compare nullable <code class="highlighter-rouge">String</code>s:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Comparator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">cmp</span> <span class="o">=</span> <span class="n">nullsFirst</span><span class="o">(</span><span class="n">naturalOrder</span><span class="o">());</span>
<span class="n">cmp</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="s">"zzz"</span><span class="o">);</span> <span class="c1">// -1</span>
<span class="n">cmp</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="s">"foo"</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>  <span class="c1">// 1</span></code></pre></figure>

<p>Now everything should be clear (I hope).</p>

<p>To sum up in this post we get to know two
little methods <code class="highlighter-rouge">nullsFirst</code> and <code class="highlighter-rouge">nullsLast</code>.
I admit that they are a bit unintuitive to use, but definitely worth
to bear in mind.</p>


	  ]]></description>
	</item>

	<item>
	  <title>Spring @Transactional cheat sheet</title>
	  <link>//spring-transactional-cheat-sheet</link>
	  <author></author>
	  <pubDate>2017-01-07T01:00:00+01:00</pubDate>
	  <guid>//spring-transactional-cheat-sheet</guid>
	  <description><![CDATA[
	     <h4 id="transactionalpropagation">@Transactional(propagation=…)</h4>

<dl>
  <dt><code class="highlighter-rouge">MANDATORY</code></dt>
  <dd>Method must run within transaction. If there is no
currently active transaction going on an exception is thrown.</dd>
  <dt><code class="highlighter-rouge">REQUIRED</code></dt>
  <dd>Method must run within transaction. If there is already started
transaction method will run within that transaction, otherwise
new transaction will be started.</dd>
  <dt><code class="highlighter-rouge">REQUIRES_NEW</code></dt>
  <dd>Method must run within it’s own transaction. Spring will
always create a new transaction for this method. If there is
already started transaction going on, it will be suspended for
duration of this method.</dd>
  <dt><code class="highlighter-rouge">NESTED</code></dt>
  <dd>Method will be run within nested transaction. If no transaction is
present new transaction will be started, otherwise a nested transaction
will be started.</dd>
  <dt><code class="highlighter-rouge">NOT_SUPPORTED</code></dt>
  <dd>Method should not run within transaction. If there is active transaction
going on it will be suspended for duration of this method call.</dd>
  <dt><code class="highlighter-rouge">NEVER</code></dt>
  <dd>Method should not run within transaction.
An exception will be thrown if method is called and
there is active transaction going on.</dd>
</dl>

<h4 id="transactionalisolation">@Transactional(isolation=…)</h4>

<table>
  <thead>
    <tr>
      <th>Isolation Level</th>
      <th style="text-align: center">Dirty Reads</th>
      <th style="text-align: center">Nonrepeatable reads</th>
      <th style="text-align: center">Phantom reads</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">READ_UNCOMMITTED</code></td>
      <td style="text-align: center">:x:</td>
      <td style="text-align: center">:x:</td>
      <td style="text-align: center">:x:</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">READ_COMMITTED</code></td>
      <td style="text-align: center">:heavy_check_mark:</td>
      <td style="text-align: center">:x:</td>
      <td style="text-align: center">:x:</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">REPEATABLE_READ</code></td>
      <td style="text-align: center">:heavy_check_mark:</td>
      <td style="text-align: center">:heavy_check_mark:</td>
      <td style="text-align: center">:x:</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">SERIALIZABLE</code></td>
      <td style="text-align: center">:heavy_check_mark:</td>
      <td style="text-align: center">:heavy_check_mark:</td>
      <td style="text-align: center">:heavy_check_mark:</td>
    </tr>
  </tbody>
</table>

<p><code class="highlighter-rouge">DEFAULT</code> isolation level uses transaction isolation level provided
by underlying implementation.</p>

<dl>
  <dt>Dirty Reads</dt>
  <dd>Transaction may read data written
but not yet committed by other transactions.</dd>
  <dt>Nonrepeatable</dt>
  <dt>reads</dt>
  <dd>Performing the same query twice may return different data.
Usually this happens because some other transaction
updated data and was successfully committed after first
but before second query.</dd>
  <dt>Phantom reads</dt>
  <dd>When we query for set of rows twice second query may return
rows not present in result returned by first query.
Usually this happens because some other transaction inserted rows
to queried table and was successfully committed between our queries.</dd>
</dl>

<h4 id="transactionalrollbackfor-norollbackfor">@Transactional(rollbackFor=…, noRollbackFor=)</h4>

<p>By default transaction are rolled back only 
on uncaught runtime exceptions.
<code class="highlighter-rouge">rollbackFor</code> and <code class="highlighter-rouge">noRollbackFor</code> properties allows us to
set additional exceptions types for which transaction should
or should not rolled back.</p>

<h4 id="transactionalreadonly">@Transactional(readOnly=…)</h4>

<p>Set <code class="highlighter-rouge">readOnly=true</code> when transaction doesn’t write back
to database. This will allow underlying implementation to
possibly optimize data access.</p>

<p>This settings make sense only on methods that start new
transaction (with propagation <code class="highlighter-rouge">REQUIRED</code>, <code class="highlighter-rouge">REQUIRES_NEW</code> and <code class="highlighter-rouge">NESTED</code>).</p>

<h4 id="transactionaltimeout">@Transactional(timeout=…)</h4>

<p>Transaction timeout in seconds.</p>


	  ]]></description>
	</item>


</channel>
</rss>
