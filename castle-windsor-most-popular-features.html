<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Castle Windsor most popular features</title>
    <meta name="description" content="Programming is Magic - A place where I can share my thoughts about programming" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Programming is Magic" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Programming is Magic" />
    <meta property="og:description" content="A place where I can share my thoughts about programming" />
    <meta property="og:url" content="/" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Programming is Magic" />
    <meta name="twitter:description" content="A place where I can share my thoughts about programming" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Programming is Magic",
    "url": "/",
    "image": "/assets/images/cover1.jpg",
    "description": "A place where I can share my thoughts about programming"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Programming is Magic" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation">
            <a href="/">Home</a>
        </li>
        
        <li class="nav-javascript " role="presentation"><a href="/tag/javascript">JavaScript</a></li>
        <li class="nav-speeches " role="presentation"><a href="/tag/java">Java</a></li>

        <li class="nav-fiction " role="presentation"><a href="/tag/csharp">C#</a></li>
        
        <li class="nav-fiction " role="presentation"><a href="/tag/algorithms">Algorithms</a></li>


        <li class="nav-author " role="presentation">
            <a href="/author/mc">Author</a>
        </li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head  no-gradient" style="background-image: url(/assets/images/mc_cover6.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/home.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-test tag-content">

        <header class="post-header">
            <h1 class="post-title">Castle Windsor most popular features</h1>
            <section class="post-meta">
            <!-- <a href='/'>marcin-chwedczuk</a> -->
            <time class="post-date" datetime="2016-09-11">11 Sep 2016</time>
                <!-- [[tags prefix=" on "]] -->
                 
                on 
                
                    
                       <a href='/tag/CSharp'>Csharp</a>
                       
                
                
            </section>
        </header>

        <section class="post-content">
            
            <p>In this post I will present the most popular 
<a href="http://www.castleproject.org/projects/windsor/">Castle Windsor</a> features
encountered in typical enterprise applications.</p>

<blockquote>
  <p>Source code: <a href="https://github.com/marcin-chwedczuk/castle-windsor-most-popular-features">https://github.com/marcin-chwedczuk/castle-windsor-most-popular-features</a></p>
</blockquote>

<h5 id="typed-factory">Typed factory</h5>

<p>When I follow good software development practices like
<a href="https://en.wikipedia.org/wiki/SOLID_(object-oriented_design)">SOLID</a>
I find myself writing plenty of <a href="https://en.wikipedia.org/wiki/Factory_(object-oriented_programming)">factory</a> classes.
These factory classes often fall in one of the two categories:</p>

<ul>
  <li>I need to create instance of generic service for specific type e.g. I want to get 
 service that implements <code class="highlighter-rouge">ICommandHandler&lt;TCommand&gt;</code> for <code class="highlighter-rouge">TCommand</code> type</li>
  <li>I must pass parameters and/or configuration to the service before I
 can use it e.g. <code class="highlighter-rouge">HeuristicSearch</code> service has <code class="highlighter-rouge">quality</code> constructor parameter
 to decide what solutions are good enough for the user</li>
</ul>

<p>In cases like these we can use typed factory feature to generate
factory implementations:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// to enable typed factory we must add TypedFactoryFacility
// to the container
</span><span class="n">container</span><span class="p">.</span><span class="n">AddFacility</span><span class="p">&lt;</span><span class="n">TypedFactoryFacility</span><span class="p">&gt;();</span>

<span class="c1">// case  I: get generic service instance for specific type
</span><span class="k">public</span> <span class="k">interface</span> <span class="n">ICommandHandler</span><span class="p">&lt;</span><span class="n">TCommand</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">TCommand</span> <span class="n">command</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">interface</span> <span class="n">ICommandHandlerFactory</span> <span class="p">{</span>
    <span class="n">ICommandHandler</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Create</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
    <span class="k">void</span> <span class="n">Release</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">ICommandHandler</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">instance</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AddUserCommandHandler</span> <span class="p">:</span> <span class="n">ICommandHandler</span><span class="p">&lt;</span><span class="n">AddUserCommand</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">public</span> <span class="nf">AddUserCommandHandler</span><span class="p">(</span><span class="cm">/* dependencies */</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Handle</span><span class="p">(</span><span class="n">AddUserCommand</span> <span class="n">command</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">ICommandHandler</span><span class="p">&lt;</span><span class="n">AddUserCommand</span><span class="p">&gt;&gt;()</span>
        <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">AddUserCommandHandler</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">LifeStyle</span><span class="p">.</span><span class="n">Transient</span><span class="p">,</span>

    <span class="c1">// tell Windsor that it should generate factory for me
</span>    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">ICommandHandlerFactory</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="nf">AsFactory</span><span class="p">()</span>
    <span class="p">);</span>

<span class="c1">// usage
</span><span class="n">ICommandHandlerFactory</span> <span class="n">factory</span> <span class="p">=</span>
        <span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">ICommandHandlerFactory</span><span class="p">&gt;();</span>

<span class="n">ICommandHandler</span><span class="p">&lt;</span><span class="n">AddUserCommand</span><span class="p">&gt;</span> <span class="n">handler</span> <span class="p">=</span>
    <span class="n">factory</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">AddUserCommand</span><span class="p">&gt;();</span>

<span class="n">handler</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="k">new</span> <span class="nf">AddUserCommand</span><span class="p">());</span>

<span class="n">factory</span><span class="p">.</span><span class="nf">Release</span><span class="p">(</span><span class="n">handler</span><span class="p">);</span>

<span class="c1">// case II: pass configuration to the service
</span><span class="k">public</span> <span class="k">interface</span> <span class="n">IGreeter</span> <span class="p">{</span>
    <span class="k">void</span> <span class="nf">Greet</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">interface</span> <span class="n">IGreeterFactory</span> <span class="p">{</span>
    <span class="n">IGreeter</span> <span class="nf">Create</span><span class="p">(</span><span class="kt">string</span> <span class="n">greeting</span><span class="p">);</span>
    <span class="k">void</span> <span class="nf">Release</span><span class="p">(</span><span class="n">IGreeter</span> <span class="n">instance</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">ConsoleGreeter</span> <span class="p">:</span> <span class="n">IGreeter</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">public</span> <span class="nf">ConsoleGreeter</span><span class="p">(</span><span class="kt">string</span> <span class="n">greeting</span>
        <span class="cm">/* you may add other dependencies here,
         * e.g. ITextWrapper wrapper */</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IGreeter</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">ConsoleGreeter</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="nf">LifestyleTransient</span><span class="p">(),</span>

    <span class="c1">// tell Windsor that it should generate factory for me
</span>    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IGreeterFactory</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="nf">AsFactory</span><span class="p">()</span>
    <span class="p">);</span>

<span class="c1">// usage
</span><span class="n">IGreeterFactory</span> <span class="n">greeterFactory</span> <span class="p">=</span> 
    <span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IGreeterFactory</span><span class="p">&gt;();</span>

<span class="n">IGreeter</span> <span class="n">helloWorldGreeter</span> <span class="p">=</span> <span class="n">greeterFactory</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">"hello, world!"</span><span class="p">);</span>
<span class="n">IGreeter</span> <span class="n">goodbyeGreeter</span> <span class="p">=</span> <span class="n">greeterFactory</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">"goodbye cruel world!"</span><span class="p">);</span>

<span class="n">helloWorldGreeter</span><span class="p">.</span><span class="nf">Greet</span><span class="p">();</span>
<span class="n">goodbyeGreeter</span><span class="p">.</span><span class="nf">Greet</span><span class="p">();</span>

<span class="n">greeterFactory</span><span class="p">.</span><span class="nf">Release</span><span class="p">(</span><span class="n">helloWorldGreeter</span><span class="p">);</span>
<span class="n">greeterFactory</span><span class="p">.</span><span class="nf">Release</span><span class="p">(</span><span class="n">goodbyeGreeter</span><span class="p">);</span></code></pre></figure>

<p>Things to remember when using typed factory:</p>

<ul>
  <li><code class="highlighter-rouge">Release</code> method in factory interface is optional.<br />
 It is a good practice to
 always include <code class="highlighter-rouge">Release</code> method in factory interface and to release all instances
 created using factory when they are no longer needed</li>
  <li>In case of transient or per-web-request components that are disposable
 not releasing component will result in a memory leak</li>
  <li>Remember that some factories should be implemented manually especially these 
 that contain domain knowledge e.g. factory that selects discount
 <a href="https://en.wikipedia.org/wiki/Strategy_pattern">strategy</a> based on user profile</li>
</ul>

<h5 id="collection-resolver">Collection resolver</h5>

<p>Sometime we want to get all components that provide given service.
For example we may try to implement message filtering component and
we want to get all components that implement <code class="highlighter-rouge">IFilter</code> interface.
We may achieve this easily by using Castle Windsor <code class="highlighter-rouge">CollectionResolver</code>:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// register CollectionResolver in the container:
</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">.</span><span class="n">Resolver</span><span class="p">.</span><span class="nf">AddSubResolver</span><span class="p">(</span>
        <span class="k">new</span> <span class="nf">CollectionResolver</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">Kernel</span><span class="p">));</span>

<span class="c1">// demo:
</span><span class="k">public</span> <span class="k">interface</span> <span class="n">IFilter</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="nf">IsAllowed</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MessageFilterService</span> <span class="p">{</span>
    <span class="k">private</span> <span class="n">ICollection</span><span class="p">&lt;</span><span class="n">IFilter</span><span class="p">&gt;</span> <span class="n">_filters</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">MessageFilterService</span><span class="p">(</span><span class="n">ICollection</span><span class="p">&lt;</span><span class="n">IFilter</span><span class="p">&gt;</span> <span class="n">filters</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">_filters</span> <span class="p">=</span> <span class="n">filters</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">MessageFilterService</span><span class="p">&gt;().</span><span class="n">LifeStyle</span><span class="p">.</span><span class="n">Transient</span><span class="p">,</span>

    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IFilter</span><span class="p">&gt;().</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">RejectBazWordFilter</span><span class="p">&gt;(),</span>
    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IFilter</span><span class="p">&gt;().</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">FooOrBazFilter</span><span class="p">&gt;()</span>
<span class="p">);</span>

<span class="n">MessageFilterService</span> <span class="n">service</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">MessageFilterService</span><span class="p">&gt;();</span>
<span class="n">service</span><span class="p">.</span><span class="nf">IsAllowed</span><span class="p">(</span><span class="s">"foo"</span><span class="p">);</span></code></pre></figure>

<p>Since registering <code class="highlighter-rouge">CollectionResolver</code> requires a bit of interaction
with a container it is advisable to wrap that logic into custom facility:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ResolveCollectionsFacility</span> <span class="p">:</span> <span class="n">AbstractFacility</span> <span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Init</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Kernel</span><span class="p">.</span><span class="n">Resolver</span><span class="p">.</span><span class="nf">AddSubResolver</span><span class="p">(</span><span class="k">new</span> <span class="nf">CollectionResolver</span><span class="p">(</span><span class="n">Kernel</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// then use:
</span><span class="p">//</span> <span class="n">container</span><span class="p">.</span><span class="n">AddFacility</span><span class="p">&lt;</span><span class="n">ResolveCollectionsFacility</span><span class="p">&gt;();</span></code></pre></figure>

<h5 id="component-registration-using-conventions">Component registration using conventions</h5>

<p><a href="https://en.wikipedia.org/wiki/Convention_over_configuration">Convention over configuration</a>
is popular subject these days so why not to apply it to the component registration.
Instead of writing boring:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IFooRepository</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">FooRepository</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">Lifestyle</span><span class="p">.</span><span class="n">PerWebRequest</span><span class="p">,</span>
<span class="p">...</span>
<span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IBarRepository</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">BarRepository</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">Lifestyle</span><span class="p">.</span><span class="n">PerWebRequest</span></code></pre></figure>

<p>We may write just once:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">Classes</span><span class="p">.</span><span class="nf">FromThisAssembly</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">BasedOn</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IRepository</span><span class="p">&lt;&gt;))</span>
    <span class="p">.</span><span class="n">WithService</span><span class="p">.</span><span class="nf">AllInterfaces</span><span class="p">()</span>
    <span class="p">.</span><span class="n">Lifestyle</span><span class="p">.</span><span class="n">PerWebRequest</span></code></pre></figure>

<p>Castle Windsor is very flexible when it comes to registering components
by convention, we may scan selected assemblies and/or namespaces, we
may even select components to register by testing component <code class="highlighter-rouge">Type</code>.</p>

<blockquote>
  <p>PITFALL: Avoid creating conventions based on type name (e.g. register all classes that
have names ending with <code class="highlighter-rouge">Repository</code>) as
much as possible. It is always better to create empty marker interface
e.g. <code class="highlighter-rouge">IApplicationService</code> and use it to register all necessary components.</p>
</blockquote>

<h5 id="installers">Installers</h5>

<p>Castle Windsor installers allow us to group component registrations into
reusable pieces of code. The real power of installers comes from the fact that
we may pass them arguments or in other words we may configure them.
For example installer may take a single argument that tells what lifestyle should
be applied to all registrations contained in the installer. Such installer can
be used in both ASP.NET MVC app when most of the components will be
registered as <code class="highlighter-rouge">PerWebRequest</code> and in Windows service app where components will 
be registered as either <code class="highlighter-rouge">Transient</code> or <code class="highlighter-rouge">Singleton</code>.</p>

<p>Here is example of very simple installer:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">DummyModuleInstaller</span> <span class="p">:</span> <span class="n">IWindsorInstaller</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Install</span><span class="p">(</span><span class="n">IWindsorContainer</span> <span class="n">container</span><span class="p">,</span> <span class="n">IConfigurationStore</span> <span class="n">store</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">container</span><span class="p">.</span><span class="n">AddFacility</span><span class="p">&lt;</span><span class="n">TypedFactoryFacility</span><span class="p">&gt;();</span>

        <span class="c1">// add other installers, facilities etc.
</span>
        <span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
            <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">DummyService</span><span class="p">&gt;().</span><span class="n">LifeStyle</span><span class="p">.</span><span class="n">Transient</span>
            <span class="c1">// other components
</span>            <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">container</span><span class="p">.</span><span class="nf">Install</span><span class="p">(</span><span class="k">new</span> <span class="p">[]</span> <span class="p">{</span>
    <span class="k">new</span> <span class="nf">DummyModuleInstaller</span><span class="p">()</span>
<span class="p">});</span></code></pre></figure>

<h5 id="fallback-and-default-components">Fallback and default components</h5>

<p>When we start grouping registrations into installers often we will find ourselves
in situation that we want to register given service only when user of the installer
didn’t provide she’s own implementation. We may achieve this by passing parameters
to the installer but a fallback components are a better choice here.
Components registered as fallbacks will be used by the container only when there is no
other component that provides given service:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="c1">// fallback is used when no other component
// for service is registered
</span><span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IFooService</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">FallbackFooService</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">LifeStyle</span><span class="p">.</span><span class="n">Transient</span>
        <span class="p">.</span><span class="nf">IsFallback</span><span class="p">()</span>
        <span class="p">);</span>

<span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IFooService</span><span class="p">&gt;(),</span>
    <span class="n">Is</span><span class="p">.</span><span class="n">InstanceOf</span><span class="p">&lt;</span><span class="n">FallbackFooService</span><span class="p">&gt;());</span>

<span class="c1">// we may register our own component for FooService
</span><span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IFooService</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">FooService</span><span class="p">&gt;()</span>
        <span class="p">);</span>

<span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IFooService</span><span class="p">&gt;(),</span>
    <span class="n">Is</span><span class="p">.</span><span class="n">InstanceOf</span><span class="p">&lt;</span><span class="n">FooService</span><span class="p">&gt;());</span></code></pre></figure>

<p>Since word isn’t perfect it happens from time to time that we want to
overwrite component registration for some particular service. This usually happens
because author of the installer doesn’t use fallback components. But don’t panic
Castle Windsor allow us to overwrite service registrations using default components:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IFooService</span><span class="p">&gt;()</span>
        <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">FooService</span><span class="p">&gt;());</span>

<span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IFooService</span><span class="p">&gt;(),</span>
    <span class="n">Is</span><span class="p">.</span><span class="n">InstanceOf</span><span class="p">&lt;</span><span class="n">FooService</span><span class="p">&gt;());</span>

<span class="c1">// Without IsDefault() we
// would get an exception telling us that
// there is already component registered for IFooService
// interface.
</span><span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
   <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IFooService</span><span class="p">&gt;()</span>
       <span class="p">.</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">DefaultFooService</span><span class="p">&gt;()</span>
       <span class="p">.</span><span class="nf">IsDefault</span><span class="p">()</span>
       <span class="p">);</span>

<span class="n">Assert</span><span class="p">.</span><span class="nf">That</span><span class="p">(</span><span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IFooService</span><span class="p">&gt;(),</span>
    <span class="n">Is</span><span class="p">.</span><span class="n">InstanceOf</span><span class="p">&lt;</span><span class="n">DefaultFooService</span><span class="p">&gt;());</span></code></pre></figure>

<h5 id="interceptors">Interceptors</h5>

<p>Interceptors are most powerful Castle Windsor feature that
brings power of <a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming">aspect oriented programming</a>
to .NET.
Interceptors can be used to implement transaction management, logging, security checks,
we may use them to gather performance related statistics and for many other purposes.</p>

<p>Here is a simple interceptor that log the invocations of all component methods:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">EventTracingInterceptor</span> <span class="p">:</span> <span class="n">IInterceptor</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Intercept</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">EventTracer</span><span class="p">.</span><span class="nf">AddEvent</span><span class="p">(</span><span class="s">"BEFORE "</span> <span class="p">+</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Method</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// call original method, we may inspect method arguments,
</span>            <span class="c1">// generic parameters, return value and many others
</span>            <span class="n">invocation</span><span class="p">.</span><span class="nf">Proceed</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">finally</span> <span class="p">{</span>
            <span class="n">EventTracer</span><span class="p">.</span><span class="nf">AddEvent</span><span class="p">(</span><span class="s">"AFTER "</span> <span class="p">+</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Method</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="na">[Interceptor(typeof(EventTracingInterceptor))]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">Service</span> <span class="p">:</span> <span class="n">IService</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Foo</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Bar</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>

<span class="n">container</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span>
    <span class="c1">// interceptors work only when you expose your
</span>    <span class="c1">// components via interfaces.
</span>    <span class="c1">// here I registered interceptors by using
</span>    <span class="c1">// attributes on Service class but you may also
</span>    <span class="c1">// use fluent api.
</span>    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">IService</span><span class="p">&gt;().</span><span class="n">ImplementedBy</span><span class="p">&lt;</span><span class="n">Service</span><span class="p">&gt;(),</span>
    <span class="n">Component</span><span class="p">.</span><span class="n">For</span><span class="p">&lt;</span><span class="n">EventTracingInterceptor</span><span class="p">&gt;()</span>
    <span class="p">);</span>

<span class="n">IService</span> <span class="n">service</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">Resolve</span><span class="p">&lt;</span><span class="n">IService</span><span class="p">&gt;();</span>
<span class="n">service</span><span class="p">.</span><span class="nf">Foo</span><span class="p">();</span></code></pre></figure>

<p>When you start writing your own interceptors it is generally advisable to
create custom attribute e.g. <code class="highlighter-rouge">TransactionalAttribute</code> to mark classes that
should have interceptors attached. 
Then you should write your own facility that will scan all components
registered in container
and will attach interceptor for these marked with your custom attribute.
<a href="http://blog.willbeattie.net/2010/09/implementing-custom-castle-windsor.html">Here is a good example of this approach</a>
used to implement caching.</p>

<p>That’s all for today! Thanks for reading.</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/mc" style="background-image: url(/assets/images/mc.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/mc">marcin-chwedczuk</a></h4>
                
                
                    <p> A Programmer, A Geek, A Human</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Warsaw, Poland</span> 
                    <span class="author-link icon-link"><a href="https://marcin-chwedczuk.github.io/"> marcin-chwedczuk.github.io/</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Castle Windsor most popular features&amp;url=https://marcin-chwedczuk.github.io/castle-windsor-most-popular-features"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://marcin-chwedczuk.github.io/castle-windsor-most-popular-features"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://marcin-chwedczuk.github.io/castle-windsor-most-popular-features"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script>
    /**
    * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    
    var disqus_config = function () {
        this.page.url = 'https://marcin-chwedczuk.github.io//castle-windsor-most-popular-features';
        this.page.identifier = '/castle-windsor-most-popular-features';
    };
    
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//marcinchwedczukgithubio.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/mc_cover3.jpg)" href="/obfuscating-windows-batch-files">
            <section class="post">
                <h2>Obfuscating windows batch files using undefined environmental variables</h2>
                <p>In this post I will present an old trick from mid 90s used by hackers...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/mc_cover4.jpg)" href="/how-to-use-grep-command">
            <section class="post">
                <h2>How to use grep command</h2>
                <p>grep is a command line program that allows us to find all occurrences of given...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Programming is Magic</a> &copy; 2018</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82096342-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
