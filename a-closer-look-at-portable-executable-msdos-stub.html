<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>A closer look at Portable Executable MS-DOS Stub</title>
    <meta name="description" content="Programming is Magic - A place where I can share my thoughts about programming" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Programming is Magic" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Programming is Magic" />
    <meta property="og:description" content="A place where I can share my thoughts about programming" />
    <meta property="og:url" content="/" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Programming is Magic" />
    <meta name="twitter:description" content="A place where I can share my thoughts about programming" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Programming is Magic",
    "url": "/",
    "image": "/assets/images/cover1.jpg",
    "description": "A place where I can share my thoughts about programming"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Programming is Magic" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation">
            <a href="/">Home</a>
        </li>
        
        <li class="nav-javascript " role="presentation"><a href="/tag/javascript">JavaScript</a></li>
        <li class="nav-speeches " role="presentation"><a href="/tag/java">Java</a></li>

        <li class="nav-fiction " role="presentation"><a href="/tag/csharp">C#</a></li>
        
        <li class="nav-fiction " role="presentation"><a href="/tag/algorithms">Algorithms</a></li>


        <li class="nav-author " role="presentation">
            <a href="/author/mc">Author</a>
        </li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head  no-gradient" style="background-image: url(/assets/images/mc_cover2.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/home.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-test tag-content">

        <header class="post-header">
            <h1 class="post-title">A closer look at Portable Executable MS-DOS Stub</h1>
            <section class="post-meta">
            <!-- <a href='/'>marcin-chwedczuk</a> -->
            <time class="post-date" datetime="2017-11-18">18 Nov 2017</time>
                <!-- [[tags prefix=" on "]] -->
                 
                on 
                
                    
                       <a href='/tag/low-level'>Low-level</a>
                       
                
                
            </section>
        </header>

        <section class="post-content">
            
            <p>When we open native or .NET windows executables in a hex-editor
we can notice that almost all of them contains strange
“This program cannot be run in DOS mode” text at the beginning of the file.
The original purpose on this text and surrounding it small
MS-DOS program, called MS-DOS stub is to print message to
the user and then exit if the <code class="highlighter-rouge">.exe</code> file is run from under MS-DOS.
I in this blog post I will explain how it works and since
currently I have only GNU/Linux boxes in my flat I will 
investigate using only Linux.</p>

<p>First we must obtain some <code class="highlighter-rouge">.exe</code> files. We can create .NET executable
using <a href="http://www.mono-project.com/download/#download-lin">Mono Project</a>:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ cat HelloWorld.cs 
using System;

public class Program {
    public static void Main() {
        Console.WriteLine("Hello, world!");
    }
}

$ mcs HelloWorld.cs 

$ mono HelloWorld.exe 
Hello, world!</code></pre></figure>

<p>Native executable can be created using 
<a href="https://stackoverflow.com/a/38788588/1779504">MinGW</a>
cross-compiler:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ cat main.c 
#include &lt;stdio.h&gt;

int main(int argc, char* argv[]) {
    printf("Hello, world!\n");
    return 0;
}

$ i686-w64-mingw32-gcc -o main64.exe main.c 

$ wine main64.exe 
Hello, world!</code></pre></figure>

<p>Now when we have a .NET and a 64-bit <code class="highlighter-rouge">.exe</code> files we may look at
them using hex-editor
(I will use <a href="https://github.com/bwrsandman/Bless">Bless</a> here):
<img src="assets/images/2017-11-18/hex_hello_world_exe.png" alt=".NET executable viewed using hex-editor" />
<img src="assets/images/2017-11-18/hex_main64_exe.png" alt="Native executable viewed using hex-editor" />
MS-DOS Stubs in both files looks very similar. This is quite unexpected
because we used two completely different compilers to create them.
Let’s confirm our assumptions first by extracting MS-DOS Stubs and then
by comparing them.</p>

<p>In case of both files MS-DOS Stubs end on 0x80 offset.
At that offset we can see “PE” letters 
that mark start of PE headers
(“PE” means Portable Executable, this is
the name of <code class="highlighter-rouge">.exe</code> file format used by Windows).
These letters are often called a Magical Number or a file signature.
This is similar to MZ letters that are always present at the
beginning of MS-DOS executables.</p>

<p>To extract stubs we must copy first 0x80 bytes (0x80 = 8*16 = 128)
of <code class="highlighter-rouge">.exe</code> files. Then we may compare them:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ dd if=nativeexe/main64.exe \
    of=native-msdos-stub.exe \
    bs=1 count=$((8*16))
$ dd if=dotnetexe/HelloWorld.exe \
    of=dotnet-msdos-stub.exe \
    bs=1 count=$((8*16))

# diff can only compare text files. We must convert
# our binary MS-DOS Stubs to hex using xxd command first:
$ diff &lt;(xxd native-msdos-stub.exe) &lt;(xxd dotnet-msdos-stub.exe) \
    | colordiff
# No output means no changes</code></pre></figure>

<p>So indeed MS-DOS Stubs are identical.</p>

<p>Now just for the sake of doing it I will grab DOSBox and check
if these subs are working:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ sudo apt install dosbox
$ dosbox</code></pre></figure>

<p>After DOSBox starts we must mount our directory with <code class="highlighter-rouge">.exe</code> files
as <code class="highlighter-rouge">C:</code> disk:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">Z:\&gt; mount c /home/user/path_to_exe_files
Z:\&gt; C:
C:\&gt; REM And we are done!</code></pre></figure>

<p><img src="assets/images/2017-11-18/dosbox1.png" alt="DOSBox main window" /></p>

<p>We may use <code class="highlighter-rouge">CLS</code> command to clear the screen and attempt to
run our <code class="highlighter-rouge">.exe</code> files. For those that never used MS-DOS, this
system supports only short files names (eight letters for file name plus
three letters for extension, so called <code class="highlighter-rouge">8.3</code> format).
That is why our <code class="highlighter-rouge">HelloWorld.exe</code> is displayed as <code class="highlighter-rouge">HELLOW~2.EXE</code>.
<img src="assets/images/2017-11-18/dosbox2.png" alt="DOSBox main window" /></p>

<p>Everything works as expected. But that is not all of it.
Instead of our <code class="highlighter-rouge">.exe</code> files we may run our extracted MS-DOS Stubs and
they also work without any problems:
<img src="assets/images/2017-11-18/dosbox3.png" alt="DOSBox main window" />
This suggest that MS-DOS Stubs are just tiny MS-DOS EXE programs
(in MZ format) embedded in PE files.</p>

<p>To confirm that assumption we must look under the cover.
Let’s start by dumping values of MS-DOS COM header:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">     e_magic: 4d 5a            // Magic number 'MZ'
      e_cblp: 0x0090           // Bytes on last page of file
        e_cp: 0x0003           // Pages in file
      e_crlc: 0x0000           // Relocations
   e_cparhdr: 0x0004           // Size of header in paragraphs
  e_minalloc: 0x0000           // Minimum extra paragraphs needed
  e_maxalloc: 0xffff           // Maximum extra paragraphs needed
        e_ss: 0x0000           // Initial (relative) SS value
        e_sp: 0x00b8           // Initial SP value
      e_csum: 0x0000           // Checksum
        e_ip: 0x0000           // Initial IP value
        e_cs: 0x0000           // Initial (relative) CS value
    e_lfarlc: 0x0040           // File address of relocation table
      e_ovno: 0x0000           // Overlay number
       e_res: 00 00 00 00 00 00 00 00 
                               // Reserved
     e_oemid: 0x0000           // OEM identifier (for e_oeminfo)
   e_oeminfo: 0x0000           // OEM information; e_oemid specific
      e_res2: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
                               // Reserved
    e_lfanew: 0x00000080       // File address of the new exe header</code></pre></figure>

<p>To extract these values I wrote a small Java program. Source code is
available as a <a href="https://gist.github.com/marcin-chwedczuk/bc050b8feddb50f29cd5bf83e5f843c4">GitHub Gist here</a>.</p>

<p>All values in both MS-DOS file header and in PE headers are stored
using little-endian convention. This means that a four byte integer
e.g. <code class="highlighter-rouge">0x11223344</code> will be represented on disk by bytes <code class="highlighter-rouge">0x44 0x33 0x22 0x11</code>
(least significant byte first).
Of course this applies only to multi-byte types supported by CPU
(<code class="highlighter-rouge">short</code>, <code class="highlighter-rouge">int</code>, <code class="highlighter-rouge">long</code>, <code class="highlighter-rouge">double</code> and <code class="highlighter-rouge">float</code>).
Also because characters in ASCII strings are represented by single bytes
they are not affected by endianness.
For example string “foo” is represented on disk as <code class="highlighter-rouge">0x66 (f) 0x6f (o) 0x6f (o)</code>
in both little-endian and bit-endian conventions.</p>

<p>I must admit that most of values in MS-DOS header seem magical to me.
The most important thing that I learn by looking at the header was its size:
64 bytes. So after first 64 bytes of MS-DOS Stub
I expect to find some MS-DOS code.</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ dd if=dotnet-msdos-stub.exe \
    of=code.com bs=1 skip=64 count=64

$ file code.com 
code.com: COM executable for DOS</code></pre></figure>

<p>Before we attempt to disassemble code we must learn how MS-DOS
programs are loaded in memory. I didn’t make a deep research but
I have found a few valuable informations:</p>

<ul>
  <li>MS-DOS divides memory in 64k segments. Programs refer to
 a specific address in memory using <code class="highlighter-rouge">segment:offset</code> pair.
 <code class="highlighter-rouge">segment</code> value is set by MS-DOS when program is loaded and
 is stored in special CPU registers like <code class="highlighter-rouge">CS</code> (code segment)
 or <code class="highlighter-rouge">SS</code> (stack segment).</li>
  <li><code class="highlighter-rouge">e_ip</code> value of MS-DOS header points to the first instruction
 of the program (to be more precise <code class="highlighter-rouge">e_ip</code> is <code class="highlighter-rouge">offset</code> inside <code class="highlighter-rouge">e_cs</code>
 code segment).</li>
</ul>

<p>Let’s try to use <a href="http://www.nasm.us/">NASM</a> to disassemble our code:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ ndisasm -b 16 code.com 
00000000  0E                push cs
00000001  1F                pop ds
00000002  BA0E00            mov dx,0xe
00000005  B409              mov ah,0x9
00000007  CD21              int 0x21
00000009  B8014C            mov ax,0x4c01
0000000C  CD21              int 0x21
0000000E  54                push sp
0000000F  686973            push word 0x7369
00000012  207072            and [bx+si+0x72],dh
00000015  6F                outsw
00000016  677261            jc 0x7a
00000019  6D                insw
0000001A  206361            and [bp+di+0x61],ah
...</code></pre></figure>

<p>While reading resulting assembly code we must remember that our tiny program
stores both “This program cannot be run in DOS mode” 
message data and code in the same segment.
Since the message starts at offset <code class="highlighter-rouge">0x0E</code> we may assume that <code class="highlighter-rouge">int 0x21</code>
is the last instruction of the program.
<img src="assets/images/2017-11-18/hex2.png" alt="Offset of the message" /></p>

<p>Now we should try to analyze this assembly code, fortunately for me
I have found this beautifully commend piece of code 
<a href="https://en.wikibooks.org/wiki/X86_Disassembly/Windows_Executable_Files#MS-DOS_header">here</a>:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">push cs ;<span class="c"># Push CS onto the stack</span>
pop ds  ;<span class="c"># Set DS to CS</span>

; <span class="c"># (me) This means that Data Segment</span>
; <span class="c"># and Code Segment point to the same</span>
; <span class="c"># 64k byte area of memory.</span>
; <span class="c"># Without this we would not be able</span>
; <span class="c"># to load any data.</span>

mov dx, message ;<span class="c"># dx will contain pointer to message</span>
mov ah, 09  
int 0x21 ;<span class="c"># when AH = 9, DOS interrupt to write a string</span>

<span class="gp">;# </span>terminate the program
mov ax,0x4c01 
int 0x21

message db <span class="s2">"This program cannot be run in DOS mode."</span>, 
    0x0d, 0x0d, 0x0a, <span class="s1">'$'</span></code></pre></figure>

<p>Since we go that far why don’t we change default stub to something more
interesting e.g. printing “Nyan” 3 times?
First we must create a valid assembly program:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">ORG 0h ;<span class="c"># Offset 0, for NASM</span>

push cs 
pop ds 

; <span class="c"># print message 3 times</span>
mov bx, 3
push bx
repeat:
        mov dx, message 
        mov ah, 09  
        int 0x21

        pop bx
        dec bx
        push bx
cmp bx, 0
jg repeat
pop bx

; <span class="c"># terminate the program</span>
mov ax,0x4c01 
int 0x21

; ----------  D A T A  -------------

message: DB <span class="s2">"Nyaan."</span>, 0x0d, 0x0d, 0x0a, <span class="s1">'$'</span></code></pre></figure>

<p>The main idea here is that we keep loop counter on the top of the
stack and we load counter into <code class="highlighter-rouge">bx</code> register only to decrement it
or to compere it with zero. I keep the counter value on the stack because
I don’t know if contents of <code class="highlighter-rouge">bx</code> register is changed by <code class="highlighter-rouge">int 0x21</code>
interrupt (yeah I am too lazy too check).</p>

<p>If you have some spare time you may play with other MS-DOS and BIOS
interrupts to print colorful messages or to beep at the user.</p>

<p>Let’s compile our assembly code and patch one of our <code class="highlighter-rouge">.exe</code> files:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight"># -fbin - just translate instruction to bytes
$ nasm -fbin code_alt.nasm -o code_alt.com

# check file size...
$ stat code_alt.com
  File: 'code_alt.com'
  Size: 37  (...)

# patch EXE file
$ dd conv=notrunc if=code_alt.com \
    of=nativeexe/main64.exe \
    bs=1 seek=64 count=37

# Check it works on "Windows"
$ wine ./nativeexe/main64.exe 
Hello, world!
# Yay! Still working!</code></pre></figure>

<p>And when we start it using DOSBox:
<img src="assets/images/2017-11-18/dosbox4.png" alt="DOSBox main window" /></p>

<p><img src="assets/images/memes/mission_accomplished.jpg" alt="The End" /></p>



        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/mc" style="background-image: url(/assets/images/mc.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/mc">marcin-chwedczuk</a></h4>
                
                
                    <p> A Programmer, A Geek, A Human</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Warsaw, Poland</span> 
                    <span class="author-link icon-link"><a href="https://marcin-chwedczuk.github.io/"> marcin-chwedczuk.github.io/</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=A closer look at Portable Executable MS-DOS Stub&amp;url=https://marcin-chwedczuk.github.io/a-closer-look-at-portable-executable-msdos-stub"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://marcin-chwedczuk.github.io/a-closer-look-at-portable-executable-msdos-stub"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://marcin-chwedczuk.github.io/a-closer-look-at-portable-executable-msdos-stub"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script>
    /**
    * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
    */
    
    var disqus_config = function () {
        this.page.url = 'https://marcin-chwedczuk.github.io//a-closer-look-at-portable-executable-msdos-stub';
        this.page.identifier = '/a-closer-look-at-portable-executable-msdos-stub';
    };
    
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    
    s.src = '//marcinchwedczukgithubio.disqus.com/embed.js';
    
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/mc_cover4.jpg)" href="/how-to-check-if-a-number-is-a-power-of-two">
            <section class="post">
                <h2>How to check if a number is a power of two</h2>
                <p>In this blog post we will learn about two algorithms that allow us to quickly...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/mc_cover2.jpg)" href="/java-streams-best-practices">
            <section class="post">
                <h2>Java streams best practices</h2>
                <p>In this short post I am going to present Java 8 streams best practices. Most...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Programming is Magic</a> &copy; 2018</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82096342-1', 'auto');
  ga('send', 'pageview');
</script>

</body>
</html>
