<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Pitfalls of using Mockito with Scala</title>
    <meta name="description" content="A place where I share my thoughts about programming." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="http://localhost:4000//pitfalls-of-using-Mockito-with-Scala" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Programming is Magic" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Pitfalls of using Mockito with Scala" />
    <meta property="og:description" content="A place where I share my thoughts about programming." />
    <meta property="og:url" content="http://localhost:4000//pitfalls-of-using-Mockito-with-Scala" />
    <meta property="og:image" content="/assets/images/mc_cover2.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Pitfalls of using Mockito with Scala" />
    <meta name="twitter:description" content="A place where I share my thoughts about programming." />
    <meta name="twitter:url" content="http://localhost:4000//pitfalls-of-using-Mockito-with-Scala" />
    <meta name="twitter:image:src" content="/assets/images/mc_cover2.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Programming is Magic",
    "name": "Pitfalls of using Mockito with Scala",
    "url": "http://localhost:4000//pitfalls-of-using-Mockito-with-Scala",
    "image": "/assets/images/mc_cover2.jpg",
    "description": "A place where I share my thoughts about programming."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Programming is Magic" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <!-- <li class="nav-about " role="presentation"><a href="/about">About</a></li> -->

        
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/java">
                    java (25)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: java -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/dotnet">
                    dotnet (11)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: dotnet -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/algorithms">
                    algorithms (7)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: algorithms -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/architecture">
                    architecture (7)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: architecture -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/javascript">
                    javascript (5)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: javascript -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/csharp">
                    csharp (4)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: csharp -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hibernate">
                    hibernate (3)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: hibernate -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/linux">
                    linux (3)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: linux -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/unit-testing">
                    unit-testing (3)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: unit-testing -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hardware-review">
                    hardware-review (2)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: hardware-review -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/scala">
                    scala (2)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: scala -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/devcon">
                    devcon (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: devcon -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/eclipse">
                    eclipse (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: eclipse -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/elektronika">
                    elektronika (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: elektronika -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/git">
                    git (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: git -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hacking">
                    hacking (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: hacking -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/kotlin">
                    kotlin (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: kotlin -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/low-level">
                    low-level (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: low-level -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/other">
                    other (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: other -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/polish">
                    polish (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: polish -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/postman">
                    postman (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: postman -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/powershell">
                    powershell (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: powershell -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/security">
                    security (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: security -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/sql">
                    sql (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: sql -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/tips">
                    tips (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: tips -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/vim">
                    vim (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: vim -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/windows">
                    windows (1)
                    <!-- pitfalls-of-using-Mockito-with-Scala name: windows -->
                </a>
            </li>
        

   </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->



<header class="main-header post-head " style="background-image: url(/assets/images/mc_cover2.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/home.png" alt="Blog Logo"></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-test tag-content">

        <header class="post-header">
            <h1 class="post-title">Pitfalls of using Mockito with Scala</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
                    <a href="/author/mc">Marcin Chwedczuk</a>
                
            
            <time class="post-date" datetime="2019-12-22">22 Dec 2019</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href="/tag/scala">Scala</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>I need to test my new, shiny Scala code.
Usually I write tests in <a href="http://www.scalatest.org/">ScalaTest</a>,
but for generating stubs I still use good, old
<a href="https://site.mockito.org/">Mockito</a>.
What can possibly go wrong?
I open a new tab in my editor and start hacking test code.</p>

<p>For the first surprise I don’t have to wait too long.
In my code I use <a href="https://docs.scala-lang.org/overviews/core/value-classes.html">value classes</a> 
to represent entity IDs.
For example I use <code class="highlighter-rouge">CustomerId</code>:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">case</span> <span class="k">class</span> <span class="nc">CustomerId</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span></code></pre></figure>

<p>When I tried to mock <code class="highlighter-rouge">customerId</code> method (property?):</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">trait</span> <span class="nc">RequestContext</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">customerId</span><span class="k">:</span> <span class="kt">CustomerId</span>
  <span class="c1">// ...
</span><span class="o">}</span></code></pre></figure>

<p>in my test, Mockito started complaining about wrong return types
and refused to cooperate:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="c1">// inside test
</span><span class="k">val</span> <span class="n">requestContext</span> <span class="k">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">RequestContext</span><span class="o">])</span>

<span class="cm">/* Fails with WrongTypeOfReturnValue exception:
*
* CustomerId cannot be returned by customerId()
* customerId() should return long
*/</span>
<span class="n">when</span><span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">customerId</span><span class="o">).</span><span class="n">thenReturn</span><span class="o">(</span><span class="nc">CustomerId</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span></code></pre></figure>

<p>Of course my <code class="highlighter-rouge">CustomerId</code> <a href="https://docs.scala-lang.org/overviews/core/value-classes.html">value class</a> is here to blame…</p>

<p>In Scala, value classes offer type safety of normal classes with
performance of the primitives.
Scala compiler achieves this, simply by replacing the value
class type by the primitive type, wherever possible.
So I grabbed <code class="highlighter-rouge">javap</code> and took a look at the generated bytecode,
and indeed there is a <code class="highlighter-rouge">long</code> there:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">target/scala-2.13/classes$ javap RequestContext.class 
Compiled from "RequestContext.scala"
public interface RequestContext {
  public abstract long customerId();
  // ...
}</code></pre></figure>

<p>Mockito uses reflection to figure out which type
a given method returns.
This gives us little hope for a nice solution.
We can only try to hack around the problem, for example
this monstrosity works:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">requestContext</span> <span class="k">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">RequestContext</span><span class="o">])</span>

<span class="n">when</span><span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">customerId</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">Object</span><span class="o">])</span>
  <span class="o">.</span><span class="n">thenReturn</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="n">box</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span>

<span class="n">assert</span><span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">customerId</span> <span class="o">==</span> <span class="nc">CustomerId</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span></code></pre></figure>

<p>We use <code class="highlighter-rouge">asInstanceOf[Object]</code> to fool Scala’s type system
and then return a <code class="highlighter-rouge">java.lang.Long</code> instance.</p>

<p>Yeah it works but it is not nice… But hey, first get the job done, then
get it done well. Let’s move on to the next test…</p>

<p>I have to verify that a given method was called.
This time I should have more luck, right?
So I wrote another test and I ran it:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">requestContext</span> <span class="k">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">RequestContext</span><span class="o">])</span>

<span class="n">requestContext</span><span class="o">.</span><span class="n">setRequestId</span><span class="o">(</span><span class="nc">RequestId</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span>

<span class="c1">// works perfectly 
</span><span class="n">verify</span><span class="o">(</span><span class="n">requestContext</span><span class="o">).</span><span class="n">setRequestId</span><span class="o">(</span><span class="nc">RequestId</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span>

<span class="c1">// does NOT WORK 
</span><span class="n">verify</span><span class="o">(</span><span class="n">requestContext</span><span class="o">).</span><span class="n">setRequestId</span><span class="o">(</span><span class="n">any</span><span class="o">())</span></code></pre></figure>

<p>But I saw the results I was completly perplexed.
Verification with <code class="highlighter-rouge">RequestId(123L)</code> worked but the one with
<code class="highlighter-rouge">any()</code> did not. But what is worse the second verification
thrown <code class="highlighter-rouge">NullPointerException</code>. NPE? Really?</p>

<p>My brain was racing, and after a few seconds a thought strike me:
it’s these pesky value classes again!</p>

<p>And I was right! Value classes in Scala cannot be <code class="highlighter-rouge">null</code>!
For example, in Scala REPL:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">scala</span><span class="o">&gt;</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">FooId</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span>
<span class="n">defined</span> <span class="k">class</span> <span class="nc">FooId</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">f</span><span class="k">:</span> <span class="kt">FooId</span> <span class="o">=</span> <span class="kc">null</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">FooId</span><span class="o">]</span>
<span class="n">f</span><span class="k">:</span> <span class="kt">FooId</span> <span class="o">=</span> <span class="nc">FooId</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span>
<span class="n">res0</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">// And more...
</span><span class="n">scala</span><span class="o">&gt;</span> <span class="k">var</span> <span class="n">o</span><span class="k">:</span> <span class="kt">Object</span> <span class="o">=</span> <span class="kc">null</span>
<span class="n">o</span><span class="k">:</span> <span class="kt">Object</span> <span class="o">=</span> <span class="kc">null</span>

<span class="n">scala</span><span class="o">&gt;</span> <span class="n">o</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">FooId</span><span class="o">]</span>
<span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="nc">NullPointerException</span>
  <span class="o">...</span> <span class="mi">33</span> <span class="n">elided</span></code></pre></figure>

<p><code class="highlighter-rouge">any()</code> matcher that comes with Mockito has a very simple
implementation:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">any</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nf">anyObject</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Deprecated</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">anyObject</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">reportMatcher</span><span class="o">(</span><span class="n">Any</span><span class="o">.</span><span class="na">ANY</span><span class="o">);</span>
  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure>

<p>that always returns <code class="highlighter-rouge">null</code>.</p>

<p>The method that I tried to check, has a signature:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">trait</span> <span class="nc">RequestContext</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">setRequestId</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">RequestId</span><span class="o">)</span>
  <span class="c1">// ...
</span><span class="o">}</span></code></pre></figure>

<p>and since <code class="highlighter-rouge">RequestId</code> is a value class, the “real” JVM signature is:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">public abstract void setRequestId(long);</code></pre></figure>

<p>When I write <code class="highlighter-rouge">verify(...).setRequestId(any())</code> 
Scala compiler adds instructions that convert the <em>object</em> returned
by <code class="highlighter-rouge">any()</code> (remember generics does not exist on JVM level, so all
these <code class="highlighter-rouge">T</code>s and <code class="highlighter-rouge">V</code>s are just <code class="highlighter-rouge">Object</code>s at runtime) to <code class="highlighter-rouge">long</code>.
And this is the reason why I got <code class="highlighter-rouge">NullPointerException</code> earlier.</p>

<p>In bytecode it looks like this:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">19: invokestatic  #33 // Method org/mockito/Mockito.verify:(Ljava/lang/Object;)Ljava/lang/Object;
22: checkcast     #17 // class RequestContext
25: invokestatic  #39 // Method org/mockito/ArgumentMatchers.any:()Ljava/lang/Object;
28: checkcast     #41 // class RequestId
31: invokevirtual #45 // Method RequestId.id:()J
34: invokeinterface #29, 3 // InterfaceMethod RequestContext.setRequestId:(J)V</code></pre></figure>

<p>and the NPE is thrown by the instruction at the offset <code class="highlighter-rouge">31</code>.</p>

<p>Now I understand the problem, but I still want to use <code class="highlighter-rouge">any()</code> matcher.
There must be a trick to make it return a valid <code class="highlighter-rouge">RequestId</code>.
But then I realized that even if I found such a way, I would be
bitten again by <code class="highlighter-rouge">WrongTypeOfReturnValue</code> exception or
something similar, since
the method takes <code class="highlighter-rouge">long</code> not <code class="highlighter-rouge">RequestId</code>. What I really need is
a way to use <code class="highlighter-rouge">anyLong()</code> with <code class="highlighter-rouge">setRequestId</code>. It was a good
enough challenge to
start my evil alter-ego working on some frankensteinian solution.
And I found it, I FOUND IT!, I FOUND IT!!! Ehmm… and here it is:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">requestContext</span> <span class="k">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">RequestContext</span><span class="o">])</span>

<span class="n">requestContext</span><span class="o">.</span><span class="n">setRequestId</span><span class="o">(</span><span class="nc">RequestId</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span>

<span class="c1">// works again
</span><span class="n">verify</span><span class="o">(</span><span class="n">requestContext</span><span class="o">).</span><span class="n">setRequestId</span><span class="o">(</span><span class="nc">RequestId</span><span class="o">(</span><span class="n">anyLong</span><span class="o">()))</span>
<span class="n">verify</span><span class="o">(</span><span class="n">requestContext</span><span class="o">).</span><span class="n">setRequestId</span><span class="o">(</span>
  <span class="nc">RequestId</span><span class="o">(</span><span class="nc">ArgumentMatchers</span><span class="o">.</span><span class="n">eq</span><span class="o">(</span><span class="mi">123L</span><span class="o">)))</span></code></pre></figure>

<p>A perfect combination of beauty and evil…</p>

<p>The trick that I used here is that Mockito does not care,
where the matcher is located, it only cares about the time when it
is called. As long as I call <code class="highlighter-rouge">anyLong()</code> after the call to
<code class="highlighter-rouge">verify(...)</code> and before the call to <code class="highlighter-rouge">.setRequestId(...)</code>,
Mockito will work. Actually we may wrap <em>any</em> matcher in
as many dummy calls as we want, as in <code class="highlighter-rouge">a(b(c(d(any()))))</code>,
only the fact that it was called counts.</p>

<p>It can’t be worse right? Two tests, two hacks…</p>

<p>But only I wrote my third test, I was slapped by the next problem,
this time caused by default parameters:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">trait</span> <span class="nc">SomeTrait</span> <span class="o">{</span>
 <span class="k">def</span> <span class="n">method</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">100</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span>
<span class="o">}</span>

<span class="n">test</span><span class="o">(</span><span class="s">"..."</span><span class="o">)</span> <span class="o">{</span>
 <span class="k">val</span> <span class="n">someTrait</span> <span class="k">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SomeTrait</span><span class="o">])</span>

 <span class="n">someTrait</span><span class="o">.</span><span class="n">method</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>

 <span class="cm">/* This call fails with:
 * Argument(s) are different! Wanted:
 *  someTrait.method(3, 100);
 * Actual invocations have different arguments:
 *  someTrait.method(3, 0);
 */</span>
 <span class="c1">// verify(someTrait).method(3, 100)
</span>
 <span class="c1">// works
</span> <span class="n">verify</span><span class="o">(</span><span class="n">someTrait</span><span class="o">).</span><span class="n">method</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>WTF? Not again… Another strange problem that forces me
to look under the bonnet.</p>

<p>Let’s look at the bytecode using <code class="highlighter-rouge">javap -c</code>:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">// bytecode of `someTrait.method(3)`
// (some code skipped here)
// 3 - load first arg onto the stack
10: iconst_3

// Scala Magic(TM), call a method to get the second
// argument's default value and push it onto the stack:
// someTrait.method$default$2()
11: aload_0
12: invokeinterface #27,  1

// finally call the `method` method
17: invokeinterface #31,  3
// (some code skipped here)</code></pre></figure>

<p>So the Scala compiler calls a hidden method, with a name
<code class="highlighter-rouge">methodName$default$parameterIndex</code> on the trait,
to figure out what value should be used as a value
of the default parameter. Wow! I didn’t expect something
like that!</p>

<p>If only I could stub this <code class="highlighter-rouge">method$default$2</code> or something <img class="emoji" title=":thinking:" alt=":thinking:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" height="20" width="20">
<img class="emoji" title=":thinking:" alt=":thinking:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" height="20" width="20"> <img class="emoji" title=":thinking:" alt=":thinking:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f914.png" height="20" width="20">
…oh wait I could:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">someTrait</span> <span class="k">=</span> <span class="n">mock</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SomeTrait</span><span class="o">])</span>
<span class="n">when</span><span class="o">(</span><span class="n">someTrait</span><span class="o">.</span><span class="n">method$default$2</span><span class="o">).</span><span class="n">thenReturn</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>

<span class="n">someTrait</span><span class="o">.</span><span class="n">method</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>

<span class="c1">// it works!
</span><span class="n">verify</span><span class="o">(</span><span class="n">someTrait</span><span class="o">).</span><span class="n">method</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">100</span><span class="o">)</span></code></pre></figure>

<p>Excellent. It is working perfectly but now I have three tests
and three hacks. Surely I am doing something wrong here.</p>

<p>And so I harnessed the power of Google (after spending
some time looking at the pictures of stoats;
hey they are really cute) and found this gem:</p>

<p><a href="https://github.com/mockito/mockito-scala">Mockito-Scala</a></p>

<p>I plug it into my project (it even has a special version
for ScalaTest) and suddenly everything started to working
as it should be.</p>

<p>Stubbing works:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.mockito.ArgumentMatchersSugar._</span> <span class="c1">// from Mockito-Scala
</span><span class="k">import</span> <span class="nn">org.mockito.MockitoSugar._</span>
<span class="c1">// Don't import Mockito or ArgumentMatchers
</span>
<span class="k">val</span> <span class="n">requestContext</span> <span class="k">=</span> <span class="n">mock</span><span class="o">[</span><span class="kt">RequestContext</span><span class="o">]</span>
<span class="n">when</span><span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">customerId</span><span class="o">).</span><span class="n">thenReturn</span><span class="o">(</span><span class="nc">CustomerId</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span>
<span class="n">assert</span><span class="o">(</span><span class="n">requestContext</span><span class="o">.</span><span class="n">customerId</span> <span class="o">==</span> <span class="nc">CustomerId</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span></code></pre></figure>

<p>…and verification works:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">requestContext</span> <span class="k">=</span> <span class="n">mock</span><span class="o">[</span><span class="kt">RequestContext</span><span class="o">]</span>

<span class="n">requestContext</span><span class="o">.</span><span class="n">setRequestId</span><span class="o">(</span><span class="nc">RequestId</span><span class="o">(</span><span class="mi">123L</span><span class="o">))</span>

<span class="n">verify</span><span class="o">(</span><span class="n">requestContext</span><span class="o">).</span><span class="n">setRequestId</span><span class="o">(</span><span class="n">eqTo</span><span class="o">(</span><span class="nc">RequestId</span><span class="o">(</span><span class="mi">123L</span><span class="o">)))</span>
<span class="n">verify</span><span class="o">(</span><span class="n">requestContext</span><span class="o">).</span><span class="n">setRequestId</span><span class="o">(</span><span class="n">any</span><span class="o">[</span><span class="kt">RequestId</span><span class="o">])</span>
<span class="o">//</span> <span class="n">but</span> <span class="k">this</span> <span class="n">will</span> <span class="n">not</span> <span class="n">work</span><span class="k">:</span> <span class="kt">verify</span><span class="o">(</span><span class="kt">requestContext</span><span class="o">)</span><span class="kt">.setRequestId</span><span class="o">(</span><span class="kt">any</span><span class="o">)</span></code></pre></figure>

<p>even default parameters work:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">someTrait</span> <span class="k">=</span> <span class="n">mock</span><span class="o">[</span><span class="kt">SomeTrait</span><span class="o">]</span>
<span class="n">someTrait</span><span class="o">.</span><span class="n">method</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="n">verify</span><span class="o">(</span><span class="n">someTrait</span><span class="o">).</span><span class="n">method</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="n">verify</span><span class="o">(</span><span class="n">someTrait</span><span class="o">).</span><span class="n">method</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">100</span><span class="o">)</span></code></pre></figure>

<p>Yay!</p>

<p>Wanna see some real code? <a href="https://github.com/marcin-chwedczuk/blog-problems-when-using-mockito-from-scala/">Click here.</a></p>

<p>References:</p>
<ul>
  <li><a href="https://medium.com/@bruno.bonanno/introduction-to-mockito-scala-ede30769cbda?">Intro to Mockito-Scala (Medium)</a></li>
</ul>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/mc" style="background-image: url(/assets/images/mc.png)"><span class="hidden">mc's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/mc">Marcin Chwedczuk</a></h4>

                        
                            <p> A programmer, a geek, a human</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Warsaw, Poland</span>
                            <span class="author-link icon-link"><a href="http://marcinchwedczuk.pl"> http://marcinchwedczuk.pl</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=Pitfalls%20of%20using%20Mockito%20with%20Scala&amp;url=http://localhost:4000pitfalls-of-using-Mockito-with-Scala" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000pitfalls-of-using-Mockito-with-Scala" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:4000pitfalls-of-using-Mockito-with-Scala" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'marcinchwedczukgithubio'; // required: replace example with your forum shortname
        var disqus_identifier = '/pitfalls-of-using-Mockito-with-Scala';
        var disqus_url = 'http://localhost:4000/pitfalls-of-using-Mockito-with-Scala';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer></article></main>
</div>

            

        

    



<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/mc_cover2.jpg)" href="/jak-zaczac-przygode-z-elektronika">
            <section class="post">
                <h2>Jak zacząć przygodę z elektroniką</h2>
                <p>Parę miesięcy temu postanowiłem powrócić do mojego hobby z czasów dzieciństwa: elektroniki. Powrót, po ponad...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/mc_cover2.jpg)" href="/binary-to-gray-algorithm-explained">
            <section class="post">
                <h2>Binary to Gray algorithm explained</h2>
                <p>Binary to Gray code conversion algorithm is deceptively simple: /* This function converts an unsigned...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Programming is Magic</a> © 2020</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-82096342-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
