<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Passing functions as arguments in Scala. What can go wrong?</title>
    <meta name="description" content="A place where I share my thoughts about programming." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="http://blog.marcinchwedczuk.pl//passing-functions-as-arguments-in-scala-what-can-go-wrong" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Programming is Magic" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Passing functions as arguments in Scala. What can go wrong?" />
    <meta property="og:description" content="A place where I share my thoughts about programming." />
    <meta property="og:url" content="http://blog.marcinchwedczuk.pl//passing-functions-as-arguments-in-scala-what-can-go-wrong" />
    <meta property="og:image" content="/assets/images/mc_cover4.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Passing functions as arguments in Scala. What can go wrong?" />
    <meta name="twitter:description" content="A place where I share my thoughts about programming." />
    <meta name="twitter:url" content="http://blog.marcinchwedczuk.pl//passing-functions-as-arguments-in-scala-what-can-go-wrong" />
    <meta name="twitter:image:src" content="/assets/images/mc_cover4.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Programming is Magic",
    "name": "Passing functions as arguments in Scala. What can go wrong?",
    "url": "http://blog.marcinchwedczuk.pl//passing-functions-as-arguments-in-scala-what-can-go-wrong",
    "image": "/assets/images/mc_cover4.jpg",
    "description": "A place where I share my thoughts about programming."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Programming is Magic" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <!-- <li class="nav-about " role="presentation"><a href="/about">About</a></li> -->

        
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/java">
                    java (29)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: java -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/dotnet">
                    dotnet (11)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: dotnet -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/algorithms">
                    algorithms (7)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: algorithms -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/architecture">
                    architecture (7)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: architecture -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/scala">
                    scala (7)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: scala -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/javascript">
                    javascript (5)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: javascript -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/polish">
                    polish (5)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: polish -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/csharp">
                    csharp (4)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: csharp -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/elektronika">
                    elektronika (4)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: elektronika -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hibernate">
                    hibernate (3)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: hibernate -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/linux">
                    linux (3)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: linux -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/unit-testing">
                    unit-testing (3)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: unit-testing -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hardware-review">
                    hardware-review (2)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: hardware-review -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/cheatsheet">
                    cheatsheet (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: cheatsheet -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/ctf">
                    ctf (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: ctf -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/devcon">
                    devcon (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: devcon -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/eclipse">
                    eclipse (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: eclipse -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/functional-programming">
                    functional-programming (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: functional-programming -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/git">
                    git (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: git -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hacking">
                    hacking (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: hacking -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hardware">
                    hardware (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: hardware -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/kotlin">
                    kotlin (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: kotlin -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/low-level">
                    low-level (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: low-level -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/other">
                    other (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: other -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/postman">
                    postman (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: postman -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/powershell">
                    powershell (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: powershell -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/regex">
                    regex (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: regex -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/security">
                    security (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: security -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/sql">
                    sql (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: sql -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/ssh">
                    ssh (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: ssh -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/tips">
                    tips (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: tips -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/vim">
                    vim (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: vim -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/windows">
                    windows (1)
                    <!-- passing-functions-as-arguments-in-scala-what-can-go-wrong name: windows -->
                </a>
            </li>
        

   </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->



<header class="main-header post-head " style="background-image: url(/assets/images/mc_cover4.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/home.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-test tag-content">

        <header class="post-header">
            <h1 class="post-title">Passing functions as arguments in Scala. What can go wrong?</h1>
            <section class="post-meta">
            <!-- <a href='/'>mc</a> -->

            
                
                    <a href='/author/mc'>Marcin Chwedczuk</a>
                
            
            <time class="post-date" datetime="2020-09-11">11 Sep 2020</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/scala'>Scala</a>,
                    
                
                    
                       <a href='/tag/jvmbloggers'>Jvmbloggers</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>In microservices architecture we often designate a single service for managing the configuration of the entire system.
Libraries like <a href="https://github.com/Netflix/archaius">Archaius</a> make this easy. 
As a side effect, on the code level I often see class declarations like this:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">MyService</span><span class="o">(</span><span class="n">timeoutProperty</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Long</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span></code></pre></figure>

<p>Basically we inject providers for current configuration properties values into classes.
This has two advantages. First, our classes are independent of any library that we are using
for managing configuration. And second, our classes are easy to test - no mocks needed.</p>

<p>Yet this approach can lead to subtle bugs. Say our original code that creates <code class="highlighter-rouge">MyService</code>
looks like this:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">new</span> <span class="nc">MyService</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">currentTimeoutValue</span><span class="o">())</span></code></pre></figure>

<p>Imagine that a few weeks later a Scala purist is coming by and decides to “improve” this code into:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">new</span> <span class="nc">MyService</span><span class="o">(</span><span class="n">currentTimeoutValue</span><span class="o">)</span></code></pre></figure>

<p>Shorter code, better code as they say…
A few more weeks pass by and we realise that using <code class="highlighter-rouge">Long</code>s for storing time intervals is passé.
So now we are slowly migrating our <code class="highlighter-rouge">() =&gt; Long</code> providers into <code class="highlighter-rouge">() =&gt; java.time.Duration</code>.
Of course as Scala fanboys we decided to add an extension method to <code class="highlighter-rouge">Long</code>, to make the entire
process less painful:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">implicit</span> <span class="k">class</span> <span class="nc">MyRichLong</span><span class="o">(</span><span class="n">l</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">asMillisecondsDuration</span><span class="o">()</span><span class="k">:</span> <span class="kt">Duration</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">Duration</span><span class="o">.</span><span class="n">ofMillis</span><span class="o">(</span><span class="n">l</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>In meantime, the code responsible for <code class="highlighter-rouge">MyService</code> creation morphed into:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">MyServiceRefactored</span><span class="o">(</span><span class="n">timeoutProperty</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Duration</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

<span class="k">new</span> <span class="nc">MyServiceRefactored</span><span class="o">(</span><span class="n">currentTimeoutValue</span><span class="o">().</span><span class="n">asMillisecondsDuration</span><span class="o">)</span></code></pre></figure>

<p>And… BOOM! It’s no longer working!</p>

<p>Why this code is no longer working? Because</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">new</span> <span class="nc">MyServiceRefactored</span><span class="o">(</span><span class="n">currentTimeoutValue</span><span class="o">().</span><span class="n">asMillisecondsDuration</span><span class="o">)</span></code></pre></figure>

<p>is transformed by Scala compiler into</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">tmp</span> <span class="k">=</span> <span class="n">currentTimeoutValue</span><span class="o">()</span>
<span class="k">new</span> <span class="nc">MyServiceRefactored</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">tmp</span><span class="o">.</span><span class="n">asMillisecondsDuration</span><span class="o">())</span></code></pre></figure>

<p>So <code class="highlighter-rouge">timeout</code> property value is frozen at the moment of <code class="highlighter-rouge">MyServiceRefactored</code> object creation,
this is not what we want.</p>

<p>Bugs like this are hard to figure out. At the first glance everything works fine.
The problem demonstrates itself only when we try to adjust the property value at runtime.
And even then a simple service restart will reload the property, so we may incorrectly assign
it to a configuration server/library/networking glitch.</p>

<p>Here I must mention that this bug was possible only because we broken one of Scala’s good practices.
Our extension method is declared like so</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">asMillisecondsDuration</span><span class="o">()</span><span class="k">:</span> <span class="kt">Duration</span></code></pre></figure>

<p>but we should be declared like this</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">asMillisecondsDuration</span><span class="k">:</span> <span class="kt">Duration</span></code></pre></figure>

<p>as this method is actually a getter - it does not mutate the object on which it is called.
If we use the second declaration our bug would be quickly detected by Scala compiler.</p>

<p>In practice a lot of Scala programmers are confused by the optional parentheses
in parameterless method declarations. I often see methods declared like <code class="highlighter-rouge">def foo: Unit</code>
that mutate the state or method declared like <code class="highlighter-rouge">def bar(): Int</code> that are just getters.
For people like me, that constantly switch between Java and Scala, this is especially difficult
and I routinely make mistakes like this (I add parentheses everywhere)…</p>

<p>One solution that people often come up with when confronted with this problem is to
replace functions by by-name parameters.</p>

<p>By-name parameters are nothing new. They where first introduced more than 50 years ago in a language called
Algol60. Early programmers of that language quickly found out that by-name parameters are error prone and difficult to use.
As a result most of the contemporary programming languages do not support them.</p>

<p>Scala as <del>an over-engineered</del> a versatile language supports by-name parameters, as they allow programmers
to create functions that mimic the language build-in constructs. For example:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">repeat</span><span class="o">(</span><span class="n">times</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">f</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="k">_</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="n">times</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">f</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">repeat</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">"hurray!"</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>The main problem with by-name parameters is that they do not follow the
usual order of evaluation. An ordinary function call</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">egg</span><span class="o">(</span><span class="n">foo</span><span class="o">()),</span> <span class="n">bar</span><span class="o">())</span></code></pre></figure>

<p>will result in functions <code class="highlighter-rouge">foo</code> and <code class="highlighter-rouge">bar</code> being called one after another,
followed by <code class="highlighter-rouge">egg</code> function call.
When we use by-name parameters no order is guaranteed, <code class="highlighter-rouge">foo</code> may be called
before or after <code class="highlighter-rouge">bar</code> or may not be called at all, 
or may be called three times, or four…
This makes code difficult to reason about.
That is why I use by-name parameters sparingly, usually only when I need to implement a
new statement like construct.</p>

<p>That being said, we may declare our new version of <code class="highlighter-rouge">MyService</code> as</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">MyService</span><span class="o">(</span><span class="n">timeoutProperty</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="nc">Duration</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">...</span>
<span class="o">}</span></code></pre></figure>

<p>and it will work flawlessly with our converted-on-the-fly property:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">new</span> <span class="nc">MyService</span><span class="o">(</span><span class="n">currentTimeoutValue</span><span class="o">().</span><span class="n">asMillisecondsDuration</span><span class="o">())</span></code></pre></figure>

<p>To make it clear that we are passing not a value but an expression to be evaluated
(called a <a href="https://en.wikipedia.org/wiki/Thunk">thunk</a>), 
we can surround the expression with curly braces:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">new</span> <span class="nc">MyService</span><span class="o">({</span> <span class="n">currentTimeoutValue</span><span class="o">().</span><span class="n">asMillisecondsDuration</span><span class="o">()</span> <span class="o">})</span></code></pre></figure>

<p>But it must be noted that in Scala we can add curly braces to almost anything, 
e.g. <code class="highlighter-rouge">println({1} + {2})</code>.
In other words curly braces around thunks are only a convention not enforced by the compiler.</p>

<p>Sometimes the best solution is the object-oriented one. So after being disappointed with by-name
params I decided to create an interface:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nd">@FunctionalInterface</span>
<span class="k">trait</span> <span class="nc">Property</span><span class="o">[</span><span class="kt">V</span><span class="o">]</span> <span class="o">{</span>
  <span class="c1">// parentheses required for lambda -&gt; SAM conversion
</span>  <span class="c1">// in Scala 2.13. Yeah this sucks!
</span>  <span class="k">def</span> <span class="n">value</span><span class="o">()</span><span class="k">:</span> <span class="kt">V</span>
<span class="o">}</span></code></pre></figure>

<p>and inject it into <code class="highlighter-rouge">MyService</code>:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">MyService</span><span class="o">(</span><span class="n">timeoutProperty</span><span class="k">:</span> <span class="kt">Property</span><span class="o">[</span><span class="kt">Duration</span><span class="o">])</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span></code></pre></figure>

<p>Scala since version 2.12 supports converting lambda expressions to SAMs (Single Method Interfaces),
so we can create <code class="highlighter-rouge">MyService</code> without too much ceremony:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">new</span> <span class="nc">MyService</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="n">currentTimeoutValue</span><span class="o">().</span><span class="n">asMillisecondsDuration</span><span class="o">())</span></code></pre></figure>

<p>No simplification is possible this time, and both below examples do not compile:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">new</span> <span class="nc">MyService</span><span class="o">({</span> <span class="n">currentTimeoutValue</span><span class="o">().</span><span class="n">asMillisecondsDuration</span> <span class="o">})</span>
<span class="k">new</span> <span class="nc">MyService</span><span class="o">(</span><span class="n">currentTimeoutValue</span><span class="o">().</span><span class="n">asMillisecondsDuration</span><span class="o">)</span></code></pre></figure>

<p>The protection is, unfortunately, not 100% bullet proof.
For example the following code snipped will compile but does not work as intended:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">new</span> <span class="nc">MyService</span><span class="o">(</span><span class="n">currentTimeoutValue</span><span class="o">().</span><span class="n">asMillisecondsDuration</span> <span class="k">_</span><span class="o">)</span></code></pre></figure>

<p>At least it provides a visual clue (<code class="highlighter-rouge">_</code>) that will attract reviewer attention during the code review.</p>

<p>Now I fully understand why Java designers decided to introduce a new operator <code class="highlighter-rouge">::</code> for creating method
references. It makes it clear which part of the expression will be evaluated only once and which part
will become the functional interface implementation:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
  <span class="n">print</span><span class="o">(</span><span class="n">next</span><span class="o">()::</span><span class="n">toString</span><span class="o">);</span>
  <span class="n">print</span><span class="o">(</span><span class="n">next</span><span class="o">().</span><span class="n">toString</span><span class="o">()::</span><span class="n">toUpperCase</span><span class="o">);</span>
  <span class="n">print</span><span class="o">(</span><span class="n">next</span><span class="o">().</span><span class="n">toString</span><span class="o">().</span><span class="n">toUpperCase</span><span class="o">()::</span><span class="n">trim</span><span class="o">);</span>
  
  <span class="n">print</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">next</span><span class="o">().</span><span class="n">toString</span><span class="o">());</span>
<span class="o">}</span></code></pre></figure>

<p>Compare this with Scala:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">print</span><span class="o">(</span><span class="n">next</span><span class="o">().</span><span class="n">toString</span><span class="o">)</span>
  <span class="n">print</span><span class="o">(</span><span class="n">next</span><span class="o">().</span><span class="n">toString</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">)</span>
  <span class="n">print</span><span class="o">(</span><span class="n">next</span><span class="o">().</span><span class="n">toString</span><span class="o">.</span><span class="n">toUpperCase</span><span class="o">.</span><span class="n">trim</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>Looks likes the third solution is the best one. The only thing left is to provide a fake
implementation for <code class="highlighter-rouge">Property[V]</code> interface to make testing easy:</p>

<figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">class</span> <span class="nc">ManuallySetProperty</span><span class="o">[</span><span class="kt">V</span><span class="o">](</span><span class="n">initialValue</span><span class="k">:</span> <span class="kt">V</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Property</span><span class="o">[</span><span class="kt">V</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">v</span> <span class="k">=</span> <span class="n">initialValue</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">value</span><span class="o">()</span><span class="k">:</span> <span class="kt">V</span> <span class="o">=</span> <span class="n">v</span>
  <span class="k">def</span> <span class="n">setValue</span><span class="o">(</span><span class="n">newValue</span><span class="k">:</span> <span class="kt">V</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">v</span> <span class="k">=</span> <span class="n">newValue</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">toString</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">s</span><span class="s">"property(value=$v)"</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ManuallySetProperty</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="nc">ZERO</span><span class="o">)</span>
<span class="n">println</span><span class="o">(</span><span class="n">timeout</span><span class="o">.</span><span class="n">value</span><span class="o">())</span>
<span class="n">timeout</span><span class="o">.</span><span class="n">setValue</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">ofMinutes</span><span class="o">(</span><span class="mi">3</span><span class="o">))</span>
<span class="n">println</span><span class="o">(</span><span class="n">timeout</span><span class="o">.</span><span class="n">value</span><span class="o">())</span></code></pre></figure>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/mc" style="background-image: url(/assets/images/mc.png)"><span class="hidden">mc's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/mc">Marcin Chwedczuk</a></h4>

                        
                            <p> A programmer, a geek, a human</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Warsaw, Poland</span>
                            <span class="author-link icon-link"><a href="http://marcinchwedczuk.pl"> http://marcinchwedczuk.pl</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=Passing functions as arguments in Scala. What can go wrong?&amp;url=http://blog.marcinchwedczuk.plpassing-functions-as-arguments-in-scala-what-can-go-wrong"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.marcinchwedczuk.plpassing-functions-as-arguments-in-scala-what-can-go-wrong"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=http://blog.marcinchwedczuk.plpassing-functions-as-arguments-in-scala-what-can-go-wrong"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'marcinchwedczukgithubio'; // required: replace example with your forum shortname
        var disqus_identifier = '/passing-functions-as-arguments-in-scala-what-can-go-wrong';
        var disqus_url = 'http://blog.marcinchwedczuk.pl/passing-functions-as-arguments-in-scala-what-can-go-wrong';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/mc_cover6.jpg)" href="/future-or-future">
            <section class="post">
                <h2>Future[_] vs Future[Unit] or which return type should I choose?</h2>
                <p>Recently I have a heated debate with my colleague about a proper return type for...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/mc_cover4.jpg)" href="/preparing-images-for-ben-eater-vga-using-gimp">
            <section class="post">
                <h2>Preparing images for Ben Eater's VGA card using Gimp</h2>
                <p>Recently I have completed my own version of Ben Eater video card. I still need...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Programming is Magic</a> &copy; 2021</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-82096342-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
