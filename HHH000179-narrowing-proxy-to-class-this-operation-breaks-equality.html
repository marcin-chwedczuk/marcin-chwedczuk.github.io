<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Hibernate HHH000179 warning&#58 Narrowing proxy to class this operation breaks ==</title>
    <meta name="description" content="A place where I share my thoughts about programming." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="http://localhost:4000//HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Programming is Magic" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Hibernate HHH000179 warning&#58 Narrowing proxy to class this operation breaks ==" />
    <meta property="og:description" content="A place where I share my thoughts about programming." />
    <meta property="og:url" content="http://localhost:4000//HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality" />
    <meta property="og:image" content="/assets/images/mc_cover6.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Hibernate HHH000179 warning&#58 Narrowing proxy to class this operation breaks ==" />
    <meta name="twitter:description" content="A place where I share my thoughts about programming." />
    <meta name="twitter:url" content="http://localhost:4000//HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality" />
    <meta name="twitter:image:src" content="/assets/images/mc_cover6.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Programming is Magic",
    "name": "Hibernate HHH000179 warning&#58 Narrowing proxy to class this operation breaks ==",
    "url": "http://localhost:4000//HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality",
    "image": "/assets/images/mc_cover6.jpg",
    "description": "A place where I share my thoughts about programming."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Programming is Magic" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <!-- <li class="nav-about " role="presentation"><a href="/about">About</a></li> -->

        
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/java">
                    java (25)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: java -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/dotnet">
                    dotnet (11)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: dotnet -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/architecture">
                    architecture (7)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: architecture -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/algorithms">
                    algorithms (6)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: algorithms -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/javascript">
                    javascript (5)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: javascript -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/csharp">
                    csharp (4)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: csharp -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hibernate">
                    hibernate (3)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: hibernate -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/linux">
                    linux (3)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: linux -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hardware-review">
                    hardware-review (2)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: hardware-review -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/unit-testing">
                    unit-testing (2)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: unit-testing -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/devcon">
                    devcon (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: devcon -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/eclipse">
                    eclipse (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: eclipse -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/git">
                    git (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: git -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/kotlin">
                    kotlin (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: kotlin -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/low-level">
                    low-level (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: low-level -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/postman">
                    postman (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: postman -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/powershell">
                    powershell (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: powershell -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/security">
                    security (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: security -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/sql">
                    sql (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: sql -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/tips">
                    tips (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: tips -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/vim">
                    vim (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: vim -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/windows">
                    windows (1)
                    <!-- HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality name: windows -->
                </a>
            </li>
        

   </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/mc_cover6.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/home.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-test tag-content">

        <header class="post-header">
            <h1 class="post-title">Hibernate HHH000179 warning&#58 Narrowing proxy to class this operation breaks ==</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
                    <a href='/author/mc'>Marcin Chwedczuk</a>
                
            
            <time class="post-date" datetime="2017-07-30">30 Jul 2017</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/java'>Java</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>In this post I will explain why Hibernate is generating the HHH000179
warning and when ignoring it may introduce bugs in your code.</p>

<p>To understand what this “Narrowing proxy” is all about,
first we must learn about Hibernate proxies.
When we read a value of lazy loaded property or when we call
<code class="highlighter-rouge">EntityManager::getReference</code> Hibernate returns a proxy object.
This proxy is an instance of a class that was generated at runtime using
library like <a href="http://jboss-javassist.github.io/javassist/">Javassit</a>.</p>

<p>For example for a simple entity:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"person"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="kd">extends</span> <span class="n">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"person_name"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"house_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">House</span> <span class="n">house</span><span class="o">;</span>

    <span class="nd">@OneToMany</span><span class="o">(</span><span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"owner"</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">,</span> <span class="n">cascade</span> <span class="o">=</span> <span class="n">CascadeType</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">orphanRemoval</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">Pet</span><span class="o">&gt;</span> <span class="n">pets</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;(</span><span class="mi">0</span><span class="o">);</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre></figure>

<p>Generated proxy class looks similar to:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person_</span><span class="err">$</span><span class="n">$_jvst5ed_2</span> 
        <span class="kd">extends</span> <span class="n">Person</span> 
        <span class="kd">implements</span> <span class="n">HibernateProxy</span><span class="o">,</span> <span class="n">ProxyObject</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="n">MethodHandler</span> <span class="n">handler</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Method</span><span class="o">[]</span> <span class="n">_methods_</span><span class="o">;</span>
 
    <span class="c1">// plenty of other stuff here</span>
 
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">UUID</span> <span class="nf">_d7getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">UUID</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Method</span><span class="o">[]</span> <span class="n">var1</span> <span class="o">=</span> <span class="n">_methods_</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">UUID</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">handler</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">var1</span><span class="o">[</span><span class="mi">14</span><span class="o">],</span> <span class="n">var1</span><span class="o">[</span><span class="mi">15</span><span class="o">],</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>TIP: In Hibernate 5.1 you may write generated 
proxy classes to disk by putting a breakpoint
in <a href="https://github.com/hibernate/hibernate-orm/blob/ba3359fe62be258638554fe23a2a0a6a50f7e732/hibernate-core/src/main/java/org/hibernate/proxy/pojo/javassist/JavassistProxyFactory.java#L102"><code class="highlighter-rouge">JavassistProxyFactory::buildJavassistProxyFactory</code></a>
method and setting 
<code class="highlighter-rouge">factory.writeDirectory</code> field to a valid path. 
You may want to use a conditional
breakpoint to avoid doing this manually every time a proxy is generated.</p>

<p>The most important point here is that proxy class <em>extends</em> entity class.</p>

<p>Now let’s see what happens when we mix proxies with inheritance.
Given a simple class hierarchy:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">InheritanceType</span><span class="o">.</span><span class="na">SINGLE_TABLE</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"animal_type"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Pet</span> <span class="kd">extends</span> <span class="n">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"owner_id"</span><span class="o">,</span> <span class="n">nullable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
    <span class="nd">@OneToOne</span><span class="o">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">Person</span> <span class="n">owner</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">String</span> <span class="nf">makeNoise</span><span class="o">();</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"cat"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Cat</span> <span class="kd">extends</span> <span class="n">Pet</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"dog"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Dog</span> <span class="kd">extends</span> <span class="n">Pet</span> <span class="o">{</span> <span class="cm">/* ... */</span> <span class="o">}</span></code></pre></figure>

<p>When we use <code class="highlighter-rouge">EntityManager::getReference</code> to load a <code class="highlighter-rouge">Pet</code> we will
get a proxy that extends <code class="highlighter-rouge">Pet</code> class because Hibernate does not know yet
whatever our pet is a <code class="highlighter-rouge">Cat</code> or a <code class="highlighter-rouge">Dog</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// In some earlier transaction:</span>
<span class="n">Cat</span> <span class="n">gerard</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cat</span><span class="o">(</span><span class="s">"gerard"</span><span class="o">);</span>
<span class="n">entityManager</span><span class="o">.</span><span class="na">persist</span><span class="o">(</span><span class="n">gerard</span><span class="o">);</span>

<span class="n">gerardId</span> <span class="o">=</span> <span class="n">gerard</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>

<span class="c1">// In current transaction:</span>
<span class="n">Pet</span> <span class="n">pet</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">gerardId</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">)</span>
        <span class="o">.</span><span class="na">is</span><span class="o">(</span><span class="n">hibernateProxy</span><span class="o">())</span>
        <span class="o">.</span><span class="na">is</span><span class="o">(</span><span class="n">uninitialized</span><span class="o">())</span>
        <span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="n">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNotInstanceOf</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span></code></pre></figure>

<p>We may force Hiberante to query database to load proxied entity
state but that doesn’t change proxy identity:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// makeNoise() will access field *via getter* to initialize proxy</span>
<span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Pet is a cat: "</span> <span class="o">+</span> <span class="n">pet</span><span class="o">.</span><span class="na">makeNoise</span><span class="o">());</span> <span class="c1">// meow meeeow</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNot</span><span class="o">(</span><span class="n">uninitialized</span><span class="o">())</span>
        <span class="o">.</span><span class="na">isNotInstanceOf</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span></code></pre></figure>

<p>Even though now Hibernate knows that our pet is a <code class="highlighter-rouge">Cat</code> it cannot
change already loaded proxy class definition,
<code class="highlighter-rouge">Pet</code> proxy continues to be so.
This may cause you problems because tests like <code class="highlighter-rouge">pet instanceof Cat</code> will
fail although pet indeed represents a cat.</p>

<p>There is also a second issue that may come up when working with proxies.
If <code class="highlighter-rouge">makeNoise()</code> method would access pet data via field, proxy would not
be notified about that data access and it wouldn’t load data from DB,
causing our method to read an uninitialized field value.
<em>The moral is that we should always use getters and setters 
when dealing with entity state</em>.</p>

<p>Now you may think that if we try to load <code class="highlighter-rouge">Pet</code> again (after proxy was
initialized), Hibernate will return instance of the <code class="highlighter-rouge">Cat</code> entity.
The behavior displayed by Hibernate is slightly different
because of Hibernate first level cache
that prefers returning already
loaded entity instance than creating a new one:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">Pet</span> <span class="n">pet2</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">Pet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">gerardId</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">pet2</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNotInstanceOf</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isSameAs</span><span class="o">(</span><span class="n">pet</span><span class="o">);</span></code></pre></figure>

<p>What will happen when we try to explicitly load a <code class="highlighter-rouge">Cat</code> entity:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// HHH000179: Narrowing proxy to class Cat - this operation breaks ==</span>
<span class="n">Pet</span> <span class="n">pet3</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">gerardId</span><span class="o">);</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">pet3</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isInstanceOf</span><span class="o">(</span><span class="n">Cat</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNot</span><span class="o">(</span><span class="n">hibernateProxy</span><span class="o">());</span></code></pre></figure>

<p>Now we got the famous HHH000179 warning, and Hiberante handled
us unproxied <code class="highlighter-rouge">Cat</code> instance.
But why was this warning generated? Because right now we 
we have two different object (the proxy and the <code class="highlighter-rouge">Cat</code> instance)
in our session that point to exactly the same entity.</p>

<p>Of course the pet proxy is pointing to the cat instance,
and changes applied to e.g. entity instance are reflected in the proxy state:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
    <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"gerard"</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">)</span>
    <span class="o">.</span><span class="na">isNotSameAs</span><span class="o">(</span><span class="n">pet3</span><span class="o">);</span>

<span class="c1">// set via Cat entity</span>
<span class="n">pet3</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"proton"</span><span class="o">);</span>

<span class="c1">// reflected via proxy</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">pet</span><span class="o">.</span><span class="na">getName</span><span class="o">())</span>
    <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"proton"</span><span class="o">);</span></code></pre></figure>

<p>So you may think that having two representation of the same DB row 
in memory is OK,
but the real troubles begin if we do not override <code class="highlighter-rouge">equals()</code> and <code class="highlighter-rouge">hashCode()</code>
methods properly. This is demonstrated by example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// Alice is owner of the cat</span>
<span class="n">Person</span> <span class="n">alice</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">Person</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">aliceId</span><span class="o">);</span>

<span class="c1">// Alice can own and not own the same cat...</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">alice</span><span class="o">.</span><span class="na">getPets</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">pet</span><span class="o">))</span>
        <span class="o">.</span><span class="na">isFalse</span><span class="o">();</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">alice</span><span class="o">.</span><span class="na">getPets</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">pet3</span><span class="o">))</span>
        <span class="o">.</span><span class="na">isTrue</span><span class="o">();</span>

<span class="c1">// But only if we rely on default equals() and </span>
<span class="c1">// hashCode() implementation</span></code></pre></figure>

<p>Fortunately this can be easily fixed by providing <code class="highlighter-rouge">equals()</code> implementation
that is based either on primary key or business key equality, for example:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@MappedSuperclass</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseEntity</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@Type</span><span class="o">(</span><span class="n">type</span><span class="o">=</span><span class="s">"binary(16)"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">UUID</span> <span class="n">id</span><span class="o">;</span>

    <span class="kd">protected</span> <span class="nf">BaseEntity</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">BaseEntity</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="n">BaseEntity</span> <span class="n">that</span> <span class="o">=</span> <span class="o">(</span><span class="n">BaseEntity</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>

        <span class="c1">// remember to use *getters*</span>
        <span class="k">return</span> <span class="nf">getId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getId</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>We may also reproduce above behaviour with lazy loading,
you can find an example of how to do this in the attached source code.</p>

<h4 id="significance-in-the-real-world-application">Significance in the real world application</h4>

<p>Recently I developed a module in an application that was based on huge
in-house framework (Ughhh). This framework let’s call it X
contained some of the entities that we used, but we have no way of
modifying them. The only way to add some fields to an already existing entity
was to extend it (fortunately for us, most entities in X were declared
as base classes with inheritance strategy SINGLE_TABLE).
At the end of this project we had plenty of small class hierarchies
consisting only of super class and a single subclass.
We also had plenty of references from other entities to either
this sup or super classes. As you may expect this was a fertile 
ground for Hibernate HHH000179 warnings, and so I devoted a few hours of
my time to figure out what this warning is all about. In our case
providing proper <code class="highlighter-rouge">equals()</code> and <code class="highlighter-rouge">hashCode()</code> was all that was needed.
But just to sum up I want to present the last, more real world example.</p>

<p>Shipped with framework X:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"extensible_user"</span><span class="o">)</span>
<span class="nd">@Inheritance</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">InheritanceType</span><span class="o">.</span><span class="na">SINGLE_TABLE</span><span class="o">)</span>
<span class="nd">@DiscriminatorColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"discriminator"</span><span class="o">)</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"NOT_USED"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LegacyUser</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userPreference1</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userPreference2</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"document"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LegacyDocument</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">contents</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">false</span><span class="o">,</span> <span class="n">fetch</span> <span class="o">=</span> <span class="n">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"owner_id"</span><span class="o">)</span>
    <span class="c1">// !!! Entity referes to super class !!!</span>
    <span class="kd">private</span> <span class="n">LegacyUser</span> <span class="n">owner</span><span class="o">;</span>

    <span class="c1">// ...</span>
<span class="o">}</span></code></pre></figure>

<p>Shipped with my module:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Entity</span>
<span class="nd">@DiscriminatorValue</span><span class="o">(</span><span class="s">"EXTENDED"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExtendedUser</span> <span class="kd">extends</span> <span class="n">LegacyUser</span> <span class="o">{</span>
    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">userPreference3</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span>

<span class="nd">@Entity</span>
<span class="nd">@Table</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"comment"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Comment</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span>
    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="cm">/*...*/</span><span class="o">)</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"document_id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">LegacyDocument</span> <span class="n">document</span><span class="o">;</span>

    <span class="nd">@ManyToOne</span><span class="o">(</span><span class="cm">/*...*/</span>
    <span class="nd">@JoinColumn</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"author_id"</span><span class="o">)</span>
    <span class="c1">// !!! Entity refers to subclass !!!</span>
    <span class="kd">private</span> <span class="n">ExtendedUser</span> <span class="n">author</span><span class="o">;</span>

    <span class="nd">@Column</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">contents</span><span class="o">;</span>
    <span class="c1">// ...</span>
<span class="o">}</span></code></pre></figure>

<p>As you can see legacy class <code class="highlighter-rouge">Document</code> is using <code class="highlighter-rouge">LegacyUser</code> to refer to
a system user. New class <code class="highlighter-rouge">Comment</code> is using <code class="highlighter-rouge">ExtendedUser</code> to refer to
a system user.</p>

<p>Without proper <code class="highlighter-rouge">equals()</code> implementation we may get into troubles:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">LegacyDocument</span> <span class="n">document</span> <span class="o">=</span> 
    <span class="n">entityManager</span><span class="o">.</span><span class="na">find</span><span class="o">(</span><span class="n">LegacyDocument</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">documentId</span><span class="o">);</span>

<span class="c1">// we load some data from document owner</span>
<span class="n">LegacyUser</span> <span class="n">documentOwner</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="na">getOwner</span><span class="o">();</span>
<span class="n">doSomethingWithOwner</span><span class="o">(</span><span class="n">documentOwner</span><span class="o">);</span>

<span class="c1">// HHH000179: Narrowing proxy to class ExtendedUser </span>
<span class="c1">//  - this operation breaks ==</span>
<span class="c1">// When Hibernate loads comment that has </span>
<span class="c1">// field of type ExtendedUser with the same Id as LegacyUser </span>
<span class="c1">// it realizes that documentOwner is indeed ExtendedUser.</span>
<span class="c1">// So this time Hibernate could figure out that </span>
<span class="c1">// it generated wrong proxy without querying DB.</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Comment</span><span class="o">&gt;</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span>
            <span class="s">"select c from Comment c where c.document.id = :docId"</span><span class="o">,</span>
            <span class="n">Comment</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setParameter</span><span class="o">(</span><span class="s">"docId"</span><span class="o">,</span> <span class="n">document</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
        <span class="o">.</span><span class="na">getResultList</span><span class="o">();</span>

<span class="c1">// Now the most interesting part</span>
<span class="n">ExtendedUser</span> <span class="n">commentAuthor</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="na">getAuthor</span><span class="o">();</span>

<span class="c1">// comment author and doc author is the same user</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">commentAuthor</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span>
        <span class="o">.</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">documentOwner</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>

<span class="c1">// but...</span>
<span class="n">assertThat</span><span class="o">(</span><span class="n">commentAuthor</span><span class="o">)</span>
        <span class="o">.</span><span class="na">isNotSameAs</span><span class="o">(</span><span class="n">documentOwner</span><span class="o">);</span>

<span class="c1">// Now without overloading hashCode()/equals() we may</span>
<span class="c1">// expect troubles...</span>
<span class="n">Set</span><span class="o">&lt;</span><span class="n">LegacyUser</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
<span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">commentAuthor</span><span class="o">);</span>
<span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">documentOwner</span><span class="o">);</span>

<span class="n">assertThat</span><span class="o">(</span><span class="n">users</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span></code></pre></figure>

<p>And that is all that I wanted to say about HHH000179. 
The most important thing that
you should remember from this article is that with 
good <code class="highlighter-rouge">equals()</code> and <code class="highlighter-rouge">hashCode()</code> implementation
HHH000179 warning can be safely ignored.</p>

<p>Source code: <a href="https://github.com/marcin-chwedczuk/hibernate_narrowing_proxy_warning_demo">https://github.com/marcin-chwedczuk/hibernate_narrowing_proxy_warning_demo</a></p>



        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/mc" style="background-image: url(/assets/images/mc.png)"><span class="hidden">mc's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/mc">Marcin Chwedczuk</a></h4>

                        
                            <p> A programmer, a geek, a human</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Warsaw, Poland</span>
                            <span class="author-link icon-link"><a href="http://marcinchwedczuk.pl"> http://marcinchwedczuk.pl</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=Hibernate HHH000179 warning&#58 Narrowing proxy to class this operation breaks ==&amp;url=http://localhost:4000HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:4000HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'marcinchwedczukgithubio'; // required: replace example with your forum shortname
        var disqus_identifier = '/HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality';
        var disqus_url = 'http://localhost:4000/HHH000179-narrowing-proxy-to-class-this-operation-breaks-equality';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/mc_cover6.jpg)" href="/dont-ask-me-about-singletons">
            <section class="post">
                <h2>Don't ask me about Singletons</h2>
                <p>Some time ago I attended a job interview for C# developer position in Warsaw. One...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/mc_cover6.jpg)" href="/debugging-openjdk8-with-netbeans-on-ubuntu">
            <section class="post">
                <h2>Debugging OpenJDK 8 with NetBeans on Ubuntu</h2>
                <p>In this post we will learn how to download, compile and debug OpenJDK 8 using...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Programming is Magic</a> &copy; 2019</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-82096342-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
