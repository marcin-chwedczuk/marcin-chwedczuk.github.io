<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Indexes in PostgreSQL database</title>
    <meta name="description" content="A place where I share my thoughts about programming." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="http://blog.marcinchwedczuk.pl//indexes-in-postgresql" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Programming is Magic" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Indexes in PostgreSQL database" />
    <meta property="og:description" content="A place where I share my thoughts about programming." />
    <meta property="og:url" content="http://blog.marcinchwedczuk.pl//indexes-in-postgresql" />
    <meta property="og:image" content="/assets/images/mc_cover2.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Indexes in PostgreSQL database" />
    <meta name="twitter:description" content="A place where I share my thoughts about programming." />
    <meta name="twitter:url" content="http://blog.marcinchwedczuk.pl//indexes-in-postgresql" />
    <meta name="twitter:image:src" content="/assets/images/mc_cover2.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Programming is Magic",
    "name": "Indexes in PostgreSQL database",
    "url": "http://blog.marcinchwedczuk.pl//indexes-in-postgresql",
    "image": "/assets/images/mc_cover2.jpg",
    "description": "A place where I share my thoughts about programming."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Programming is Magic" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <!-- <li class="nav-about " role="presentation"><a href="/about">About</a></li> -->

        
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/java">
                    java (29)
                    <!-- indexes-in-postgresql name: java -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/dotnet">
                    dotnet (11)
                    <!-- indexes-in-postgresql name: dotnet -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/algorithms">
                    algorithms (7)
                    <!-- indexes-in-postgresql name: algorithms -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/architecture">
                    architecture (7)
                    <!-- indexes-in-postgresql name: architecture -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/scala">
                    scala (7)
                    <!-- indexes-in-postgresql name: scala -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/javascript">
                    javascript (5)
                    <!-- indexes-in-postgresql name: javascript -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/csharp">
                    csharp (4)
                    <!-- indexes-in-postgresql name: csharp -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/polish">
                    polish (4)
                    <!-- indexes-in-postgresql name: polish -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/elektronika">
                    elektronika (3)
                    <!-- indexes-in-postgresql name: elektronika -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hibernate">
                    hibernate (3)
                    <!-- indexes-in-postgresql name: hibernate -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/linux">
                    linux (3)
                    <!-- indexes-in-postgresql name: linux -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/unit-testing">
                    unit-testing (3)
                    <!-- indexes-in-postgresql name: unit-testing -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hardware-review">
                    hardware-review (2)
                    <!-- indexes-in-postgresql name: hardware-review -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/cheatsheet">
                    cheatsheet (1)
                    <!-- indexes-in-postgresql name: cheatsheet -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/ctf">
                    ctf (1)
                    <!-- indexes-in-postgresql name: ctf -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/devcon">
                    devcon (1)
                    <!-- indexes-in-postgresql name: devcon -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/eclipse">
                    eclipse (1)
                    <!-- indexes-in-postgresql name: eclipse -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/functional-programming">
                    functional-programming (1)
                    <!-- indexes-in-postgresql name: functional-programming -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/git">
                    git (1)
                    <!-- indexes-in-postgresql name: git -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hacking">
                    hacking (1)
                    <!-- indexes-in-postgresql name: hacking -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hardware">
                    hardware (1)
                    <!-- indexes-in-postgresql name: hardware -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/kotlin">
                    kotlin (1)
                    <!-- indexes-in-postgresql name: kotlin -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/low-level">
                    low-level (1)
                    <!-- indexes-in-postgresql name: low-level -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/other">
                    other (1)
                    <!-- indexes-in-postgresql name: other -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/postman">
                    postman (1)
                    <!-- indexes-in-postgresql name: postman -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/powershell">
                    powershell (1)
                    <!-- indexes-in-postgresql name: powershell -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/regex">
                    regex (1)
                    <!-- indexes-in-postgresql name: regex -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/security">
                    security (1)
                    <!-- indexes-in-postgresql name: security -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/sql">
                    sql (1)
                    <!-- indexes-in-postgresql name: sql -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/ssh">
                    ssh (1)
                    <!-- indexes-in-postgresql name: ssh -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/tips">
                    tips (1)
                    <!-- indexes-in-postgresql name: tips -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/vim">
                    vim (1)
                    <!-- indexes-in-postgresql name: vim -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/windows">
                    windows (1)
                    <!-- indexes-in-postgresql name: windows -->
                </a>
            </li>
        

   </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->



<header class="main-header post-head " style="background-image: url(/assets/images/mc_cover2.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/home.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-test tag-content">

        <header class="post-header">
            <h1 class="post-title">Indexes in PostgreSQL database</h1>
            <section class="post-meta">
            <!-- <a href='/'>mc</a> -->

            
                
                    <a href='/author/mc'>Marcin Chwedczuk</a>
                
            
            <time class="post-date" datetime="2016-08-06">06 Aug 2016</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/sql'>Sql</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>In this article I will present how to use indexes in PostgreSQL database.</p>

<p>We will need test database for exercises so let’s create one:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">database</span> <span class="n">index_demo</span><span class="p">;</span></code></pre></figure>

<p>Inside <code class="highlighter-rouge">index_demo</code> database we should create three tables:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">account</span>
<span class="p">(</span>
    <span class="n">account_id</span> <span class="n">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span> 
    <span class="n">email</span> <span class="n">text</span><span class="p">,</span> 
    <span class="n">first_name</span> <span class="n">text</span><span class="p">,</span> 
    <span class="n">last_name</span> <span class="n">text</span><span class="p">,</span> 
    <span class="n">is_active</span> <span class="n">boolean</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">first_name</span> 
<span class="p">(</span>
    <span class="n">id</span> <span class="n">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">first_name</span> <span class="n">text</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">last_name</span>
<span class="p">(</span>
    <span class="n">id</span> <span class="n">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
    <span class="n">last_name</span> <span class="n">text</span>
<span class="p">);</span></code></pre></figure>

<p><code class="highlighter-rouge">account</code> table will be used in exercises, <code class="highlighter-rouge">first_name</code> and <code class="highlighter-rouge">last_name</code> tables
will be needed to load test data.</p>

<p>To populate <code class="highlighter-rouge">account</code> table we will use <a href="http://www.quietaffiliate.com/free-first-name-and-last-name-databases-csv-and-sql/">freely available database of
most popular first names and last names</a>.
Please download <a href="assets/data/2016-08-06/first_name.csv">first_name.csv</a> and
<a href="assets/data/2016-08-06/last_name.csv">last_name.csv</a> files.</p>

<p>We will use SQL <code class="highlighter-rouge">copy</code> command to load data from CSV files into <code class="highlighter-rouge">first_name</code> and <code class="highlighter-rouge">last_name</code>
tables:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">copy</span> <span class="n">first_name</span><span class="p">(</span><span class="n">first_name</span><span class="p">)</span> 
<span class="k">from</span> <span class="s1">'/path_to/first_name.csv'</span> 
<span class="k">with</span> <span class="n">csv</span> <span class="k">delimiter</span> <span class="s1">','</span><span class="p">;</span>

<span class="k">copy</span> <span class="n">last_name</span><span class="p">(</span><span class="n">last_name</span><span class="p">)</span> 
<span class="k">from</span> <span class="s1">'/path_to/last_name.csv'</span> 
<span class="k">with</span> <span class="n">csv</span> <span class="k">delimiter</span> <span class="s1">','</span><span class="p">;</span></code></pre></figure>

<p>This command must be run from PostgreSQL account that was created with <code class="highlighter-rouge">superuser</code> option.
You may check if your current account is <code class="highlighter-rouge">superuser</code> by executing query:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">show</span> <span class="n">is_superuser</span><span class="p">;</span>
<span class="c1">-- if you get '1', 'on' or 'yes' then you are a superuser</span></code></pre></figure>

<p>On Ubuntu you can create <code class="highlighter-rouge">superuser</code> account using command:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ sudo -u postgres psql -c "create role super_user with login superuser password '1234'"</code></pre></figure>

<p>After loading data from CSV files you should have a bunch of first and last names in
<code class="highlighter-rouge">first_name</code> and <code class="highlighter-rouge">last_name</code> tables:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">first_name</span><span class="p">;</span>
<span class="c1">-- 5164</span>
<span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">last_name</span><span class="p">;</span>
<span class="c1">-- 88798</span></code></pre></figure>

<p>Now we may use data from <code class="highlighter-rouge">first_name</code> and <code class="highlighter-rouge">last_name</code> to populate <code class="highlighter-rouge">account</code> table:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">insert</span> <span class="k">into</span> <span class="n">account</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">is_active</span><span class="p">)</span>
<span class="k">select</span> 
    <span class="c1">-- create email by joining first letter of first name, dot and last name</span>
    <span class="k">lower</span><span class="p">(</span><span class="k">substring</span><span class="p">(</span><span class="n">F</span><span class="p">.</span><span class="n">first_name</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">1</span><span class="p">)</span><span class="o">||</span><span class="s1">'.'</span><span class="o">||</span><span class="n">L</span><span class="p">.</span><span class="n">last_name</span><span class="o">||</span><span class="s1">'@example.com'</span><span class="p">)</span> <span class="k">as</span> <span class="n">email</span><span class="p">,</span>
    <span class="n">F</span><span class="p">.</span><span class="n">first_name</span> <span class="k">as</span> <span class="n">first_name</span><span class="p">,</span>
    <span class="n">L</span><span class="p">.</span><span class="n">last_name</span>  <span class="k">as</span> <span class="n">last_name</span><span class="p">,</span>
    <span class="k">true</span> <span class="k">as</span> <span class="n">is_active</span>
<span class="k">from</span> <span class="p">(</span>
    <span class="k">select</span> 
        <span class="n">last_name</span><span class="p">,</span>
        <span class="c1">-- select random number from 1 to count_of_first_names</span>
        <span class="n">ceil</span><span class="p">(</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">from</span> <span class="n">first_name</span><span class="p">))</span> <span class="k">as</span> <span class="n">first_name_index</span>
    <span class="k">from</span> <span class="n">last_name</span>
<span class="p">)</span> <span class="n">L</span>
<span class="k">inner</span> <span class="k">join</span> <span class="p">(</span>
    <span class="k">select</span> 
        <span class="n">first_name</span><span class="p">,</span> 
        <span class="c1">-- number first names from 1 to count_of_first_names</span>
        <span class="n">row_number</span><span class="p">()</span> <span class="n">over</span> <span class="p">()</span> <span class="k">as</span> <span class="k">index</span>
    <span class="k">from</span> <span class="n">first_name</span>
<span class="p">)</span> <span class="n">F</span> <span class="k">on</span> <span class="n">F</span><span class="p">.</span><span class="k">index</span> <span class="o">=</span> <span class="n">L</span><span class="p">.</span><span class="n">first_name_index</span>
<span class="c1">-- we join on first_name_index, so each last_name will get random first_name</span></code></pre></figure>

<p>After executing this query <code class="highlighter-rouge">account</code> table will contain test data:
<img src="assets/images/2016-08-06/account_data.png" alt="Data in account table" /></p>

<h4 id="unique-indexes">Unique Indexes</h4>

<p>Often we want to enforce uniqueness of values in given table column.
For example each user should have unique login, there should be
only one person with given national id etc.
Databases allow us to implement such a constraint via unique index.</p>

<p>We will add unique index to <code class="highlighter-rouge">account</code> table to
ensure that each account email is unique:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- udx_account_email is index name</span>
<span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">udx_account_email</span> <span class="k">on</span> <span class="n">account</span><span class="p">(</span><span class="n">email</span><span class="p">)</span></code></pre></figure>

<p>If in the future we decide that after all emails may repeat, we may
drop (remove) index using:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">drop</span> <span class="k">index</span> <span class="n">udx_account_email</span><span class="p">;</span></code></pre></figure>

<p>Let’s check how it works:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">insert</span> <span class="k">into</span> <span class="n">account</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">is_active</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="s1">'j.doe@example.com'</span><span class="p">,</span> <span class="s1">'jon'</span><span class="p">,</span> <span class="s1">'doe'</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
<span class="c1">-- OK</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">account</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">is_active</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="s1">'j.doe@example.com'</span><span class="p">,</span> <span class="s1">'joseph'</span><span class="p">,</span> <span class="s1">'doe'</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
<span class="c1">-- ERROR:  duplicate key value violates unique constraint "udx_account_email"</span>
<span class="c1">-- DETAIL:  Key (email)=(j.doe@example.com) already exists.</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">account</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">is_active</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="s1">'J.doe@example.com'</span><span class="p">,</span> <span class="s1">'joseph'</span><span class="p">,</span> <span class="s1">'doe'</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
<span class="c1">-- OK</span></code></pre></figure>

<p>Looks like our index works, but uses case sensitive check to compare two emails.
It would be better to ignore case when performing check, we may achieve this by using
<code class="highlighter-rouge">lower</code> function (converts strings to lower case) in our index definition:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">drop</span> <span class="k">index</span> <span class="n">udx_account_email</span><span class="p">;</span>
<span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">udx_account_email</span> <span class="k">on</span> <span class="n">account</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">email</span><span class="p">));</span></code></pre></figure>

<p>Now index will check if <code class="highlighter-rouge">lower(email)</code> value is unique across table:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">delete</span> <span class="k">from</span> <span class="n">account</span> <span class="k">where</span> <span class="n">last_name</span> <span class="k">like</span> <span class="s1">'doe'</span><span class="p">;</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">account</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">is_active</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="s1">'j.doe@example.com'</span><span class="p">,</span> <span class="s1">'joe'</span><span class="p">,</span> <span class="s1">'doe'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="c1">-- OK</span>

<span class="k">insert</span> <span class="k">into</span> <span class="n">account</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">is_active</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="s1">'J.doe@example.com'</span><span class="p">,</span> <span class="s1">'joseph'</span><span class="p">,</span> <span class="s1">'doe'</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
<span class="c1">-- ERROR:  duplicate key value violates unique constraint "udx_account_email"</span>
<span class="c1">-- DETAIL:  Key (lower(email))=(j.doe@example.com) already exists.</span></code></pre></figure>

<h4 id="standard-indexes">Standard Indexes</h4>

<p>In databases indexes are mainly used to speed up queries.
By keeping additional information database can retrieve values more
quickly.
The following example will illustrate that:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">first_name</span> <span class="k">like</span> <span class="s1">'Michael'</span>

<span class="c1">-- Seq Scan on account  (cost=0.00..1907.98 rows=17 width=39)</span>
<span class="c1">--   Filter: (first_name ~~ 'Michael'::text)</span></code></pre></figure>

<p>We can use <code class="highlighter-rouge">explain</code> to ask database how it will execute query.
In our example since we don’t have any index on <code class="highlighter-rouge">first_name</code> column
database will read every row in the table (that’s what Seq Scan mean)
and then check if <code class="highlighter-rouge">fist_name</code> is equal to <code class="highlighter-rouge">Michael</code>. If our table
would contain millions of rows this would be really slow.
To speed things up we may add index on <code class="highlighter-rouge">first_name</code> column 
that will keep track where rows with given <code class="highlighter-rouge">first_name</code> are stored:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">index</span> <span class="n">idx_account_first_name</span> <span class="k">on</span> <span class="n">account</span><span class="p">(</span><span class="n">first_name</span><span class="p">);</span>

<span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">first_name</span> <span class="k">like</span> <span class="s1">'Michael'</span>

<span class="c1">-- Index Scan using idx_account_first_name on account  (cost=0.29..8.63 rows=17 width=39)</span>
<span class="c1">--  Index Cond: (first_name = 'Michael'::text)</span>
<span class="c1">--  Filter: (first_name ~~ 'Michael'::text)</span></code></pre></figure>

<p>Now we can see that database will use index to perform search (Index Scan).
When we look at <code class="highlighter-rouge">cost</code> returned by explain we can see that
now it’s equal to <code class="highlighter-rouge">0.29 - 8.63</code>, and without index it was equal to <code class="highlighter-rouge">0 - 1907.98</code>. 
This means that we should expect x200 performance improvement especially
with more rows in account table.</p>

<p>Indexes are great way to speed queries up but they come with a cost, database must
update index every time you insert a new row into table or update existing one.
Adding too many indexes to table may actually slow things down, be warned.</p>

<h4 id="multicolumn-indexes">Multicolumn Indexes</h4>

<p>PostgreSQL allows us to define index on multiple columns.
For example let’s say that we want to speed up query that filters
accounts by first name and last name:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- we use analyze option here to get total query running time</span>

<span class="k">explain</span> <span class="k">analyze</span> <span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">first_name</span> <span class="k">like</span> <span class="s1">'Heber'</span> <span class="k">and</span> <span class="n">first_name</span> <span class="k">like</span> <span class="s1">'Michael'</span>

<span class="c1">-- Index Scan using idx_account_first_name on account  (cost=0.29..8.32 rows=1 width=39) (actual time=0.001..0.001 rows=0 loops=1)</span>
<span class="c1">--  Index Cond: ((first_name = 'Heber'::text) AND (first_name = 'Michael'::text))</span>
<span class="c1">--  Filter: ((first_name ~~ 'Heber'::text) AND (first_name ~~ 'Michael'::text))</span>
<span class="c1">-- Total runtime: 0.017 ms</span></code></pre></figure>

<p>As we can see this query uses <code class="highlighter-rouge">idx_account_first_name</code> index that we created in
previous section and has quite good performance already.
But we can do even better by creating index on <code class="highlighter-rouge">first_name</code> and <code class="highlighter-rouge">last_name</code> column:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">drop</span> <span class="k">index</span> <span class="n">idx_account_first_name</span><span class="p">;</span>

<span class="k">create</span> <span class="k">index</span> <span class="n">idx_acount_first_name_last_name</span> 
    <span class="k">on</span> <span class="n">account</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">)</span></code></pre></figure>

<p>Now we get:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">explain</span> <span class="k">analyze</span> <span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">last_name</span> <span class="k">like</span> <span class="s1">'Heber'</span> <span class="k">and</span> <span class="n">first_name</span> <span class="k">like</span> <span class="s1">'Michael'</span>

<span class="c1">-- Index Scan using idx_acount_first_name_last_name on account  (cost=0.42..8.44 rows=1 width=39) (actual time=0.001..0.001 rows=0 loops=1)</span>
<span class="c1">--  Index Cond: ((first_name = 'Heber'::text) AND (first_name = 'Michael'::text))</span>
<span class="c1">--  Filter: ((first_name ~~ 'Heber'::text) AND (first_name ~~ 'Michael'::text))</span>
<span class="c1">-- Total runtime: 0.013 ms</span></code></pre></figure>

<p>We didn’t gain much in this example (running time 0.017 ms vs 0.013 ms) 
but it’s worth to know that
multicolumn indexes are available in PostgreSQL.</p>

<p>If we define index on columns <code class="highlighter-rouge">col1, ..., colN</code> PostgreSQL can use it
to optimize queries that test for equality/inequality for columns <code class="highlighter-rouge">col1 ... colK</code> and
that use comparisons (equal, greater then, less than etc.) on <code class="highlighter-rouge">col(K+1)</code>.
In other words our multicolumn index will be used to optimize queries:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- we test first index column for equality</span>
<span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">first_name</span> <span class="k">like</span> <span class="s1">'Michael'</span><span class="p">;</span>

<span class="c1">-- we test first index column for equality</span>
<span class="c1">-- and perform comparison on second index column:</span>
<span class="c1">-- last_name must be greater than 'A' and less than 'B' (in lexicographic order)</span>
<span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">first_name</span> <span class="k">like</span> <span class="s1">'Michael'</span> <span class="k">and</span> <span class="n">last_name</span> <span class="k">like</span> <span class="s1">'A%'</span></code></pre></figure>

<p>But our index cannot be used to optimise query:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- first_name is not used in where, index can be only used</span>
<span class="c1">-- when we test for equality/inequality on first_name and</span>
<span class="c1">-- perform some additional test on last_name</span>
<span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">last_name</span> <span class="k">like</span> <span class="s1">'Heber'</span></code></pre></figure>

<p>The last thing to remember is that multicolumn indexes can take up a lot of space
on disk. We can get size of all indexes for given table via query:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_indexes_size</span><span class="p">(</span><span class="s1">'account'</span><span class="p">));</span>
<span class="c1">-- 4896 kB</span>

<span class="c1">-- while using single column index on first_name:</span>
<span class="k">select</span> <span class="n">pg_size_pretty</span><span class="p">(</span><span class="n">pg_indexes_size</span><span class="p">(</span><span class="s1">'account'</span><span class="p">));</span>
<span class="c1">-- 4040 kB</span></code></pre></figure>

<h4 id="partial-indexes">Partial Indexes</h4>

<p>Sometime we want to index only part of the table rows. In our example we may
want to index <code class="highlighter-rouge">email</code>s of only active users.
To support such scenarios PostgreSQL provides partial indexes.
For example:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- you must use where clause to specify </span>
<span class="c1">-- which rows should be included in index</span>

<span class="k">create</span> <span class="k">index</span> <span class="n">idx_email_active_account</span> <span class="k">on</span> <span class="n">account</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">is_active</span><span class="p">;</span></code></pre></figure>

<p>After index creation database will use index to speed up queries like:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- we search only active accounts</span>
<span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">email</span> <span class="k">like</span> <span class="s1">'foo'</span> <span class="k">and</span> <span class="n">is_active</span> <span class="o">=</span> <span class="k">true</span></code></pre></figure>

<p>But will use SeqScan to perform queries:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="c1">-- we may want to include not active accounts</span>
<span class="k">select</span> <span class="o">*</span> 
<span class="k">from</span> <span class="n">account</span>
<span class="k">where</span> <span class="n">email</span> <span class="k">like</span> <span class="s1">'foo'</span></code></pre></figure>

<h4 id="the-end">The End</h4>
<p>That’s all for today, thanks for reading.</p>

<p>If you have any suggestion how I can improve this blog please
leave a comment!</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/mc" style="background-image: url(/assets/images/mc.png)"><span class="hidden">mc's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/mc">Marcin Chwedczuk</a></h4>

                        
                            <p> A programmer, a geek, a human</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Warsaw, Poland</span>
                            <span class="author-link icon-link"><a href="http://marcinchwedczuk.pl"> http://marcinchwedczuk.pl</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=Indexes in PostgreSQL database&amp;url=http://blog.marcinchwedczuk.plindexes-in-postgresql"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.marcinchwedczuk.plindexes-in-postgresql"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=http://blog.marcinchwedczuk.plindexes-in-postgresql"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'marcinchwedczukgithubio'; // required: replace example with your forum shortname
        var disqus_identifier = '/indexes-in-postgresql';
        var disqus_url = 'http://blog.marcinchwedczuk.pl/indexes-in-postgresql';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/mc_cover2.jpg)" href="/iterative-algorithm-for-drawing-hilbert-curve">
            <section class="post">
                <h2>Iterative algorithm for drawing Hilbert curve</h2>
                <p>In this post I will describe how to draw Hilbert curve iteratively. To avoid recursion...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/mc_cover3.jpg)" href="/how-to-use-find-command">
            <section class="post">
                <h2>How to use find command</h2>
                <p>Linux find command may be used to find files and directories that meet specified conditions....</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Programming is Magic</a> &copy; 2021</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-82096342-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
