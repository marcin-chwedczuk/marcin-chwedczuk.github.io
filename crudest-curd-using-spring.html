<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Crudest CRUD using Spring</title>
    <meta name="description" content="A place where I share my thoughts about programming." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="http://localhost:4000//crudest-curd-using-spring" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Programming is Magic" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Crudest CRUD using Spring" />
    <meta property="og:description" content="A place where I share my thoughts about programming." />
    <meta property="og:url" content="http://localhost:4000//crudest-curd-using-spring" />
    <meta property="og:image" content="/assets/images/mc_cover9.jpeg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Crudest CRUD using Spring" />
    <meta name="twitter:description" content="A place where I share my thoughts about programming." />
    <meta name="twitter:url" content="http://localhost:4000//crudest-curd-using-spring" />
    <meta name="twitter:image:src" content="/assets/images/mc_cover9.jpeg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Programming is Magic",
    "name": "Crudest CRUD using Spring",
    "url": "http://localhost:4000//crudest-curd-using-spring",
    "image": "/assets/images/mc_cover9.jpeg",
    "description": "A place where I share my thoughts about programming."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Programming is Magic" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <!-- <li class="nav-about " role="presentation"><a href="/about">About</a></li> -->

        
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/java">
                    java (28)
                    <!-- crudest-curd-using-spring name: java -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/dotnet">
                    dotnet (11)
                    <!-- crudest-curd-using-spring name: dotnet -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/algorithms">
                    algorithms (7)
                    <!-- crudest-curd-using-spring name: algorithms -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/architecture">
                    architecture (7)
                    <!-- crudest-curd-using-spring name: architecture -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/scala">
                    scala (7)
                    <!-- crudest-curd-using-spring name: scala -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/javascript">
                    javascript (5)
                    <!-- crudest-curd-using-spring name: javascript -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/csharp">
                    csharp (4)
                    <!-- crudest-curd-using-spring name: csharp -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hibernate">
                    hibernate (3)
                    <!-- crudest-curd-using-spring name: hibernate -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/linux">
                    linux (3)
                    <!-- crudest-curd-using-spring name: linux -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/polish">
                    polish (3)
                    <!-- crudest-curd-using-spring name: polish -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/unit-testing">
                    unit-testing (3)
                    <!-- crudest-curd-using-spring name: unit-testing -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/elektronika">
                    elektronika (2)
                    <!-- crudest-curd-using-spring name: elektronika -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hardware-review">
                    hardware-review (2)
                    <!-- crudest-curd-using-spring name: hardware-review -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/cheatsheet">
                    cheatsheet (1)
                    <!-- crudest-curd-using-spring name: cheatsheet -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/devcon">
                    devcon (1)
                    <!-- crudest-curd-using-spring name: devcon -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/eclipse">
                    eclipse (1)
                    <!-- crudest-curd-using-spring name: eclipse -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/functional-programming">
                    functional-programming (1)
                    <!-- crudest-curd-using-spring name: functional-programming -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/git">
                    git (1)
                    <!-- crudest-curd-using-spring name: git -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hacking">
                    hacking (1)
                    <!-- crudest-curd-using-spring name: hacking -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/hardware">
                    hardware (1)
                    <!-- crudest-curd-using-spring name: hardware -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/kotlin">
                    kotlin (1)
                    <!-- crudest-curd-using-spring name: kotlin -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/low-level">
                    low-level (1)
                    <!-- crudest-curd-using-spring name: low-level -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/other">
                    other (1)
                    <!-- crudest-curd-using-spring name: other -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/postman">
                    postman (1)
                    <!-- crudest-curd-using-spring name: postman -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/powershell">
                    powershell (1)
                    <!-- crudest-curd-using-spring name: powershell -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/regex">
                    regex (1)
                    <!-- crudest-curd-using-spring name: regex -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/security">
                    security (1)
                    <!-- crudest-curd-using-spring name: security -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/sql">
                    sql (1)
                    <!-- crudest-curd-using-spring name: sql -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/tips">
                    tips (1)
                    <!-- crudest-curd-using-spring name: tips -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/vim">
                    vim (1)
                    <!-- crudest-curd-using-spring name: vim -->
                </a>
            </li>
        
            
            
            <li class="nav-about " role="presentation">
                <a href="/tag/windows">
                    windows (1)
                    <!-- crudest-curd-using-spring name: windows -->
                </a>
            </li>
        

   </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->



<header class="main-header post-head " style="background-image: url(/assets/images/mc_cover9.jpeg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/home.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-test tag-content">

        <header class="post-header">
            <h1 class="post-title">Crudest CRUD using Spring</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
                    <a href='/author/mc'>Marcin Chwedczuk</a>
                
            
            <time class="post-date" datetime="2016-12-27">27 Dec 2016</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/java'>Java</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>EDIT: In this post I’ll use Spring XML configuration, in new
applications you should definitely use Spring JavaConfig configuration (via
annotations and Java classes).
For more info see reddit comment discussion <a href="https://www.reddit.com/r/springsource/comments/5mjwa2/100_crudest_crud_using_spring_and_jdbc/">here</a>.</p>

<p>In this blog post we will create simple CRUD (Create Retrieve Update Delete)
application using Spring and JDBC.
Before we start we need to setup our database.
I will assume that you already have Postgres running on your box.</p>

<h4 id="setup-database">Setup database</h4>

<p>Because we want to follow good programming practices we will create a
separate user in Postgres database dedicated only for our application.
Open pgAdmin and execute following SQL to create user <code class="highlighter-rouge">crud</code>:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">user</span> <span class="n">crud</span>
  <span class="k">with</span> <span class="n">password</span> <span class="s1">'crud'</span><span class="p">;</span></code></pre></figure>

<p>Next create <code class="highlighter-rouge">cruddb</code> database with <code class="highlighter-rouge">crud</code> as db owner:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">database</span> <span class="n">cruddb</span>
  <span class="k">with</span> <span class="k">owner</span> <span class="n">crud</span>
       <span class="k">encoding</span> <span class="s1">'utf-8'</span><span class="p">;</span></code></pre></figure>

<p>Now it’s time to switch to <code class="highlighter-rouge">cruddb</code> database and create
<code class="highlighter-rouge">app_data</code> table:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">app_data</span> <span class="p">(</span>
  <span class="n">id</span> <span class="n">serial</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="k">index</span> <span class="n">int</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">value</span> <span class="n">text</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span></code></pre></figure>

<p>We should create this table logged as <code class="highlighter-rouge">crud</code> user,
otherwise <code class="highlighter-rouge">curd</code> will be denied access to the table.
If you don’t want to login as <code class="highlighter-rouge">curd</code> you may create
table from superuser account and then grant permissions
to <code class="highlighter-rouge">curd</code> user:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">grant</span> <span class="k">all</span> <span class="k">on</span> <span class="k">table</span> <span class="n">app_data</span> <span class="k">to</span> <span class="n">crud</span>

<span class="c1">-- needed to autogenerate primary key</span>
<span class="k">grant</span> <span class="k">all</span> <span class="k">on</span> <span class="n">sequence</span> <span class="n">app_data_id_seq</span> <span class="k">to</span> <span class="n">crud</span></code></pre></figure>

<h4 id="setup-application">Setup application</h4>

<p>I assume that you already have Maven installed because
we are going to use it to create our CRUD application:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ mvn archetype:generate \
  -DgroupId="io.mc.crudapp" \
  -DartifactId=crudapp \
  -Dversion=1.0 \
  -DarchetypeArtifactId=maven-archetype-quickstart \
  -DinteractiveMode=false

$ tree crudapp/
crudapp
|-- pom.xml
`-- src
    |-- main
    |   `-- java
    |       `-- io
    |           `-- mc
    |               `-- crudapp
    |                   `-- App.java
    `-- test
        `-- java
            `-- io
                `-- mc
                    `-- crudapp
                        `-- AppTest.java

11 directories, 3 files</code></pre></figure>

<p>NOTE: Try to use <code class="highlighter-rouge">archetype:create</code> instead of <code class="highlighter-rouge">archetype:generate</code> if you
get an error using above command</p>

<p>Now we may load our application into our favorite IDE or just stick
to command line.</p>

<p>Since we will be using Spring and Postgres JDBC driver we need to
add them as a dependencies to our POM. We also want to use connection
pooling (database connections are expensive to create so we want to
reuse them whenever possible) so we will add a dependency on 
HikariCP library:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- pom.xml --&gt;</span>
<span class="nt">&lt;dependencies&gt;</span>
   <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>4.3.5.RELEASE<span class="nt">&lt;/version&gt;</span>
   <span class="nt">&lt;/dependency&gt;</span>
   <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-jdbc<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>4.3.5.RELEASE<span class="nt">&lt;/version&gt;</span>
   <span class="nt">&lt;/dependency&gt;</span>

   <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.postgresql<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>9.4-1200-jdbc41<span class="nt">&lt;/version&gt;</span>
   <span class="nt">&lt;/dependency&gt;</span>

   <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>com.zaxxer<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>HikariCP<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.5.1<span class="nt">&lt;/version&gt;</span>
   <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span></code></pre></figure>

<p>We should also change to using Java 8
so we may use lambdas and all cool stuff, we do this
by adding to our POM:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;properties&gt;</span>
   <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
   <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
   <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
<span class="nt">&lt;/properties&gt;</span></code></pre></figure>

<p>And finally we will use <code class="highlighter-rouge">exec-maven-plugin</code> 
to strightforward running our application from
command line:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;build&gt;</span>
  <span class="nt">&lt;plugins&gt;</span>
    <span class="nt">&lt;plugin&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>exec-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>1.5.0<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;executions&gt;</span>
        <span class="nt">&lt;execution&gt;</span>
          <span class="nt">&lt;goals&gt;</span>
            <span class="nt">&lt;goal&gt;</span>java<span class="nt">&lt;/goal&gt;</span>
          <span class="nt">&lt;/goals&gt;</span>
        <span class="nt">&lt;/execution&gt;</span>
      <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;mainClass&gt;</span>io.mc.crudapp.Main<span class="nt">&lt;/mainClass&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span></code></pre></figure>

<p>NOTE: You may find complete <code class="highlighter-rouge">pom.xml</code> in attached source code</p>

<p>You may write</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ mvn clean install</code></pre></figure>

<p>to rebuild CURD application and</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">$ mvn exec:java</code></pre></figure>

<p>to start it.</p>

<h4 id="setup-spring">Setup Spring</h4>

<p>Add following code to the <code class="highlighter-rouge">main</code> method:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ClassPathXmlApplicationContext</span> <span class="n">appContext</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nf">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span>
                        <span class="s">"spring/app-context.xml"</span>
                <span class="o">});</span>

        <span class="c1">// We can use Spring context here</span>

        <span class="n">appContext</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>We must also create <code class="highlighter-rouge">resource/spring/app-context.xml</code> file:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> 
  <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
  <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
  <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans     http://www.springframework.org/schema/beans/spring-beans-3.0.xsd     http://www.springframework.org/schema/context     http://www.springframework.org/schema/context/spring-context-3.0.xsd"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;context:annotation-config</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/beans&gt;</span></code></pre></figure>

<p>After these two steps we should have working Spring application.
Right now no beans are registered in Spring container, this will
change in the next section.</p>

<h4 id="setup-spring-jdbc-data-source">Setup Spring JDBC Data source</h4>

<p>To enable Spring to access database
we must define data source in <code class="highlighter-rouge">app-context.xml</code>:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- Without pooling: --&gt;</span>
<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span>
    <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"org.postgresql.Driver"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"jdbc:postgresql://localhost:5432/cruddb"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"crud"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"crud"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span></code></pre></figure>

<p><code class="highlighter-rouge">DriverManagerDataSource</code> class is provided by Spring as one
of several implementations of <code class="highlighter-rouge">DataSource</code> interface.
<code class="highlighter-rouge">DriverManagerDataSource</code> returns a new connection to database
every time application asks for a connection.
Connection is created using specified JDBC driver.
<code class="highlighter-rouge">SingleConnectionDataSource</code> is another DataSource implementation
provided by Spring
that returns always the
same connection (having single connection 
has serious implications in multithreaded
apps - when two threads want to
access database concurrently one of them must wait).</p>

<p>Now we may use <code class="highlighter-rouge">dataSource</code> bean to insert row into <code class="highlighter-rouge">app_data</code> table:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">final</span> <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into app_data(index,value) values(?,?)"</span><span class="o">;</span>

<span class="n">DataSource</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">DataSource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="k">try</span> <span class="o">(</span><span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
    <span class="n">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span>
         <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">Statement</span><span class="o">.</span><span class="na">RETURN_GENERATED_KEYS</span><span class="o">))</span> <span class="o">{</span>

       <span class="n">stmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">101</span><span class="o">);</span>
       <span class="n">stmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">);</span>

       <span class="n">stmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>

       <span class="c1">// retrieve id of inserted row</span>
       <span class="k">try</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">getGeneratedKeys</span><span class="o">())</span> <span class="o">{</span>
           <span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
           <span class="n">Long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
           <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"id: "</span> <span class="o">+</span> <span class="n">id</span><span class="o">);</span>
       <span class="o">}</span>
<span class="o">}</span>
<span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<h4 id="writing-simple-dao">Writing simple DAO</h4>

<p>It is always a good idea to isolate data access code into
a separate component, in our case we will create <code class="highlighter-rouge">AppDataDAO</code> bean that
will be responsible for CURD operations on <code class="highlighter-rouge">app_data</code> table.</p>

<p>To make passing and retrieving data via <code class="highlighter-rouge">AppDataDAO</code> easier we will define
<code class="highlighter-rouge">AppData</code> class that will represent a single row from <code class="highlighter-rouge">app_data</code> table:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AppData</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">AppData</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getIndex</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">index</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>It is a good practice to program to interface, so
instead of creating a single bean <code class="highlighter-rouge">AppDataDAO</code> we will create
<code class="highlighter-rouge">AppDataDAO</code> interface and then provide an implementation:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AppDataDAO</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">);</span>
    <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newIndex</span><span class="o">,</span> <span class="n">String</span> <span class="n">newValue</span><span class="o">);</span>
    <span class="kt">boolean</span> <span class="nf">delete</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">AppData</span><span class="o">&gt;</span> <span class="nf">selectAll</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>Finally we may create <code class="highlighter-rouge">JDBCAppDataDAO</code> class that will implement <code class="highlighter-rouge">AppDataDAO</code>
interface:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">JDBCAppDataDAO</span> <span class="kd">implements</span> <span class="n">AppDataDAO</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">DataSource</span> <span class="n">ds</span><span class="o">;</span>
    
    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">JDBCAppDataDAO</span><span class="o">(</span><span class="n">DataSource</span> <span class="n">ds</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ds</span> <span class="o">=</span> <span class="n">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">ds</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">interface</span> <span class="nc">ConnectionConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="n">T</span> <span class="nf">consume</span><span class="o">(</span><span class="n">Connection</span> <span class="n">conn</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">usingConnection</span><span class="o">(</span><span class="n">ConnectionConsumer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">DataSourceUtils</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">ds</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">consumer</span><span class="o">.</span><span class="na">consume</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">finally</span> <span class="o">{</span>
            <span class="n">DataSourceUtils</span><span class="o">.</span><span class="na">releaseConnection</span><span class="o">(</span><span class="n">connection</span><span class="o">,</span> <span class="n">ds</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">insert</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">usingConnection</span><span class="o">(</span><span class="n">conn</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"insert into app_data(index,value) values(?,?)"</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">(</span><span class="n">PreparedStatement</span> <span class="n">stmt</span> <span class="o">=</span>
                    <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">PreparedStatement</span><span class="o">.</span><span class="na">RETURN_GENERATED_KEYS</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">stmt</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">index</span><span class="o">);</span>
                <span class="n">stmt</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>

                <span class="n">stmt</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>

                <span class="k">try</span><span class="o">(</span><span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="na">getGeneratedKeys</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">else</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"no generated key!"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span></code></pre></figure>

<p>A few things to notice: logic responsible for acquiring and releasing
a db connection was encapsulated in <code class="highlighter-rouge">usingConnection</code> method.
Instead of getting connection straight from <code class="highlighter-rouge">DataSource</code> we use
<code class="highlighter-rouge">DataSourceUtils</code> class to get and release connection. This become important
when we later start using transactions, because transactions are
attached to connections we will no longer be responsible for creating
and closing connection - a transaction manager will do that for
us. When <code class="highlighter-rouge">DataSourceUtils</code> is asked for a new connection it first checks
if any transaction is running and if it is it returns connection used
by that transaction. If no transaction is active 
a new connection is created.</p>

<p>The last thing that we must do is to register our bean in Spring container:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"> <span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">"AppDataDAO"</span>
     <span class="na">class=</span><span class="s">"io.mc.crudapp.JDBCAppDataDAO"</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>and use it to insert a row:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">AppDataDAO</span> <span class="n">appDataDAO</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">AppDataDAO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">appDataDAO</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">);</span></code></pre></figure>

<h4 id="using-hikaricp">Using HikariCP</h4>

<p>Opening a new connection to database is expensive operation.
Instead of constantly opening and closing connections we should
reuse them whenever possible. Because manually managing and resetting
connections
(before we can reuse connection we must reset it state - this will
for example clear any pending errors on connection) is error-prone
it is wise to use one of many connection pool libraries.
Here we will use HikariCP library (CP stands for Connection Pool).</p>

<p>Let’s start by creating HikariCP configuration file <code class="highlighter-rouge">resources/db/hikari.properties</code>:</p>

<figure class="highlight"><pre><code class="language-no-highlight" data-lang="no-highlight">dataSourceClassName=org.postgresql.ds.PGSimpleDataSource
dataSource.user=crud
dataSource.password=crud
dataSource.databaseName=cruddb
dataSource.portNumber=5432
dataSource.serverName=localhost</code></pre></figure>

<p>Then we must change our <code class="highlighter-rouge">dataSource</code> bean definition to:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"dataSource"</span>
    <span class="na">class=</span><span class="s">"com.zaxxer.hikari.HikariDataSource"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;constructor-arg&gt;</span>
      <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"com.zaxxer.hikari.HikariConfig"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">"/db/hikari.properties"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/bean&gt;</span>
  <span class="nt">&lt;/constructor-arg&gt;</span>
<span class="nt">&lt;/bean&gt;</span></code></pre></figure>

<p>That’s all - now our application draws connections from connection pool!</p>

<h4 id="adding-transactions-to-crud-app">Adding transactions to CRUD app</h4>

<p>Let’s clear <code class="highlighter-rouge">app_data</code> table:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">truncate</span> <span class="k">table</span> <span class="n">app_data</span><span class="p">;</span></code></pre></figure>

<p>and exeucte the following code in <code class="highlighter-rouge">main</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">AppDataDAO</span> <span class="n">appDataDAO</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">AppDataDAO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">appDataDAO</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">);</span>
<span class="n">someOperation</span><span class="o">();</span>
<span class="n">appDataDAO</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">);</span>

<span class="c1">// given:</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">someOperation</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"uber error"</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

<p>Of course running this program results in error and only one row
is inserted to database:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">app_data</span> </code></pre></figure>

<p><img src="assets/images/2017-01-07/select_result.png" alt="select query result" /></p>

<p>In real life application we often want to perform either all of
database operations or none of them. In our example this will mean that
we either want to insert both rows to db or none of them should be inserted.
Transactions can solve these problem for us. Transactions also offers
some level of isolation between database operations performed by
different users - but this topic is
beyond this simple tutorial.
For more information please <a href="https://en.wikipedia.org/wiki/Isolation_(database_systems)">check Wikipedia</a>.</p>

<p>Transactions are usually handled at application service level, we will
follow this pattern. As usually we will start by creating
<code class="highlighter-rouge">CRUDAppDemoService</code> interface:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CRUDAppDemoService</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">doDemo</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

<p>Then we may write implementation of <code class="highlighter-rouge">CRUDAppDemoService</code>:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CRUDAppDemoServiceImpl</span> <span class="kd">implements</span> <span class="n">CRUDAppDemoService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TransactionTemplate</span> <span class="n">txTemplate</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AppDataDAO</span> <span class="n">appDataDAO</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">CRUDAppDemoServiceImpl</span><span class="o">(</span>
      <span class="n">TransactionTemplate</span> <span class="n">txTemplate</span><span class="o">,</span> <span class="n">AppDataDAO</span> <span class="n">appDataDAO</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">txTemplate</span> <span class="o">=</span> <span class="n">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">txTemplate</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">appDataDAO</span> <span class="o">=</span> <span class="n">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">appDataDAO</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doDemo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">txTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">ts</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">appDataDAO</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">);</span>
            <span class="n">someOperation</span><span class="o">();</span>
            <span class="n">appDataDAO</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">);</span> 

            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">someOperation</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"uber error"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>To define boundaries of transaction we use Spring provided
<code class="highlighter-rouge">TransactionTemplate</code> class. All database operations executed
in callback passed to <code class="highlighter-rouge">execute</code> method
will be performed within transaction. In callback we have access
to <code class="highlighter-rouge">ts</code> parameter that allows us to manually rollback current transaction.</p>

<p>When we throw runtime exception from callback, transaction will be
rolled back automatically. This behaviour doesn’t occur for
checked exceptions, if we want to rollback transaction in that case
we must catch exception manually and then invoke <code class="highlighter-rouge">ts.setRollbackOnly()</code>.</p>

<p>Before we can run this code we need to register <code class="highlighter-rouge">TransactionTemplate</code> and
<code class="highlighter-rouge">TransactionManager</code> in Spring container:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">"transactionManager"</span>
    <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"TransactionTemplate"</span>
    <span class="na">class=</span><span class="s">"org.springframework.transaction.support.TransactionTemplate"</span>
    <span class="nt">&gt;</span>
  <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionManager"</span> <span class="na">ref=</span><span class="s">"transactionManager"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;bean</span> <span class="na">name=</span><span class="s">"CRUDAppDemoService"</span>
    <span class="na">class=</span><span class="s">"io.mc.crudapp.CRUDAppDemoServiceImpl"</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>Finally we may add to the <code class="highlighter-rouge">main</code> method:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">CRUDAppDemoService</span> <span class="n">service</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">CRUDAppDemoService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
<span class="n">service</span><span class="o">.</span><span class="na">doDemo</span><span class="o">();</span></code></pre></figure>

<p>Again running our program results in error but this time neither of rows
is inserted in <code class="highlighter-rouge">app_data</code> table.
When we comment out call to <code class="highlighter-rouge">someOperation()</code> both rows
are inserted - just as we wanted.</p>

<h4 id="annotation-driven-transactions">Annotation driven transactions</h4>

<p>Using <code class="highlighter-rouge">TransactionManager</code> is cumbersome so Spring provides a better
alternative, we may declare transaction boundaries using annotations.
Let’s change our <code class="highlighter-rouge">CRUDAppDemoServiceImpl</code> class to:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CRUDAppDemoServiceImpl</span> <span class="kd">implements</span> <span class="n">CRUDAppDemoService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">AppDataDAO</span> <span class="n">appDataDAO</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="nf">CRUDAppDemoServiceImpl</span><span class="o">(</span><span class="n">AppDataDAO</span> <span class="n">appDataDAO</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">appDataDAO</span> <span class="o">=</span> <span class="n">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">appDataDAO</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doDemo</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">appDataDAO</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span> <span class="s">"foo"</span><span class="o">);</span>
        <span class="n">someOperation</span><span class="o">();</span>
        <span class="n">appDataDAO</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="mi">102</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">someOperation</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"uber error"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>We may see that <code class="highlighter-rouge">TransactionTemplate</code> is gone, and a new annotation
appeared on <code class="highlighter-rouge">doDemo()</code> method. <code class="highlighter-rouge">@Transactional</code> means that we
want to start transaction when we call this method and commit it
when we return from it. As with <code class="highlighter-rouge">TransactionTemplate</code> if method
trows <code class="highlighter-rouge">RuntimeException</code> transaction will be rolled back.
To <code class="highlighter-rouge">@Transactional</code> we pass a single parameter <code class="highlighter-rouge">Propagation.REQUIRED</code>
that means that we want Spring to use existing transaction if one
is currently active or start a new one otherwise.
If Spring will use already active transaction,
then transaction will be committed or rolled
back not at our method level but at method that started it.
<code class="highlighter-rouge">@Transactional</code> has
plenty of options you may want to consult official documentation to
see them all.</p>

<p>To make <code class="highlighter-rouge">@Transactional</code> work we also need to enable it in Spring
configuration file. First we must add <code class="highlighter-rouge">tx</code> namespace to Spring XML:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
    http://www.springframework.org/schema/context
    http://www.springframework.org/schema/context/spring-context-3.0.xsd
    http://www.springframework.org/schema/tx
    http://www.springframework.org/schema/tx/spring-tx-2.0.xsd"</span><span class="nt">&gt;</span></code></pre></figure>

<p>And then we must enable annotation driven transactions:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>That’s it! Now we can use transactions without using <code class="highlighter-rouge">TransactionTemplate</code>.</p>

<h4 id="source-code">Source code</h4>

<p><a href="assets/data/2017-01-07/crudest_crud.zip">DOWNLOAD SOURCE CODE</a></p>



        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/mc" style="background-image: url(/assets/images/mc.png)"><span class="hidden">mc's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/mc">Marcin Chwedczuk</a></h4>

                        
                            <p> A programmer, a geek, a human</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Warsaw, Poland</span>
                            <span class="author-link icon-link"><a href="http://marcinchwedczuk.pl"> http://marcinchwedczuk.pl</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=Crudest CRUD using Spring&amp;url=http://localhost:4000crudest-curd-using-spring"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000crudest-curd-using-spring"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=http://localhost:4000crudest-curd-using-spring"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                    </section>
                
            

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'marcinchwedczukgithubio'; // required: replace example with your forum shortname
        var disqus_identifier = '/crudest-curd-using-spring';
        var disqus_url = 'http://localhost:4000/crudest-curd-using-spring';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/mc_cover9.jpeg)" href="/spring-transactional-cheat-sheet">
            <section class="post">
                <h2>Spring @Transactional cheat sheet</h2>
                <p>#### @Transactional(propagation=...) `MANDATORY` : Method must run within transaction. If there is no currently active...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/mc_cover2.jpg)" href="/generics-in-java">
            <section class="post">
                <h2>Generics in Java</h2>
                <p>Generics were introduced with Java 6 and quickly become indispensable tool of every Java programmer....</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Programming is Magic</a> &copy; 2020</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-82096342-1', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
